<!DOCTYPE html>
<html lang="en">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="Tomcat配置文件详解" />
    <meta name="hexo-theme-A4" content="v1.9.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Dengpangpang</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Dengpangpang</a> 
            <span class="description"></span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">🍟首页</a></li>
            
        
            
                <li><a href="/list/">📝文章</a></li>
            
        
            
                <li><a href="/tags/">🏷️标签</a></li>
            
        
            
                <li><a href="/categories/">🗂️分类</a></li>
            
        
            
                <li><a href="/about/">👁️关于</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            Tomcat配置文件详解
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="post-toc-text">核心组件</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%AF%A6%E7%BB%86%E4%BB%8B%E7%BB%8D"><span class="post-toc-text">详细介绍</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Server"><span class="post-toc-text">Server</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Service"><span class="post-toc-text">Service</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Connector"><span class="post-toc-text">Connector</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Engine"><span class="post-toc-text">Engine</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Host"><span class="post-toc-text">Host</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Context"><span class="post-toc-text">Context</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="post-toc-text">自动部署</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Host%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="post-toc-text">Host的配置</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E4%B8%8BContext%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="post-toc-text">自动部署下Context的配置</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%9D%99%E6%80%81%E9%83%A8%E7%BD%B2%E4%B8%8BContext%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="post-toc-text">静态部署下Context的配置</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%AF%B7%E6%B1%82%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="post-toc-text">请求的处理流程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="post-toc-text">如何配置多个服务</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%85%B6%E4%BB%96%E7%BB%84%E4%BB%B6"><span class="post-toc-text">其他组件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Listener"><span class="post-toc-text">Listener</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#GlobalNamingResources%E4%B8%8ERealm"><span class="post-toc-text">GlobalNamingResources与Realm</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Valve"><span class="post-toc-text">Valve</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="post-toc-text">参考文献</span></a></li></ol>
            
        
        <link rel="stylesheet" type="text/css" href="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/css/lightgallery.min.css" /><div class=".article-gallery"><p>Tomcat隶属于Apache基金会，是开源的轻量级Web应用服务器，使用非常广泛。server.xml是Tomcat中最重要的配置文件，<strong>server.xml</strong>的每一个元素都对应了Tomcat中的一个组件；通过对xml文件中元素的配置，可以实现对Tomcat中各个组件的控制。因此，学习server.xml文件的配置，对于了解和使用Tomcat至关重要。</p>
<p>本文将通过实例，介绍server.xml中各个组件的配置，并详细说明Tomcat各个核心组件的作用以及各个组件之间的相互关系。</p>
<p>说明：由于server.xml文件中元素与Tomcat中组件的对应关系，后文中为了描述方便，“元素”和“组件”的使用不严格区分。</p>
<h2 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h2><blockquote>
<p><strong>整体结构</strong></p>
</blockquote>
<p><code>server.xml</code>的整体结构如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1 <span class="tag">&lt;<span class="name">Server</span>&gt;</span>  <span class="comment">&lt;!-- Server元素是整个配置文件的根元素 --&gt;</span></span><br><span class="line">2     <span class="tag">&lt;<span class="name">Service</span>&gt;</span>  <span class="comment">&lt;!-- Service元素代表一个Engine元素以及一组与之相连的Connector元素 --&gt;</span></span><br><span class="line">3         <span class="tag">&lt;<span class="name">Connector</span> /&gt;</span>  <span class="comment">&lt;!-- Connector代表客户端发送请求到特定Service的接口；同时也是客户端从特定Service接收响应的接口 --&gt;</span></span><br><span class="line">4         <span class="tag">&lt;<span class="name">Connector</span> /&gt;</span></span><br><span class="line">5         <span class="tag">&lt;<span class="name">Engine</span>&gt;</span>  <span class="comment">&lt;!-- 一个Engine组件可以处理Service中的所有请求 --&gt;</span></span><br><span class="line">6             <span class="tag">&lt;<span class="name">Host</span>&gt;</span>  <span class="comment">&lt;!-- 一个Host组件可以处理发向一个特定虚拟主机的所有请求 --&gt;</span></span><br><span class="line">7                 <span class="tag">&lt;<span class="name">Context</span> /&gt;</span>  <span class="comment">&lt;!-- 一个Context组件可以处理一个特定Web应用的所有请求 --&gt;</span></span><br><span class="line">8			       <span class="tag">&lt;<span class="name">Context</span> /&gt;</span>  <span class="comment">&lt;!-- 现在常常使用自动部署，不推荐配置Context元素，Context小节有详细说明 --&gt;</span></span><br><span class="line">9             <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">10         <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">11     <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line">12 <span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>该结构中只给出了Tomcat的核心组件，除了核心组件外，Tomcat还有一些其他组件。</p>
<blockquote>
<p><strong>配置实例</strong></p>
</blockquote>
<p><code>server.xml</code>位于<code>$TOMCAT_HOME/conf</code>目录下；下面是一个<code>server.xml</code>实例。后文中将结合该实例讲解<code>server.xml</code>中，各个元素的含义和作用；在阅读后续章节过程中，可以对照该xml文档便于理解。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> 1 <span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line"> 2   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;</span></span><br><span class="line"> 3   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> <span class="attr">SSLEngine</span>=<span class="string">&quot;on&quot;</span> /&gt;</span></span><br><span class="line"> 4   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JasperListener&quot;</span> /&gt;</span></span><br><span class="line"> 5   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line"> 6   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span></span><br><span class="line"> 7   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line"> 8 </span><br><span class="line"> 9   <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">10     <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">&quot;UserDatabase&quot;</span> <span class="attr">auth</span>=<span class="string">&quot;Container&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">11</span>               <span class="attr">type</span>=<span class="string">&quot;org.apache.catalina.UserDatabase&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">12</span>               <span class="attr">description</span>=<span class="string">&quot;User database that can be updated and saved&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">13</span>               <span class="attr">factory</span>=<span class="string">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">14</span>               <span class="attr">pathname</span>=<span class="string">&quot;conf/tomcat-users.xml&quot;</span> /&gt;</span></span><br><span class="line">15   <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">16  </span><br><span class="line">17   <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">18     <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">19</span>                <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">20</span>                <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">21     <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">22     <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">23       <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span></span><br><span class="line">24         <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">25</span>                <span class="attr">resourceName</span>=<span class="string">&quot;UserDatabase&quot;</span>/&gt;</span></span><br><span class="line">26       <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">27  </span><br><span class="line">28       <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">29</span>             <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">30         <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">31</span>                <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log.&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">32</span>                <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class="line">33       <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">34     <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">35   <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line">36 <span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="详细介绍"><a href="#详细介绍" class="headerlink" title="详细介绍"></a>详细介绍</h2><p>本部分将分别介绍各个核心组件的作用、特点以及配置方式等。</p>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><p><code>Server</code>元素在最顶层，代表整个Tomcat容器，因此它必须是server.xml中唯一一个最外层的元素。</p>
<p>在第一部分的例子中，在最外层有一个<code>&lt;Server&gt;</code>元素，shutdown属性表示关闭<code>Server</code>的指令；port属性表示<code>Server</code>接收shutdown指令的端口号，设为<code>-1</code>可以禁掉该端口。</p>
<p><code>Server</code>的主要任务，就是提供一个接口让客户端能够访问到这个<code>Service</code>集合，同时维护它所包含的所有的<code>Service</code>的声明周期，包括如何初始化、如何结束服务、如何找到客户端要访问的<code>Service</code>。</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>在第一部分的例子中，<code>Server</code>中包含一个名称为“Catalina”的<code>Service</code>，它的作用是在<code>Connector</code>和<code>Engine</code>外面包了一层，把它们组装在一起，对外提供服务。</p>
<p><strong>一个<code>Server</code>元素中可以有一个或多个<code>Service</code>元素，不同的<code>Service</code>监听不同的端口。</strong></p>
<p><strong>一个<code>Service</code>元素可以包含一个或多个<code>Connector</code>，但是只能包含一个<code>Engine</code>元素</strong>。</p>
<p>其中<code>Connector</code>的作用是从客户端接收请求，<code>Engine</code>的作用是处理接收进来的请求。</p>
<h3 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h3><p><code>Connector</code>主要功能，是接收连接请求，创建Request和Response对象用于和请求端交换数据；然后分配线程让<code>Engine</code>来处理这个请求，并把产生的Request和Response对象传给<code>Engine</code>。</p>
<p>通过配置<code>Connector</code>，可以控制请求<code>Service</code>的协议及端口号。在第一部分的例子中，<code>Service</code>包含两个<code>Connector</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">2 <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>（1）通过配置第1个Connector，客户端可以通过8080端口号使用http协议访问Tomcat。其中，protocol属性规定了请求的协议，port规定了请求的端口号，redirectPort表示当强制要求https而请求是http时，重定向至端口号为8443的Connector，connectionTimeout表示连接的超时时间。</p>
<p>在这个例子中，Tomcat监听HTTP请求，使用的是8080端口，而不是正式的80端口；实际上，在正式的生产环境中，Tomcat也常常监听8080端口，而不是80端口。这是因为在生产环境中，很少将Tomcat直接对外开放接收请求，而是在Tomcat和客户端之间加一层代理服务器(如nginx)，用于请求的转发、负载均衡、处理静态文件等；通过代理服务器访问Tomcat时，是在局域网中，因此一般仍使用8080端口。</p>
<p>（2）通过配置第2个Connector，客户端可以通过8009端口号使用AJP协议访问Tomcat。AJP协议负责和其他的HTTP服务器(如Apache)建立连接；在把Tomcat与其他HTTP服务器集成时，就需要用到这个连接器。之所以使用Tomcat和其他服务器集成，是因为Tomcat可以用作Servlet&#x2F;JSP容器，但是对静态资源的处理速度较慢，不如Apache和IIS等HTTP服务器；因此常常将Tomcat与Apache等集成，前者作Servlet容器，后者处理静态资源，而AJP协议便负责Tomcat和Apache的连接。Tomcat与Apache等集成的原理如下图：</p>
<p><a href="/../pic/1174710-20170804092103272-2042915115.png" title="img" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/1174710-20170804092103272-2042915115.png" alt="img"></a></p>
<p>关于Connector的更多内容，可以参考另一篇文章：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/kismetv/p/7806063.html">详解tomcat的连接数与线程池</a></p>
<h3 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h3><p><code>Engine</code>组件在<code>Service</code>组件中有且只有一个，是Service组件中的请求处理组件。<code>Engine</code>组件从一个或多个<code>Connector</code>中接收请求并处理，并将完成的响应返回给<code>Connector</code>，最终传递给客户端。</p>
<p><code>Engine</code>、<code>Host</code>和<code>Context</code>都是容器，但它们不是平行的关系，而是父子关系：<code>Engine</code>包含<code>Host</code>，<code>Host</code>包含<code>Context</code>。</p>
<p>在第一部分的例子中，Engine的配置语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>其中，name属性用于日志和错误信息，在整个<code>Server</code>中应该唯一。defaultHost属性指定了默认的host名称，当发往本机的请求指定的host名称不存在时，一律使用defaultHost指定的host进行处理；因此，defaultHost的值，必须与<code>Engine</code>中的一个Host组件的name属性值匹配。</p>
<h3 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h3><blockquote>
<p><strong>Engine与Host</strong></p>
</blockquote>
<p><strong>Engine组件中可以内嵌1个或多个Host组件，每个Host组件代表Engine中的一个虚拟主机</strong>。</p>
<p>Host是Engine的子容器。Host组件至少有一个，且其中一个的name必须与Engine组件的defaultHost属性相匹配。</p>
<blockquote>
<p><strong>Host的作用</strong></p>
</blockquote>
<p>Host虚拟主机的作用，是运行多个Web应用（一个Context代表一个Web应用），并负责安装、展开、启动和结束每个Web应用。</p>
<p>Host组件代表的虚拟主机，对应了服务器中一个网络名实体(如”<a target="_blank" rel="noopener" href="http://www.test.com”,或ip地址”116.25.25.25”);为了使用户可以通过网络名连接tomcat服务器,这个名字应该在dns服务器上注册./">www.test.com”，或IP地址”116.25.25.25”)；为了使用户可以通过网络名连接Tomcat服务器，这个名字应该在DNS服务器上注册。</a></p>
<p>客户端通常使用主机名来标识它们希望连接的服务器；该主机名也会包含在HTTP请求头中。Tomcat从HTTP头中提取出主机名，寻找名称匹配的主机。如果没有匹配，请求将发送至默认主机。因此默认主机不需要是在DNS服务器中注册的网络名，因为任何与所有Host名称不匹配的请求，都会路由至默认主机。</p>
<blockquote>
<p><strong>Host的配置</strong></p>
</blockquote>
<p>在第一部分的例子中，Host的配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;Host name=&quot;localhost&quot; appBase=&quot;webapps&quot; unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>下面对其中配置的属性进行说明：</p>
<p>name属性指定虚拟主机的主机名，一个Engine中有且仅有一个Host组件的name属性与Engine组件的defaultHost属性相匹配；一般情况下，主机名需要是在DNS服务器中注册的网络名，但是Engine指定的defaultHost不需要，原因在前面已经说明。</p>
<p>unpackWARs指定了是否将代表Web应用的WAR文件解压；如果为true，通过解压后的文件结构运行该Web应用，如果为false，直接使用WAR文件运行Web应用。</p>
<p>Host的autoDeploy和appBase属性，与Host内Web应用的自动部署有关；此外，本例中没有出现的xmlBase和deployOnStartup属性，也与Web应用的自动部署有关；将在下一节(Context)中介绍。</p>
<h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>Context元素代表在特定虚拟主机上运行的一个Web应用。在后文中，提到Context、应用或Web应用，它们指代的都是Web应用。每个Web应用基于WAR文件，或WAR文件解压后对应的目录（这里称为应用目录）。</p>
<p>Context是Host的子容器，每个Host中可以定义任意多的Context元素。</p>
<p>在第一部分的例子中，可以看到server.xml配置文件中并没有出现Context元素的配置。这是因为，Tomcat开启了自动部署，Web应用没有在server.xml中配置静态部署，而是由Tomcat通过特定的规则自动部署。下面介绍一下Tomcat自动部署Web应用的机制。</p>
<h3 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h3><h4 id="Host的配置"><a href="#Host的配置" class="headerlink" title="Host的配置"></a>Host的配置</h4><p>要开启Web应用的自动部署，需要配置所在的虚拟主机；配置的方式就是前面提到的Host元素的<code>deployOnStartup</code>和<code>autoDeploy</code>属性。如果<code>deployOnStartup</code>和<code>autoDeploy</code>设置为true，则tomcat启动自动部署：当检测到新的Web应用或Web应用的更新时，会触发应用的部署(或重新部署)。</p>
<p>二者的主要区别在于：</p>
<ul>
<li><p><code>deployOnStartup</code>为true时，Tomcat在启动时检查Web应用，且检测到的所有Web应用视作新应用；</p>
</li>
<li><p><code>autoDeploy</code>为true时，Tomcat在运行时定期检查新的Web应用或Web应用的更新。除此之外，二者的处理相似。</p>
</li>
</ul>
<p>通过配置<code>deployOnStartup</code>和<code>autoDeploy</code>可以开启虚拟主机自动部署Web应用；实际上，自动部署依赖于检查是否有新的或更改过的Web应用，而Host元素的<code>appBase</code>和<code>xmlBase</code>设置了检查Web应用更新的目录。</p>
<ul>
<li><p><code>appBase</code>属性指定Web应用所在的目录，默认值是webapps，这是一个相对路径，代表Tomcat根目录下webapps文件夹。</p>
</li>
<li><p><code>xmlBase</code>属性指定Web应用的XML配置文件所在的目录，默认值为<code>conf/&lt;engine_name&gt;/&lt;host_name&gt;</code></p>
<p>例如第一部分的例子中，主机localhost的xmlBase的默认值是<code>$TOMCAT_HOME/conf/Catalina/localhost</code>。</p>
</li>
</ul>
<p>如何检查Web应用更新？</p>
<p>一个Web应用可能包括以下文件：XML配置文件，WAR包，以及一个应用目录(该目录包含Web应用的文件结构)；其中XML配置文件位于xmlBase指定的目录，WAR包和应用目录位于appBase指定的目录。</p>
<p>Tomcat按照如下的顺序进行扫描，来检查应用更新：</p>
<p>A、扫描虚拟主机指定的xmlBase下的XML配置文件</p>
<p>B、扫描虚拟主机指定的appBase下的WAR文件</p>
<p>C、扫描虚拟主机指定的appBase下的应用目录</p>
<h4 id="自动部署下Context的配置"><a href="#自动部署下Context的配置" class="headerlink" title="自动部署下Context的配置"></a>自动部署下Context的配置</h4><p>Context元素最重要的属性是docBase和path，此外reloadable属性也比较常用。</p>
<ul>
<li><p>docBase指定了该Web应用使用的WAR包路径或应用目录。</p>
<p>需要注意的是，在自动部署场景下，如果docBase指定的WAR包或应用目录就在appBase中，则不需要指定docBase，因为Tomcat会自动扫描appBase中的WAR包和应用目录，指定了反而会造成问题。</p>
</li>
<li><p>path指定了访问该Web应用的上下文路径，当请求到来时，Tomcat根据Web应用的 path属性与URI的匹配程度来选择Web应用处理相应请求。</p>
<p>例如Web应用app1的path属性是”&#x2F;app1”，Web应用app2的path属性是”&#x2F;app2”，那么请求&#x2F;app1&#x2F;index.html会交由app1来处理；而请求&#x2F;app2&#x2F;index.html会交由app2来处理。如果一个Context元素的path属性为” ”，那么这个Context是虚拟主机的默认Web应用；当请求的uri与所有的path都不匹配时，使用该默认Web应用来处理。</p>
<p>但是，需要注意的是，在自动部署场景下，不能指定path属性，path属性由配置文件的文件名、WAR文件的文件名或应用目录的名称自动推导出来。如扫描Web应用时，发现了xmlBase目录下的app1.xml，或appBase目录下的app1.WAR或app1应用目录，则该Web应用的path属性是”app1”。如果名称不是app1而是ROOT，则该Web应用是虚拟主机默认的Web应用，此时path属性推导为” ”。</p>
</li>
<li><p>reloadable属性指示tomcat是否在运行时监控在WEB-INF&#x2F;classes和WEB-INF&#x2F;lib目录下class文件的改动。如果值为true，那么当class文件改动时，会触发Web应用的重新加载。在开发环境下，reloadable设置为true便于调试；但是在生产环境中设置为true会给服务器带来性能压力，因此reloadable参数的默认值为false。</p>
</li>
</ul>
<p>下面来看自动部署时，xmlBase下的XML配置文件app1.xml的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;Context docBase=&quot;D:\Program Files\app1.war&quot; reloadable=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>在该例子中，docBase位于Host的appBase目录之外；path属性没有指定，而是根据app1.xml自动推导为”app1”；由于是在开发环境下，因此reloadable设置为true，便于开发调试。</p>
<blockquote>
<p><strong>自动部署举例</strong></p>
</blockquote>
<p>最典型的自动部署，就是当我们安装完Tomcat后，$TOMCAT_HOME&#x2F;webapps目录下有如下文件夹：</p>
<p><a href="/../pic/1174710-20170804124947444-1841183869.png" title="img" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/1174710-20170804124947444-1841183869.png" alt="img"></a></p>
<p>当我们启动Tomcat后，可以使用 <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a> 来访问Tomcat，其实访问的就是ROOT对应的Web应用；我们也可以通过 <a target="_blank" rel="noopener" href="http://localhost:8080/docs">http://localhost:8080/docs</a> 来访问docs应用，同理我们可以访问 examples&#x2F;host-manager&#x2F;manager 这几个Web应用。</p>
<h4 id="静态部署下Context的配置"><a href="#静态部署下Context的配置" class="headerlink" title="静态部署下Context的配置"></a>静态部署下Context的配置</h4><p>除了自动部署，我们也可以在server.xml中通过context元素静态部署Web应用。静态部署与自动部署是可以共存的。在实际应用中，并不推荐使用静态部署，因为server.xml 是不可动态重加载的资源，服务器一旦启动了以后，要修改这个文件，就得重启服务器才能重新加载。而自动部署可以在Tomcat运行时通过定期的扫描来实现，不需要重启服务器。</p>
<p>server.xml中使用Context元素配置Web应用，Context元素应该位于Host元素中。举例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;Context path=&quot;/&quot; docBase=&quot;D:\Program Files \app1.war&quot; reloadable=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>docBase：静态部署时，docBase可以在appBase目录下，也可以不在；本例中，docBase不在appBase目录下。</p>
</li>
<li><p>path：静态部署时，可以显式指定path属性，但是仍然受到了严格的限制：只有当自动部署完全关闭(deployOnStartup和autoDeploy都为false)或docBase不在appBase中时，才可以设置path属性。在本例中，docBase不在appBase中，因此path属性可以设置。</p>
</li>
<li><p>reloadable属性的用法与自动部署时相同。</p>
</li>
</ul>
<h2 id="请求的处理流程"><a href="#请求的处理流程" class="headerlink" title="请求的处理流程"></a>请求的处理流程</h2><p>当请求被发送到Tomcat所在的主机时，如何确定最终哪个Web应用来处理该请求呢？</p>
<p><strong>1. 根据协议和端口选定Service</strong></p>
<p>Service中的Connector组件可以接收特定端口的请求，因此，当Tomcat启动时，Service组件就会监听特定的端口。在第一部分的例子中，Catalina这个Service监听了8080端口（基于HTTP协议）和8009端口（基于AJP协议）。当请求进来时，Tomcat便可以根据协议和端口号选定处理请求的Service；Service一旦选定，Engine也就确定。</p>
<p>通过在Server中配置多个Service，可以实现通过不同的端口号来访问同一台机器上部署的不同应用。</p>
<p><strong>2.  根据域名或IP选定Host</strong></p>
<p>Service确定后，Tomcat在Service中寻找名称与域名&#x2F;IP地址匹配的Host处理该请求。如果没有找到，则使用Engine中指定的defaultHost来处理该请求。在第一部分的例子中，由于只有一个Host（name属性为localhost），因此该Service&#x2F;Engine的所有请求都交给该Host处理。</p>
<p><strong>3. 根据URI选定Web应用</strong></p>
<p>这一点在Context一节有详细的说明：Tomcat根据应用的 path属性与URI的匹配程度来选择Web应用处理相应请求，这里不再赘述。</p>
<blockquote>
<p><strong>举例</strong></p>
</blockquote>
<p>以请求 <a target="_blank" rel="noopener" href="http://localhost:8080/app1/index.html">http://localhost:8080/app1/index.html</a> 为例，首先通过协议和端口号（http和8080）选定Service；然后通过主机名（localhost）选定Host；然后通过uri（&#x2F;app1&#x2F;index.html）选定Web应用。</p>
<h2 id="如何配置多个服务"><a href="#如何配置多个服务" class="headerlink" title="如何配置多个服务"></a>如何配置多个服务</h2><p>通过在Server中配置多个Service服务，可以实现通过不同的端口号来访问同一台机器上部署的不同Web应用。</p>
<p>在server.xml中配置多服务的方法非常简单，分为以下几步：</p>
<p>（1）复制<Service>元素，放在当前<Service>后面。</p>
<p>（2）修改端口号：根据需要监听的端口号修改<Connector>元素的port属性；必须确保该端口没有被其他进程占用，否则Tomcat启动时会报错，而无法通过该端口访问Web应用。</p>
<p>（3）修改Service和Engine的name属性</p>
<p>（4）修改Host的appBase属性（如webapps2）</p>
<p>（5）Web应用仍然使用自动部署</p>
<p>（6）将要部署的Web应用(WAR包或应用目录)拷贝到新的appBase下。</p>
<p>以第一部分的server.xml为例，多个Service的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> 1 <span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27;?&gt;</span></span><br><span class="line"> 2 <span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">&quot;8005&quot;</span> <span class="attr">shutdown</span>=<span class="string">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class="line"> 3   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;</span></span><br><span class="line"> 4   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> <span class="attr">SSLEngine</span>=<span class="string">&quot;on&quot;</span> /&gt;</span></span><br><span class="line"> 5   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JasperListener&quot;</span> /&gt;</span></span><br><span class="line"> 6   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line"> 7   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span></span><br><span class="line"> 8   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line"> 9 </span><br><span class="line">10   <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">11     <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">&quot;UserDatabase&quot;</span> <span class="attr">auth</span>=<span class="string">&quot;Container&quot;</span> <span class="attr">type</span>=<span class="string">&quot;org.apache.catalina.UserDatabase&quot;</span> <span class="attr">description</span>=<span class="string">&quot;User database that can be updated and saved&quot;</span> <span class="attr">factory</span>=<span class="string">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span> <span class="attr">pathname</span>=<span class="string">&quot;conf/tomcat-users.xml&quot;</span> /&gt;</span></span><br><span class="line">12   <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">13 </span><br><span class="line">14   <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">15     <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">16     <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8009&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">17     <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">18       <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span></span><br><span class="line">19         <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">20</span>                <span class="attr">resourceName</span>=<span class="string">&quot;UserDatabase&quot;</span>/&gt;</span></span><br><span class="line">21       <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">22 </span><br><span class="line">23       <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;/opt/project/webapps&quot;</span> <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">24         <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span> <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log.&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class="line">25       <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">26     <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">27   <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line">28 </span><br><span class="line">29   <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina2&quot;</span>&gt;</span></span><br><span class="line">30     <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8084&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span> <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">31     <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8010&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;AJP/1.3&quot;</span> <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">32     <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina2&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">33       <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span></span><br><span class="line">34         <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">35</span>                <span class="attr">resourceName</span>=<span class="string">&quot;UserDatabase&quot;</span>/&gt;</span></span><br><span class="line">36       <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">37 </span><br><span class="line">38       <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;/opt/project/webapps2&quot;</span> <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">39         <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span> <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log.&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span> <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class="line">40       <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">41     <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">42   <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line">43 <span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再将原webapps下的docs目录拷贝到webapps2中，则通过如下两个接口都可以访问docs应用：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/docs/">http://localhost:8080/docs/</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8084/docs/">http://localhost:8084/docs/</a></p>
<h2 id="其他组件"><a href="#其他组件" class="headerlink" title="其他组件"></a>其他组件</h2><p>除核心组件外，server.xml中还可以配置很多其他组件。下面只介绍第一部分例子中出现的组件，如果要了解更多内容，可以查看<a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.0-doc/config/index.html">Tomcat官方文档</a>。</p>
<h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;</span></span><br><span class="line">2   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> <span class="attr">SSLEngine</span>=<span class="string">&quot;on&quot;</span> /&gt;</span></span><br><span class="line">3   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JasperListener&quot;</span> /&gt;</span></span><br><span class="line">4   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line">5   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span></span><br><span class="line">6   <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>Listener(即监听器)定义的组件，可以在特定事件发生时执行特定的操作；被监听的事件通常是Tomcat的启动和停止。</p>
<p>监听器可以在Server、Engine、Host或Context中，本例中的监听器都是在Server中。实际上，本例中定义的6个监听器，都只能存在于Server组件中。监听器不允许内嵌其他组件。</p>
<p>监听器需要配置的最重要的属性是className，该属性规定了监听器的具体实现类，该类必须实现了org.apache.catalina.LifecycleListener接口。</p>
<p>下面依次介绍例子中配置的监听器：</p>
<ul>
<li>VersionLoggerListener：当Tomcat启动时，该监听器记录Tomcat、Java和操作系统的信息。该监听器必须是配置的第一个监听器。</li>
<li>AprLifecycleListener：Tomcat启动时，检查APR库，如果存在则加载。APR，即Apache Portable Runtime，是Apache可移植运行库，可以实现高可扩展性、高性能，以及与本地服务器技术更好的集成。</li>
<li>JasperListener：在Web应用启动之前初始化Jasper，Jasper是JSP引擎，把JVM不认识的JSP文件解析成java文件，然后编译成class文件供JVM使用。</li>
<li>JreMemoryLeakPreventionListener：与类加载器导致的内存泄露有关。</li>
<li>GlobalResourcesLifecycleListener：通过该监听器，初始化&lt; GlobalNamingResources&gt;标签中定义的全局JNDI资源；如果没有该监听器，任何全局资源都不能使用。&lt; GlobalNamingResources&gt;将在后文介绍。</li>
<li>ThreadLocalLeakPreventionListener：当Web应用因thread-local导致的内存泄露而要停止时，该监听器会触发线程池中线程的更新。当线程执行完任务被收回线程池时，活跃线程会一个一个的更新。只有当Web应用(即Context元素)的renewThreadsWhenStoppingContext属性设置为true时，该监听器才有效。</li>
</ul>
<h3 id="GlobalNamingResources与Realm"><a href="#GlobalNamingResources与Realm" class="headerlink" title="GlobalNamingResources与Realm"></a>GlobalNamingResources与Realm</h3><p>第一部分的例子中，Engine组件下定义了Realm组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1       &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</span><br><span class="line">2         &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span><br><span class="line">3                resourceName=&quot;UserDatabase&quot;/&gt;</span><br><span class="line">4       &lt;/Realm&gt;</span><br></pre></td></tr></table></figure>

<p>Realm，可以把它理解成“域”；<strong>Realm<strong><strong>提供了一种用户密码与web</strong></strong>应用的映射关系，从而达到角色安全管理的作用。</strong>在本例中，Realm的配置使用name为UserDatabase的资源实现。而该资源在Server元素中使用GlobalNamingResources配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1   &lt;GlobalNamingResources&gt;</span><br><span class="line">2     &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot; type=&quot;org.apache.catalina.UserDatabase&quot; description=&quot;User database that can be updated and saved&quot; factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot; pathname=&quot;conf/tomcat-users.xml&quot; /&gt;</span><br><span class="line">3   &lt;/GlobalNamingResources&gt;</span><br></pre></td></tr></table></figure>

<p>GlobalNamingResources元素定义了全局资源，通过配置可以看出，该配置是通过读取$TOMCAT_HOME&#x2F; conf&#x2F;tomcat-users.xml实现的。</p>
<p>关于Tomcat域管理的更多内容，可以参考：<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xing901022/p/4552843.html">Realm域管理</a></p>
<h3 id="Valve"><a href="#Valve" class="headerlink" title="Valve"></a>Valve</h3><p>在第一部分的例子中，Host元素内定义了Valve组件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot; prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot; pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>单词Valve的意思是“阀门”，在Tomcat中代表了请求处理流水线上的一个组件；Valve可以与Tomcat的容器(Engine、Host或Context)关联。</p>
<p>不同的Valve有不同的特性，下面介绍一下本例中出现的AccessLogValve。</p>
<p>AccessLogValve的作用是通过日志记录其所在的容器中处理的所有请求，在本例中，Valve放在Host下，便可以记录该Host处理的所有请求。<strong>AccessLogValve记录的日志就是访问日志，每天的请求会写到一个日志文件里。</strong>AccessLogValve可以与Engine、Host或Context关联；在本例中，只有一个Engine，Engine下只有一个Host，Host下只有一个Context，因此AccessLogValve放在三个容器下的作用其实是类似的。</p>
<p>本例的AccessLogValve属性的配置，使用的是默认的配置；下面介绍AccessLogValve中各个属性的作用：</p>
<p>（1）className：规定了Valve的类型，是最重要的属性；本例中，通过该属性规定了这是一个AccessLogValve。</p>
<p>（2）directory：指定日志存储的位置，本例中，日志存储在$TOMCAT_HOME&#x2F;logs目录下。</p>
<p>（3）prefix：指定了日志文件的前缀。</p>
<p>（4）suffix：指定了日志文件的后缀。通过directory、prefix和suffix的配置，在$TOMCAT_HOME&#x2F;logs目录下，可以看到如下所示的日志文件。</p>
<p><a href="/../pic/1174710-20170804130208678-1273060779.png" title="img" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/1174710-20170804130208678-1273060779.png" alt="img"></a></p>
<p>（5）pattern：指定记录日志的格式，本例中各项的含义如下：</p>
<ul>
<li>%h：远程主机名或IP地址；如果有nginx等反向代理服务器进行请求分发，该主机名&#x2F;IP地址代表的是nginx，否则代表的是客户端。后面远程的含义与之类似，不再解释。</li>
<li>%l：远程逻辑用户名，一律是”-”，可以忽略。</li>
<li>%u：授权的远程用户名，如果没有，则是”-”。</li>
<li>%t：访问的时间。</li>
<li>%r：请求的第一行，即请求方法(get&#x2F;post等)、uri、及协议。</li>
<li>%s：响应状态，200,404等等。</li>
<li>%b：响应的数据量，不包括请求头，如果为0，则是””-。</li>
</ul>
<p>例如，下面是访问日志中的一条记录</p>
<p><a href="/../pic/1174710-20190307235328851-496966321.png" title="img" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/1174710-20190307235328851-496966321.png" alt="img"></a></p>
<p>pattern的配置中，除了上述各项，还有一个非常常用的选项是%D，含义是请求处理的时间(单位是毫秒)，对于统计分析请求的处理速度帮助很大。</p>
<p><strong>开发人员可以充分利用访问日志，来分析问题、优化应用。</strong>例如，分析访问日志中各个接口被访问的比例，不仅可以为需求和运营人员提供数据支持，还可以使自己的优化有的放矢；分析访问日志中各个请求的响应状态码，可以知道服务器请求的成功率，并找出有问题的请求；分析访问日志中各个请求的响应时间，可以找出慢请求，并根据需要进行响应时间的优化。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.0-doc/config/index.html">Tomcat官方文档</a></p>
<p>《How Tomcat Works》</p>
<p>《深入分析Java Web技术内幕》</p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xing901022/p/4552843.html">Tomcat 6 —— Realm域管理</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.163.com/cmdbat@126/blog/static/170292123201311301419411/">Tomcat Port 8009 与AJP13协议</a></p>
<p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xing901022/p/4592159.html">使用Jasper引擎解析JSP</a></p>
<hr>
<p>原文链接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kismetv/p/7228274.html">博客园</a></p>
</div><script src="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery) {
        var options1 = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-12-13</span>
            
                <span>该篇文章被 邓胖胖</span>
            
            
                <span>打上标签:
                    
                    
                        <a href='/tags/Tomcat/'>
                            Tomcat
                        </a>
                    
                </span>
             
             
                <span>归为分类:
                    
                    
                        <a href='/categories/%E6%8B%93%E5%B1%95%E8%A7%86%E9%87%8E/'>
                            拓展视野
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>上一篇：<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">上一篇：<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
             

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- 返回的按钮-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>