<!DOCTYPE html>
<html lang="en">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="自动化监控" />
    <meta name="hexo-theme-A4" content="v1.9.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Dengpangpang</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Dengpangpang</a> 
            <span class="description"></span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">🍟首页</a></li>
            
        
            
                <li><a href="/list/">📝文章</a></li>
            
        
            
                <li><a href="/tags/">🏷️标签</a></li>
            
        
            
                <li><a href="/categories/">🗂️分类</a></li>
            
        
            
                <li><a href="/about/">👁️关于</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            自动化监控
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E5%92%8C%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C"><span class="post-toc-text">自动发现和自动注册</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="post-toc-text">自动发现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C"><span class="post-toc-text">自动注册</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%9B%91%E6%8E%A7%E5%8F%96%E5%80%BC%E7%9A%84%E4%B8%BB%E5%8A%A8%E4%B8%8E%E8%A2%AB%E5%8A%A8"><span class="post-toc-text">监控取值的主动与被动</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BD%8E%E7%BA%A7%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0"><span class="post-toc-text">低级自动发现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%86%85%E7%BD%AElld%E6%A6%82%E8%BF%B0"><span class="post-toc-text">内置lld概述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%9B%E5%BB%BAlld"><span class="post-toc-text">自定义创建lld</span></a></li></ol></li></ol>
            
        
        <link rel="stylesheet" type="text/css" href="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/css/lightgallery.min.css" /><div class=".article-gallery"><p>1</p>
<h2 id="自动发现和自动注册"><a href="#自动发现和自动注册" class="headerlink" title="自动发现和自动注册"></a>自动发现和自动注册</h2><p>自动化监控是不需要手动添加机器，自动完成机器的添加、关联模板和启用主机。自动化监控有两种策略：自动发现和自动注册。</p>
<table>
<thead>
<tr>
<th>自动化策略</th>
<th>共同点</th>
<th>区别</th>
</tr>
</thead>
<tbody><tr>
<td>自动发现</td>
<td>自动添加主机并关联模板</td>
<td>服务端主动 使用简单，效率较低 zabbix服务端压力大</td>
</tr>
<tr>
<td>自动注册</td>
<td>自动添加主机并关联模板</td>
<td>客户端主动 配置稍微繁琐，高并发效率高 zabbix服务端压力小</td>
</tr>
</tbody></table>
<p>当机器比较多的时候，如果用自动发现的策略会导致服务端压力很大，所以建议使用自动注册的策略。先使用ansible配置好客户端环境，然后在web页面配置即可</p>
<h3 id="自动发现"><a href="#自动发现" class="headerlink" title="自动发现"></a>自动发现</h3><p>Auto Discovery</p>
<blockquote>
<p><strong>需要先完成zabbix客户端部署</strong></p>
</blockquote>
<ol>
<li><p>安装zabbix-agent客户端</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zabbix-agent2</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑zabbix-agent客户端 配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/zabbix/zabbix_agent2.conf		<span class="comment"># 编辑zabbix客户端配置文件，配置以下内容</span></span><br><span class="line"></span><br><span class="line">Server=192.168.110.128		<span class="comment"># Server=服务端IP</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动zabbix-agent客户端，并设置自启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> zabbix-agent2</span><br><span class="line">systemctl start zabbix-agent2</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p><strong>配置自动发现规则</strong></p>
</blockquote>
<ol>
<li><p>进入zabbix监控的web界面，点击侧边栏的<strong>配置</strong>&gt;<strong>自动发现</strong>，点击右上角<strong>创建发现规则</strong>，或者点击已有规则进行修改。</p>
</li>
<li><p>填写相关信息，添加即可。</p>
<p><a href="/../pic/image-20240224045246581.png" title="image-20240224045246581" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240224045246581.png" alt="image-20240224045246581"></a></p>
</li>
</ol>
<blockquote>
<p><strong>配置添加主机动作</strong></p>
</blockquote>
<ol>
<li><p>进入zabbix监控的web界面，点击侧边栏的<strong>配置</strong>&gt;<strong>动作</strong>，点击左上角<strong>触发器动作</strong>，改为<strong>发现动作</strong>。</p>
</li>
<li><p>点击右上角<strong>创建动作</strong>，或者点击已有动作进行修改。</p>
</li>
<li><p>配置动作，设置动作名称以及条件</p>
<p><a href="/../pic/image-20240224050340947.png" title="image-20240224050340947" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240224050340947.png" alt="image-20240224050340947"></a></p>
</li>
<li><p>配置操作，设置动作的具体操作</p>
<p><a href="/../pic/image-20240224050558117.png" title="image-20240224050558117" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240224050558117.png" alt="image-20240224050558117"></a></p>
</li>
<li><p>稍等一段时间，会发现主机数量增加（web页面侧边栏 &gt; 监测 &gt; 主机）</p>
</li>
</ol>
<h3 id="自动注册"><a href="#自动注册" class="headerlink" title="自动注册"></a>自动注册</h3><p>Auto Registration</p>
<blockquote>
<p><strong>配置客户端</strong></p>
</blockquote>
<ol>
<li><p>安装zabbix-agent客户端</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zabbix-agent2</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑zabbix-agent客户端 配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/zabbix/zabbix_agent2.conf		<span class="comment"># 编辑zabbix客户端配置文件，配置以下内容</span></span><br><span class="line"></span><br><span class="line">Server=192.168.110.128		<span class="comment"># Server=服务端IP</span></span><br><span class="line">ServerActive=192.168.110.128		<span class="comment"># ServerActive=服务端IP</span></span><br><span class="line">Hostname=db01		<span class="comment"># 手动配置主机名，也可以自动获取，写为`HostnameItem=system.hostname`</span></span><br><span class="line">HostMetadata=db01		<span class="comment"># 手动配置主机元数据(唯一标识)，可写主机名或IP等，自动获取可写为`HostMetadataItem=system.hostname`</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动zabbix-agent客户端，并设置自启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> zabbix-agent2</span><br><span class="line">systemctl start zabbix-agent2</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p><strong>配置自动注册动作</strong></p>
</blockquote>
<ol>
<li><p>进入zabbix监控的web界面，点击侧边栏的<strong>配置</strong>&gt;<strong>动作</strong>，点击左上角<strong>触发器动作</strong>，改为<strong>自动注册动作</strong>。</p>
</li>
<li><p>点击右上角<strong>创建动作</strong>，或者点击已有动作进行修改。</p>
</li>
<li><p>配置动作，设置动作名称以及条件</p>
<p><a href="/../pic/image-20240225214016286.png" title="image-20240225214016286" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240225214016286.png" alt="image-20240225214016286"></a></p>
</li>
<li><p>配置操作，设置动作的具体操作</p>
<p><a href="/../pic/image-20240225214030917.png" title="image-20240225214030917" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240225214030917.png" alt="image-20240225214030917"></a></p>
</li>
<li><p>稍等一段时间，会发现主机数量增加（web页面侧边栏 &gt; 监测 &gt; 主机）</p>
</li>
</ol>
<h2 id="监控取值的主动与被动"><a href="#监控取值的主动与被动" class="headerlink" title="监控取值的主动与被动"></a>监控取值的主动与被动</h2><p>除了添加主机的方式分为主动和被动以外，获取监控项数据的方式也分为主动和被动。</p>
<table>
<thead>
<tr>
<th></th>
<th>被动</th>
<th>主动</th>
</tr>
</thead>
<tbody><tr>
<td>特点</td>
<td>服务端向客户端索取数据</td>
<td>客户端主动向服务端提供数据</td>
</tr>
<tr>
<td>性能</td>
<td>服务端性能压力大</td>
<td>对服务端要求不高</td>
</tr>
<tr>
<td>配置</td>
<td>默认是被动模式：Server&#x3D;服务端IP</td>
<td>zabbix客户端配置文件增加：ServerActive&#x3D;服务端IP</td>
</tr>
<tr>
<td>生产应用</td>
<td>不推荐</td>
<td>推荐使用主动模式</td>
</tr>
</tbody></table>
<p>主动模式的配置步骤：</p>
<blockquote>
<p><strong>配置客户端</strong></p>
</blockquote>
<p>安装zabbix-agent2客户端，修改配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install -y zabbix-agent2</span><br><span class="line"></span><br><span class="line">vim /etc/zabbix/zabbix_agent2.conf		<span class="comment"># 编辑zabbix客户端配置文件，配置以下内容</span></span><br><span class="line">Server=192.168.110.128		<span class="comment"># Server=服务端IP</span></span><br><span class="line">ServerActive=192.168.110.128		<span class="comment"># ServerActive=服务端IP</span></span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-agent2</span><br><span class="line">systemctl start zabbix-agent2</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>修改监控项</strong></p>
</blockquote>
<p>找到模板中的监控项，或者某个主机的监控项，把类型为<code>Zabbix客户端</code>的监控项，批量更新为<code>Zabbix客户端（主动式）</code>类型。</p>
<p><a href="/../pic/image-20240225231553959.png" title="image-20240225231553959" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240225231553959.png" alt="image-20240225231553959"></a></p>
<p><a href="/../pic/image-20240225231612746.png" title="image-20240225231612746" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240225231612746.png" alt="image-20240225231612746"></a></p>
<h2 id="低级自动发现"><a href="#低级自动发现" class="headerlink" title="低级自动发现"></a>低级自动发现</h2><p>上面说的<code>自动发现</code>和<code>自动注册</code>是自动添加主机的策略。</p>
<p>在传统思路中，监控项是写死的，比如几张网卡eth0、eth1等，如果想要自动查找出主机中新增加或者减少的网卡，再进行监控，传统思路是没办法实现的，可以通过<strong>lld</strong>来实现</p>
<p>低级自动发现（Low Level Discovery），是指在监控项的层面，希望zabbix自动添加一些动态的监控项，比如网卡、磁盘、磁盘分区等。</p>
<p>低级自动发现适合用于监控那些有规律又有一定差异的监控对象，比如服务的多个端口，磁盘分区、网卡等</p>
<h3 id="内置lld概述"><a href="#内置lld概述" class="headerlink" title="内置lld概述"></a>内置lld概述</h3><p>zabbix内置了一些自动发现规则，</p>
<ol>
<li><p>进入zabbix监控的web界面，点击侧边栏的<strong>配置</strong>&gt;<strong>主机</strong>，可以看到主机自带了一些自动发现的规则</p>
<p><a href="/../pic/image-20240227011207302.png" title="image-20240227011207302" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240227011207302.png" alt="image-20240227011207302"></a></p>
</li>
<li><p>点击<strong>自动发现</strong>，可以看到自动发现规则清单</p>
<p><a href="/../pic/image-20240227011324993.png" title="image-20240227011324993" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240227011324993.png" alt="image-20240227011324993"></a></p>
</li>
<li><p>点击旁边的监控项原型，可以查看每个自动发现规则会获取哪些监控项</p>
<p><a href="/../pic/image-20240227020051788.png" title="image-20240227020051788" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240227020051788.png" alt="image-20240227020051788"></a></p>
</li>
<li><p>点击蓝色的自动发现规则名称，可以查看具体的规则信息</p>
<p>自动发现的本质是利用键值，比如<code>net.if.discovery</code></p>
<p><a href="/../pic/image-20240227011935255.png" title="image-20240227011935255" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240227011935255.png" alt="image-20240227011935255"></a></p>
</li>
<li><p>在服务端中测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">zabbix_get -s lb01 -k net.if.discovery | jq		<span class="comment"># 获取键值，json格式用jq工具处理</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>: <span class="string">&quot;eth0&quot;</span>			<span class="comment"># 键值，&#123;#IFNAME&#125;是低级发现专用宏的格式，用户自定义的宏带$，zabbix内置宏什么都不带</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>: <span class="string">&quot;eth1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;&#123;#IFNAME&#125;&quot;</span>: <span class="string">&quot;lo&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="自定义创建lld"><a href="#自定义创建lld" class="headerlink" title="自定义创建lld"></a>自定义创建lld</h3><p>以获取<code>nc</code>的多端口为例，先使用<code>nc</code>工具生成几个进程占用不同的端口在后台运行。</p>
<blockquote>
<p><strong>创建lld规则</strong></p>
</blockquote>
<ol>
<li><p>编写取出端口号的命令，并把多个端口的内容生成符合zabbix自动发现规则的格式，以下面的格式为例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ss -tunlp | grep -w nc 		<span class="comment"># 查询nc进程占用的端口号，输出以下内容</span></span><br><span class="line"></span><br><span class="line">tcp    LISTEN     0      10        *:998                   *:*                   <span class="built_in">users</span>:((&quot;nc&quot;,pid=<span class="number">38520</span>,fd=<span class="number">4</span>))</span><br><span class="line">tcp    LISTEN     0      10        *:999                   *:*                   <span class="built_in">users</span>:((&quot;nc&quot;,pid=<span class="number">38156</span>,fd=<span class="number">4</span>))</span><br><span class="line">tcp    LISTEN     0      10     [::]:998                [::]:*                   <span class="built_in">users</span>:((&quot;nc&quot;,pid=<span class="number">38520</span>,fd=<span class="number">3</span>))</span><br><span class="line">tcp    LISTEN     0      10     [::]:999                [::]:*                   <span class="built_in">users</span>:((&quot;nc&quot;,pid=<span class="number">38156</span>,fd=<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来要把自动发现的端口号输出为以下的格式</span></span><br><span class="line">&#123;									<span class="comment"># 固定</span></span><br><span class="line">	<span class="string">&quot;data&quot;</span>:[						<span class="comment"># 固定</span></span><br><span class="line">		&#123;<span class="string">&quot;&#123;#PORTNAME&#125;&quot;</span>:998&#125;,		<span class="comment"># 自定义键名，自动发现的端口号</span></span><br><span class="line">        &#123;<span class="string">&quot;&#123;#PORTNAME&#125;&quot;</span>:999&#125;		<span class="comment"># 自定义键名，自动发现的端口号，最后一项后面不加逗号</span></span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据此次需求，编写脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">vim /server/scripts/net.port.discovery.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">port_list=(`ss -tunlp | grep -w nc | awk -F<span class="string">&#x27;[ :]+&#x27;</span> <span class="string">&#x27;$6~/^[0-9]+$/&#123;print $6&#125;&#x27;</span>`)</span><br><span class="line">i=0</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#123;&#x27;</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;\t&quot;data&quot;:[&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> port <span class="keyword">in</span> <span class="variable">$&#123;port_list[*]&#125;</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		<span class="built_in">let</span> i++</span><br><span class="line">		<span class="keyword">if</span> [<span class="variable">$i</span> -eq <span class="variable">$&#123;#port_list[*]&#125;</span>]</span><br><span class="line">		<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> -e <span class="string">&quot;\t\t&#123;\&quot;&#123;#PORTNAME&#125;\&quot;:<span class="variable">$port</span>&#125;&quot;</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="built_in">echo</span> -e <span class="string">&quot;\t\t&#123;\&quot;&#123;#PORTNAME&#125;\&quot;:<span class="variable">$port</span>&#125;,&quot;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;\t]&#x27;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在zabbix客户端的配置文件中写入自定义键值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/zabbix/zabbix_agent2.d/xxx.conf</span><br><span class="line"></span><br><span class="line">UserParameter=net.port.discovery,<span class="built_in">sudo</span> sh /server/scripts/net.port.discovery.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>在服务端进行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zabbix_get -s 192.168.110.135 -k net.port.discovery		<span class="comment"># 如果没获取到想要的数据，也可能是zabbix用户没有root执行权限导致的</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在web页面操作</p>
<p><strong>配置</strong>&gt;<strong>主机</strong>&gt;点击对应主机的<strong>自动发现</strong>&gt;<strong>创建发现规则</strong>，填写相关信息，点击<strong>添加</strong>即可。</p>
<p><a href="/../pic/image-20240228025133954.png" title="image-20240228025133954" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240228025133954.png" alt="image-20240228025133954"></a></p>
</li>
</ol>
<blockquote>
<p><strong>根据自动发现的端口，创建监控项原型</strong></p>
</blockquote>
<p>比如要添加一个端口是否存在的监控项原型，可以直接使用内置的键值<code>net.tcp.port[&lt;ip&gt;,port]</code>,直接在自动发现规则里面添加监控项原型</p>
<p><code>&lt;ip&gt;</code>表示这个参数可以忽略,但是后面的逗号不能忽略</p>
<p><code>port</code>这个参数替换为<code>&#123;#PORTNAME&#125;</code></p>
<p><a href="/../pic/image-20240228031929776.png" title="image-20240228031929776" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240228031929776.png" alt="image-20240228031929776"></a></p>
<p>如果要添加一个自定义的监控项原型，跟上面的过程类似，不过键值要自己创建，简单的值用一条命令，复杂的值就创建脚本，然后写在客户端的键值配置文件里，并测试可以获取到值。</p>
<blockquote>
<p><strong>根据自动发现的端口，创建触发器原型</strong></p>
</blockquote>
<p>跟自定义监控类似，不再赘述</p>
<blockquote>
<p><strong>根据自动发现的端口，创建图形原型</strong></p>
</blockquote>
<p>跟自定义监控类似，不再赘述</p>
</div><script src="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery) {
        var options1 = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2024-02-16</span>
            
                <span>该篇文章被 邓胖胖</span>
            
            
                <span>打上标签:
                    
                    
                        <a href='/tags/Zabbix/'>
                            Zabbix
                        </a>
                    
                </span>
             
             
                <span>归为分类:
                    
                    
                        <a href='/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/'>
                            学习笔记
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>上一篇：<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">上一篇：<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
             

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- 返回的按钮-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>