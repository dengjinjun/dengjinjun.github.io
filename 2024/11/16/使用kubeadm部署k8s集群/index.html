<!DOCTYPE html>
<html lang="en">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="ä½¿ç”¨kubeadméƒ¨ç½²k8sé«˜å¯ç”¨é›†ç¾¤" />
    <meta name="hexo-theme-A4" content="v1.9.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Dengpangpang</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Dengpangpang</a> 
            <span class="description"></span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">ğŸŸé¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">ğŸ“æ–‡ç« </a></li>
            
        
            
                <li><a href="/tags/">ğŸ·ï¸æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">ğŸ—‚ï¸åˆ†ç±»</a></li>
            
        
            
                <li><a href="/about/">ğŸ‘ï¸å…³äº</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            ä½¿ç”¨kubeadméƒ¨ç½²k8sé«˜å¯ç”¨é›†ç¾¤
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="post-toc-text">åŸºç¡€é…ç½®</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="post-toc-text">éƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%8E%AF%E5%A2%83"><span class="post-toc-text">éƒ¨ç½²è´Ÿè½½å‡è¡¡ç¯å¢ƒ</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AE%89%E8%A3%85kubeadm"><span class="post-toc-text">å®‰è£…kubeadm</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="post-toc-text">åˆå§‹åŒ–é›†ç¾¤</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6flannel"><span class="post-toc-text">éƒ¨ç½²ç½‘ç»œæ’ä»¶flannel</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2ingress-controller"><span class="post-toc-text">éƒ¨ç½²ingress-controller</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2metrics-server"><span class="post-toc-text">éƒ¨ç½²metrics-server</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2Dashboard"><span class="post-toc-text">éƒ¨ç½²Dashboard</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="post-toc-text">å·¥ä½œèŠ‚ç‚¹é…ç½®</span></a></li></ol>
            
        
        <link rel="stylesheet" type="text/css" href="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/css/lightgallery.min.css" /><div class=".article-gallery"><p>åŸºç¡€èµ„æºï¼š3å°masterä¸»æœºï¼Œä¸€å°nodeä¸»æœº</p>
<p>ç³»ç»Ÿç‰ˆæœ¬ï¼šUbuntu 24.04</p>
<p>è½¯ä»¶ç‰ˆæœ¬ï¼šcontainerd 1.7.12ï¼Œkubernetes v1.31.2</p>
<h2 id="åŸºç¡€é…ç½®"><a href="#åŸºç¡€é…ç½®" class="headerlink" title="åŸºç¡€é…ç½®"></a>åŸºç¡€é…ç½®</h2><p><strong>é…ç½®æ—¶é—´åŒæ­¥</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt -y install chrony </span><br><span class="line">systemctl <span class="built_in">enable</span> chrony &amp;&amp;  systemctl start chrony</span><br><span class="line">chronyc sources -v</span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®ä¸»æœºåè§£æ</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦é…ç½®</span></span><br><span class="line">hostnamectl set-hostname k8s-master-01</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF | tee /etc/hosts </span></span><br><span class="line"><span class="string">172.16.0.253  vip.cluster.local</span></span><br><span class="line"><span class="string">172.16.0.250 k8s-master-01</span></span><br><span class="line"><span class="string">172.16.0.251 k8s-master-02</span></span><br><span class="line"><span class="string">172.16.0.252 k8s-master-03</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®å…å¯†ç™»å½•</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id k8s-master-01</span><br><span class="line">ssh-copy-id k8s-master-02</span><br><span class="line">ssh-copy-id k8s-master-03</span><br><span class="line">ssh-copy-id k8s-node-01</span><br></pre></td></tr></table></figure>

<p><strong>å…³é—­äº¤æ¢ç©ºé—´</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a &amp;&amp; <span class="built_in">sudo</span> sed -i <span class="string">&#x27;/swap/s/^/#/&#x27;</span> /etc/fstab	</span><br></pre></td></tr></table></figure>

<p><strong>ç¦ç”¨é˜²ç«å¢™</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ufw <span class="built_in">disable</span></span><br><span class="line">ufw status</span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ ipvså†…æ ¸ä¾èµ–é…ç½®</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…ipvsadm</span></span><br><span class="line">apt update &amp;&amp; apt install -y ipset ipvsadm</span><br><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/modules-load.d/ipvs.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">ip_vs</span></span><br><span class="line"><span class="string">ip_vs_rr</span></span><br><span class="line"><span class="string">ip_vs_wrr</span></span><br><span class="line"><span class="string">ip_vs_sh</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># ä½¿ä¹‹ç”Ÿæ•ˆ</span></span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line"><span class="comment"># æŸ¥çœ‹</span></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">	<span class="comment"># è¾“å‡ºåº”è¯¥æ˜¯è¿™æ ·çš„</span></span><br><span class="line">    ip_vs_sh               16384  0</span><br><span class="line">    ip_vs_wrr              16384  0</span><br><span class="line">    ip_vs_rr               16384  0</span><br><span class="line">    ip_vs                 212992  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span><br><span class="line">    nf_conntrack          204800  1 ip_vs</span><br><span class="line">    nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span><br><span class="line">    nf_defrag_ipv4         16384  1 nf_conntrack</span><br><span class="line">    libcrc32c              16384  5 nf_conntrack,btrfs,xfs,raid456,ip_vs</span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ containerdçš„å†…æ ¸ä¾èµ–é…ç½®</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/modules-load.d/containerd.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># ä½¿ä¹‹ç”Ÿæ•ˆ</span></span><br><span class="line">modprobe overlay		</span><br><span class="line">modprobe br_netfilter</span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ 99-kubernetes-cri.confé…ç½®æ–‡ä»¶</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/sysctl.d/99-kubernetes-cri.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">user.max_user_namespaces=28633</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># ä½¿ä¹‹ç”Ÿæ•ˆ</span></span><br><span class="line">sysctl -p /etc/sysctl.d/99-kubernetes-cri.conf</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ç”Ÿæ•ˆ</span></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line">lsmod | grep overlay</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®è®¤ç³»ç»Ÿå˜é‡åœ¨ sysctl é…ç½®ä¸­è¢«è®¾ç½®ä¸º 1</span></span><br><span class="line">sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡æ³¨ï¼šåœ¨æ–‡ä»¶å/etc/sysctl.d/99-kubernetes-cri.confä¸­ï¼Œâ€œ99â€ ä»£è¡¨æ–‡ä»¶çš„ä¼˜å…ˆçº§æˆ–é¡ºåºã€‚sysctlæ˜¯Linuxå†…æ ¸å‚æ•°çš„é…ç½®å·¥å…·ï¼Œå®ƒå¯ä»¥é€šè¿‡ä¿®æ”¹/proc/sys/ç›®å½•ä¸‹çš„æ–‡ä»¶æ¥è®¾ç½®å†…æ ¸å‚æ•°ã€‚åœ¨/etc/sysctl.d/ç›®å½•ä¸­ï¼Œå¯ä»¥æ”¾ç½®ä¸€ç³»åˆ—çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ä¾¿åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½è¿™äº›å‚æ•°ã€‚è¿™äº›é…ç½®æ–‡ä»¶æŒ‰ç…§æ–‡ä»¶åçš„å­—æ¯é¡ºåºé€ä¸ªåŠ è½½ã€‚æ•°å­—å‰ç¼€ç”¨äºæŒ‡å®šåŠ è½½çš„é¡ºåºï¼Œè¾ƒå°çš„æ•°å­—è¡¨ç¤ºè¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚</span></span><br></pre></td></tr></table></figure>

<h2 id="éƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶"><a href="#éƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶" class="headerlink" title="éƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶"></a>éƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶</h2><p><strong>å®‰è£…containerd</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…containerd</span></span><br><span class="line">apt install -y containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆcontainerdçš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd &amp;&amp; containerd config default &gt; /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># ä¿®æ”¹containerdçš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/containerd/config.toml</span><br><span class="line">  <span class="comment"># æŠŠè¿™ä¸ªé…ç½®ä»falseæ”¹æˆtrue</span></span><br><span class="line">  SystemdCgroup = <span class="literal">true</span></span><br><span class="line">  <span class="comment"># æŠŠæ²™ç›’çš„é•œåƒåœ°å€ä»&quot;registry.k8s.io/pause:3.8&quot;æ”¹æˆä¸‹é¢è¿™è¿™</span></span><br><span class="line">  sandbox_image = <span class="string">&quot;registry.aliyuncs.com/google_containers/pause:3.9&quot;</span>  </span><br><span class="line">  <span class="comment"># æ·»åŠ é•œåƒåŠ é€Ÿåœ°å€</span></span><br><span class="line">  config_path = <span class="string">&quot;/etc/containerd/certs.d&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®é•œåƒåŠ é€Ÿ</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd/certs.d/docker.io</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server = &quot;https://docker.io&quot;</span></span><br><span class="line"><span class="string">[host.&quot;https://dockerproxy.com&quot;]</span></span><br><span class="line"><span class="string">capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[host.&quot;https://docker.m.daocloud.io&quot;]</span></span><br><span class="line"><span class="string">capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[host.&quot;https://docker.agsv.top&quot;]</span></span><br><span class="line"><span class="string">capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[host.&quot;https://registry.docker-cn.com&quot;]</span></span><br><span class="line"><span class="string">capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®å¼€æœºå¯åŠ¨</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> containerd --now </span><br><span class="line">systemctl status containerd</span><br></pre></td></tr></table></figure>

<p>å®‰è£…runc (å¯é€‰)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½è½¯ä»¶åŒ…ï¼Œæˆ‘å·²ç»æ”¾åˆ°è…¾è®¯äº‘å­˜å‚¨æ¡¶ä¸­</span></span><br><span class="line">wget https://3dview-1251252938.cos.ap-shanghai.myqcloud.com/dengjinjun/software/runc.amd64</span><br><span class="line"><span class="comment"># å®‰è£…åˆ°/usr/local/sbin/ç›®å½•ä¸‹</span></span><br><span class="line">install -m 755 runc.amd64 /usr/local/sbin/runc</span><br></pre></td></tr></table></figure>

<p>å®‰è£…crictlå·¥å…· (å¯é€‰)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½è½¯ä»¶åŒ…ï¼Œæˆ‘å·²ç»æ”¾åˆ°è…¾è®¯äº‘å­˜å‚¨æ¡¶ä¸­</span></span><br><span class="line">wget https://3dview-1251252938.cos.ap-shanghai.myqcloud.com/dengjinjun/software/crictl-v1.28.0-linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># è§£å‹</span></span><br><span class="line">tar -zxvf crictl-v1.28.0-linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># å®‰è£…åˆ°/usr/local/binç›®å½•ä¸‹</span></span><br><span class="line">install -m 755 crictl /usr/local/bin/crictl</span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">crictl --runtime-endpoint=unix:///run/containerd/containerd.sock  version</span><br><span class="line">  <span class="comment"># è¾“å‡ºåº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·</span></span><br><span class="line">  Version:  0.1.0</span><br><span class="line">  RuntimeName:  containerd</span><br><span class="line">  RuntimeVersion:  v1.7.3</span><br><span class="line">  RuntimeApiVersion:  v1</span><br></pre></td></tr></table></figure>

<p>å®‰è£…nerdctlå·¥å…· (å¯é€‰)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://3dview-1251252938.cos.ap-shanghai.myqcloud.com/dengjinjun/software/nerdctl-1.7.4-linux-amd64.tar.gz</span><br><span class="line">tar xfv nerdctl-1.7.4-linux-amd64.tar.gz -C /usr/bin/</span><br><span class="line">nerdctl version</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/nerdctl</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/nerdctl/nerdctl.toml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">namespace = &quot;k8s.io&quot;</span></span><br><span class="line"><span class="string">debug = false</span></span><br><span class="line"><span class="string">debug_full = false</span></span><br><span class="line"><span class="string">insecure_registry = true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="éƒ¨ç½²è´Ÿè½½å‡è¡¡ç¯å¢ƒ"><a href="#éƒ¨ç½²è´Ÿè½½å‡è¡¡ç¯å¢ƒ" class="headerlink" title="éƒ¨ç½²è´Ÿè½½å‡è¡¡ç¯å¢ƒ"></a>éƒ¨ç½²è´Ÿè½½å‡è¡¡ç¯å¢ƒ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…haproxyå’Œkeepalived</span></span><br><span class="line">apt install keepalived haproxy -y </span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;  /etc/haproxy/haproxy.cfg &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">global</span></span><br><span class="line"><span class="string">        log /dev/log    local0</span></span><br><span class="line"><span class="string">        log /dev/log    local1 notice</span></span><br><span class="line"><span class="string">        chroot /var/lib/haproxy</span></span><br><span class="line"><span class="string">        stats socket /run/haproxy/admin.sock mode 660 level admin</span></span><br><span class="line"><span class="string">        stats timeout 30s</span></span><br><span class="line"><span class="string">        user haproxy</span></span><br><span class="line"><span class="string">        group haproxy</span></span><br><span class="line"><span class="string">        daemon</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        # Default SSL material locations</span></span><br><span class="line"><span class="string">        ca-base /etc/ssl/certs</span></span><br><span class="line"><span class="string">        crt-base /etc/ssl/private</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        # See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.0.3&amp;config=intermediate</span></span><br><span class="line"><span class="string">        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span></span><br><span class="line"><span class="string">        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256</span></span><br><span class="line"><span class="string">        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line"><span class="string">        log     global</span></span><br><span class="line"><span class="string">        mode    http</span></span><br><span class="line"><span class="string">        option  httplog</span></span><br><span class="line"><span class="string">        option  dontlognull</span></span><br><span class="line"><span class="string">        timeout connect 5000</span></span><br><span class="line"><span class="string">        timeout client  50000</span></span><br><span class="line"><span class="string">        timeout server  50000</span></span><br><span class="line"><span class="string">        errorfile 400 /etc/haproxy/errors/400.http</span></span><br><span class="line"><span class="string">        errorfile 403 /etc/haproxy/errors/403.http</span></span><br><span class="line"><span class="string">        errorfile 408 /etc/haproxy/errors/408.http</span></span><br><span class="line"><span class="string">        errorfile 500 /etc/haproxy/errors/500.http</span></span><br><span class="line"><span class="string">        errorfile 502 /etc/haproxy/errors/502.http</span></span><br><span class="line"><span class="string">        errorfile 503 /etc/haproxy/errors/503.http</span></span><br><span class="line"><span class="string">        errorfile 504 /etc/haproxy/errors/504.http</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># apiserver frontend which proxys to the control plane nodes</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">frontend apiserver</span></span><br><span class="line"><span class="string">    bind *:16443</span></span><br><span class="line"><span class="string">    mode tcp</span></span><br><span class="line"><span class="string">    option tcplog</span></span><br><span class="line"><span class="string">    default_backend apiserverbackend</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string"># round robin balancing for apiserver</span></span><br><span class="line"><span class="string">#---------------------------------------------------------------------</span></span><br><span class="line"><span class="string">backend apiserverbackend</span></span><br><span class="line"><span class="string">    option httpchk</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    http-check connect ssl</span></span><br><span class="line"><span class="string">    http-check send meth GET uri /healthz</span></span><br><span class="line"><span class="string">    http-check expect status 200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mode tcp</span></span><br><span class="line"><span class="string">    balance     roundrobin</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    server master1 192.168.0.51:6443 check verify none</span></span><br><span class="line"><span class="string">    server master2 192.168.0.52:6443 check verify none</span></span><br><span class="line"><span class="string">    server master3 192.168.0.53:6443 check verify none</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># keepalivedé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">touch</span> /etc/keepalived/keepalived.conf</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/keepalived.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">! Configuration File for keepalived</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">global_defs &#123;</span></span><br><span class="line"><span class="string">   router_id LVS_DEVEL</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_script check_apiserver &#123;</span></span><br><span class="line"><span class="string">  script &quot;/etc/keepalived/check_apiserver.sh&quot;</span></span><br><span class="line"><span class="string">  interval 3</span></span><br><span class="line"><span class="string">  weight -2</span></span><br><span class="line"><span class="string">  fall 10</span></span><br><span class="line"><span class="string">  rise 2</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_instance VI_1 &#123;</span></span><br><span class="line"><span class="string">    state MASTER  # master1ä¸ºMASTERï¼Œå…¶ä»–ä¸¤å°ä¸ºBACKUP</span></span><br><span class="line"><span class="string">    interface ens33  # ç½‘å¡åç§°</span></span><br><span class="line"><span class="string">    virtual_router_id 51</span></span><br><span class="line"><span class="string">    priority 101    # ä¼˜å…ˆçº§ï¼Œmaster1ä¸º101ï¼Œå…¶ä»–ä¸¤å°ä¸º100</span></span><br><span class="line"><span class="string">    advert_int 1</span></span><br><span class="line"><span class="string">    authentication &#123;</span></span><br><span class="line"><span class="string">        auth_type PASS</span></span><br><span class="line"><span class="string">        auth_pass 1111</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    virtual_ipaddress &#123;</span></span><br><span class="line"><span class="string">        192.168.0.50 # è™šipï¼Œä¿æŒä¸€è‡´</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    track_script &#123;</span></span><br><span class="line"><span class="string">        check_apiserver</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¥åº·æ£€æŸ¥è„šæœ¬</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/keepalived/check_apiserver.sh &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/sh</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">errorExit() &#123;</span></span><br><span class="line"><span class="string">    echo &quot;*** $*&quot; 1&gt;&amp;2</span></span><br><span class="line"><span class="string">    exit 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">curl -sfk --max-time 2 https://localhost:16443/healthz -o /dev/null || errorExit &quot;Error GET https://localhost:16443/healthz&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x /etc/keepalived/check_apiserver.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯å¹¶è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl restart haproxy keepalived</span><br><span class="line">systemctl <span class="built_in">enable</span>  haproxy keepalived</span><br></pre></td></tr></table></figure>



<h2 id="å®‰è£…kubeadm"><a href="#å®‰è£…kubeadm" class="headerlink" title="å®‰è£…kubeadm"></a>å®‰è£…kubeadm</h2><p><strong>å‡†å¤‡è½¯ä»¶æºï¼Œk8s 1.31.2ç‰ˆæœ¬</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…httpsä¼ è¾“æ‰€éœ€çš„è½¯ä»¶åŒ…</span></span><br><span class="line">apt-get install -y apt-transport-https ca-certificates curl gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/apt/keyrings</span><br><span class="line"></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.31/deb/Release.key |</span><br><span class="line">    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span><br><span class="line">    </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.31/deb/ /&quot;</span> |</span><br><span class="line">    <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æ›´æ–°</span></span><br><span class="line">apt-get update</span><br></pre></td></tr></table></figure>

<p>k8sè½¯ä»¶æºï¼Œ1.28.2 ç‰ˆæœ¬(å¤‡é€‰)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…httpsä¼ è¾“æ‰€éœ€çš„è½¯ä»¶åŒ…</span></span><br><span class="line">apt-get install -y apt-transport-https ca-certificates curl gpg</span><br><span class="line"><span class="comment"># æ·»åŠ k8sçš„å…¬é’¥</span></span><br><span class="line">curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | <span class="built_in">sudo</span> apt-key add -</span><br><span class="line"><span class="comment"># æ·»åŠ aptæº</span></span><br><span class="line"><span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line"><span class="comment"># å†æ¬¡æ›´æ–°</span></span><br><span class="line">apt-get update</span><br></pre></td></tr></table></figure>

<p><strong>å®‰è£…è½¯ä»¶åŒ…</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…è½¯ä»¶åŒ…</span></span><br><span class="line">apt install kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡æ³¨ï¼šå¦‚é‡ä¸èƒ½æ­£å¸¸é€šè¿‡HTTPSæ–¹å¼è·å–æ•°æ®æ—¶ï¼Œå°†GNUTLS_CPUID_OVERRIDE ç¯å¢ƒå˜é‡æ·»åŠ åˆ°/etc/environment æ–‡ä»¶ä¸­</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export GNUTLS_CPUID_OVERRIDE=0x1&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/environment</span><br><span class="line"><span class="comment"># é€€å‡ºé‡æ–°ç™»å½•ï¼Œå†æ‰§è¡Œæ›´æ–°åŒ…åˆ—è¡¨ï¼Œå®‰è£…kubeletã€kubeadmå’Œkubectl,å³å¯æˆåŠŸ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é˜²æ­¢è‡ªåŠ¨å‡çº§</span></span><br><span class="line">apt-mark hold kubelet kubeadm kubectl</span><br><span class="line"><span class="comment"># å¼€æœºå¯åŠ¨kubeletæœåŠ¡</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectlå‘½ä»¤è¡¥å…¨</span></span><br><span class="line">apt install -y bash-completion</span><br><span class="line"><span class="built_in">source</span> /usr/share/bash-completion/bash_completion</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;source &lt;(kubectl completion bash)&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;source &lt;(kubectl completion bash)&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">kubectl completion bash &gt;/etc/bash_completion.d/kubectl</span><br><span class="line"><span class="comment"># è®¾ç½®kubectlåˆ«åè‡ªåŠ¨è¡¥å…¨</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;alias kk=kubectl&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;complete -F __start_kubectl kk&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>



<h2 id="åˆå§‹åŒ–é›†ç¾¤"><a href="#åˆå§‹åŒ–é›†ç¾¤" class="headerlink" title="åˆå§‹åŒ–é›†ç¾¤"></a>åˆå§‹åŒ–é›†ç¾¤</h2><p><strong>åˆå§‹åŒ–ä¹‹å‰é‡å¯ä¸€ä¸‹containerd   ï¼ï¼ï¼</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure>

<p>æ‹‰å–é•œåƒ(å¯é€‰)</p>
<p>å¦‚æœç›´æ¥åˆå§‹åŒ–ä¹Ÿä¼šè‡ªåŠ¨æ‹‰å–ï¼Œä¸è¿‡ä¼šæ‹–æ…¢åˆå§‹åŒ–è¿‡ç¨‹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull --kubernetes-version=v1.31.2 --image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨å‘½ä»¤çš„æ–¹å¼åˆå§‹åŒ–</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">--kubernetes-version=v1.31.2  \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers --v=5 \</span><br><span class="line">--control-plane-endpoint vip.cluster.local:16443 \</span><br><span class="line">--upload-certs \</span><br><span class="line">--service-cidr=10.96.0.0/12 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼ˆå¤‡é€‰ï¼‰</p>
<p>æ‰“å°é›†ç¾¤åˆå§‹åŒ–é»˜è®¤çš„ä½¿ç”¨çš„é…ç½®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config <span class="built_in">print</span> init-defaults &gt; init.default.yaml</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®è¿™ä¸ªé…ç½®è‡ªå®šä¹‰ä¸€ä¸ªæ–‡ä»¶kubeadm.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">bootstrapTokens:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class="line">  <span class="attr">token:</span> <span class="string">abcdef.0123456789abcdef</span></span><br><span class="line">  <span class="attr">ttl:</span> <span class="string">24h0m0s</span></span><br><span class="line">  <span class="attr">usages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">signing</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">authentication</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.51</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///var/run/containerd/containerd.sock</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">master1</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">controlPlaneEndpoint:</span> <span class="string">vip.cluster.local:16443</span>   <span class="comment"># é«˜å¯ç”¨</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.28</span><span class="number">.2</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.200</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>æŒ‡å®šyamlæ–‡ä»¶è¿›è¡Œåˆå§‹åŒ–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config kubeadm.yaml</span><br></pre></td></tr></table></figure>

<p><strong>åˆå§‹åŒ–æˆåŠŸ</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­£å¸¸çš„è¯ï¼Œä¸€ä¸¤åˆ†é’Ÿä¹‹ååˆå§‹åŒ–æˆåŠŸä¼šæ˜¾ç¤ºä»¥ä¸‹å†…å®¹</span></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"><span class="comment"># æ™®é€šç”¨æˆ·æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥æ“ä½œk8sé›†ç¾¤</span></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"><span class="comment"># rootç”¨æˆ·ä½¿ç”¨è¿™å¥å‘½ä»¤å°±å¯ä»¥ï¼Œå½“å‰ä¼šè¯æœ‰æ•ˆ</span></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line"><span class="comment"># æé†’æˆ‘è¿˜éœ€è¦éƒ¨ç½²ç½‘ç»œæ’ä»¶</span></span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"><span class="comment"># å…¶ä»–å·¥ä½œèŠ‚ç‚¹è¦åŠ å…¥é›†ç¾¤ï¼Œéœ€è¦è¿è¡Œä¸‹é¢çš„å‘½ä»¤</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 192.168.226.4:6443 --token ejfu30.jwtm65sw7j49fsko \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:ce7825defa02d313f9fbdbad40e8ea930b20d6decde6d97b7320cfe3eaeed542 </span><br></pre></td></tr></table></figure>



<p><strong>åˆå§‹åŒ–å¤±è´¥</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…ç†åˆå§‹åŒ–å†…å®¹ï¼Œå¯ä»¥é‡æ–°åˆå§‹åŒ–</span></span><br><span class="line">kubeadm reset -f </span><br><span class="line"><span class="built_in">rm</span> -rf ~/.kube/  /etc/kubernetes/ /etc/cni /opt/cni /var/lib/etcd  /var/etcd</span><br></pre></td></tr></table></figure>



<p><strong>é”™è¯¯æ’æŸ¥å‚è€ƒ</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">journalctl -xeu kubelet | grep Failed</span><br><span class="line">/var/lib/kubelet/config.yaml</span><br><span class="line">/etc/kubernetes/kubelet.conf</span><br><span class="line">æ£€æŸ¥åŸŸåå’Œvipçš„è§£æåŠæ˜¯å¦å¯pingé€š</span><br></pre></td></tr></table></figure>





<h2 id="éƒ¨ç½²ç½‘ç»œæ’ä»¶flannel"><a href="#éƒ¨ç½²ç½‘ç»œæ’ä»¶flannel" class="headerlink" title="éƒ¨ç½²ç½‘ç»œæ’ä»¶flannel"></a>éƒ¨ç½²ç½‘ç»œæ’ä»¶flannel</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://3dview-1251252938.cos.ap-shanghai.myqcloud.com/dengjinjun/software/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>



<h2 id="éƒ¨ç½²ingress-controller"><a href="#éƒ¨ç½²ingress-controller" class="headerlink" title="éƒ¨ç½²ingress-controller"></a>éƒ¨ç½²ingress-controller</h2><p>ingress-controlleræˆ‘æ˜¯å‡†å¤‡åšé«˜å¯ç”¨çš„ï¼Œéƒ¨ç½²åœ¨node1å’Œnode2èŠ‚ç‚¹ä¸Šï¼Œç„¶åä½¿ç”¨keepalivedåšä¸€ä¸ªè™šæ‹ŸIPå®ç°é«˜å¯ç”¨ï¼Œä½†æ˜¯ç”Ÿäº§æ„ä¹‰ä¸å¤§ï¼Œå› ä¸ºç”Ÿäº§ç¯å¢ƒç›´æ¥ç”¨äº‘å‚å•†çš„è´Ÿè½½å‡è¡¡åº”è¯¥å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œåªåœ¨node1ä¸Šéƒ¨ç½²äº†ingress-controller</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é¦–å…ˆç»™node1æ‰“ä¸Šæ ‡ç­¾</span></span><br><span class="line">kubectl label node k8s-node1 node-role.kubernetes.io/edge=</span><br><span class="line"><span class="comment"># ä¸‹è½½ingress-nginxçš„helm chart</span></span><br><span class="line">wget https://github.com/kubernetes/ingress-nginx/releases/download/helm-chart-4.10.1/ingress-nginx-4.10.1.tgz</span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¿™ä¸ªchartçš„å¯å®šåˆ¶é…ç½®</span></span><br><span class="line">helm show values ingress-nginx-4.10.1.tgz</span><br></pre></td></tr></table></figure>

<p>å¯¹values.yamlé…ç½®å®šåˆ¶å¦‚ä¸‹:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">controller:</span></span><br><span class="line">  <span class="attr">ingressClassResource:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">default:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controllerValue:</span> <span class="string">&quot;k8s.io/ingress-nginx&quot;</span></span><br><span class="line">  <span class="attr">admissionWebhooks:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">          <span class="comment">#registry: in-road-docker.pkg.coding.net</span></span><br><span class="line">          <span class="comment">#image: in/road/ing-ctl</span></span><br><span class="line">          <span class="comment">#tag: &quot;v1.9.5&quot;</span></span><br><span class="line">    <span class="attr">registry:</span> <span class="string">docker.io</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">unreachableg/registry.k8s.io_ingress-nginx_controller</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">&quot;v1.9.5&quot;</span></span><br><span class="line">    <span class="attr">digest:</span> <span class="string">sha256:bdc54c3e73dcec374857456559ae5757e8920174483882b9e8ff1a9052f96a35</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">node-role.kubernetes.io/edge:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span></span><br><span class="line">        <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">            <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">nginx-ingress</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">component</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">controller</span></span><br><span class="line">          <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">PreferNoSchedule</span></span><br></pre></td></tr></table></figure>

<p>å‰¯æœ¬æ•°ä¸º1ï¼Œè¢«è°ƒåº¦åˆ°k8s-node1èŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨å®¿ä¸»æœºç½‘ç»œã€‚ </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æå‰æ‹‰å–ä¸€ä¸‹é•œåƒ</span></span><br><span class="line">crictl --runtime-endpoint=unix:///run/containerd/containerd.sock pull unreachableg/registry.k8s.io_ingress-nginx_controller:v1.9.5</span><br><span class="line"><span class="comment"># éƒ¨ç½²</span></span><br><span class="line">helm install ingress-nginx ingress-nginx-4.10.1.tgz --create-namespace -n ingress-nginx -f values.yaml</span><br><span class="line"><span class="comment"># æŸ¥çœ‹çŠ¶æ€</span></span><br><span class="line">kubectl get po -n ingress-nginx</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•è®¿é—®<code>http://192.168.226.4</code>è¿”å›é»˜è®¤çš„nginx 404é¡µï¼Œåˆ™éƒ¨ç½²å®Œæˆã€‚</p>
<h2 id="éƒ¨ç½²metrics-server"><a href="#éƒ¨ç½²metrics-server" class="headerlink" title="éƒ¨ç½²metrics-server"></a>éƒ¨ç½²metrics-server</h2><p>å…ˆéƒ¨ç½²ä¸€ä¸‹<code>metrics-server</code>ï¼Œ<code>metrics-server</code> æ˜¯ Kubernetes é›†ç¾¤ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºæ”¶é›†é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹å’Œå®¹å™¨çš„èµ„æºåˆ©ç”¨ç‡æ•°æ®ï¼ˆä¾‹å¦‚ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼‰ã€‚è¿™äº›æ•°æ®ä¸»è¦ç”¨äºè‡ªåŠ¨æ‰©å±•å’Œç›‘æ§ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½yamlæ–‡ä»¶</span></span><br><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.4/components.yaml</span><br></pre></td></tr></table></figure>

<p>æŠŠèµ„æºæ–‡ä»¶ä¸­çš„é•œåƒä¿®æ”¹ä¸º<code>docker.io/unreachableg/k8s.gcr.io_metrics-server_metrics-server:v0.6.4</code>ï¼Œå®¹å™¨çš„å¯åŠ¨å‚æ•°ï¼ŒåŠ å…¥<code>--kubelet-insecure-tls</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº”ç”¨</span></span><br><span class="line">kubectl apply -f components.yaml</span><br><span class="line"><span class="comment"># æŸ¥çœ‹çŠ¶æ€</span></span><br><span class="line">kubectl -n kube-system get pods</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨ <code>kubectl top</code> å‘½ä»¤æ¥éªŒè¯ <code>metrics-server</code> æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">kubectl top nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹Podçš„èµ„æºä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">kubectl top pods --all-namespaces</span><br></pre></td></tr></table></figure>

<h2 id="éƒ¨ç½²Dashboard"><a href="#éƒ¨ç½²Dashboard" class="headerlink" title="éƒ¨ç½²Dashboard"></a>éƒ¨ç½²Dashboard</h2><p>ä¸‹è½½dashboardçš„yamlæ¸…å•æ–‡ä»¶:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1wget https://raw.githubusercontent.com/kubernetes/dashboard/v3.0.0-alpha0/charts/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>

<p>ç¼–è¾‘kubernetes-dashboard.yamlæ¸…å•æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„ingressä¸­çš„hostæ›¿æ¢è‡ªå·±çš„åŸŸå:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">cert-manager.io/issuer:</span> <span class="string">selfsigned</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">k8s.example.com</span>		<span class="comment"># åŸŸå</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">kubernetes-dashboard-web</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">kubernetes-dashboard-api</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">api</span></span><br></pre></td></tr></table></figure>

<p>æå‰åœ¨å„ä¸ªèŠ‚ç‚¹æ‹‰å–é•œåƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctr images pull docker.io/kubernetesui/dashboard-api:v1.0.0</span><br><span class="line">ctr images pull docker.io/kubernetesui/metrics-scraper:v1.0.9</span><br><span class="line">ctr images pull docker.io/kubernetesui/dashboard-web:v1.0.0</span><br></pre></td></tr></table></figure>

<p>å®‰è£…dashboardçš„yamlæ¸…å•æ–‡ä»¶:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>

<p>ç¡®è®¤dashboardçš„ç›¸å…³Podå¯åŠ¨æ­£å¸¸:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1kubectl get po -n kubernetes-dashboard</span><br><span class="line">2NAME                                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">3kubernetes-dashboard-api-8586787f7-vtszr                1/1     Running   0          60s</span><br><span class="line">4kubernetes-dashboard-metrics-scraper-6959b784dc-c98tz   1/1     Running   0          59s</span><br><span class="line">5kubernetes-dashboard-web-6b6d549b4-qsrsn                1/1     Running   0          60s</span><br><span class="line">6</span><br><span class="line">7kubectl get ingress -n kubernetes-dashboard</span><br><span class="line">8NAME                   CLASS   HOSTS             ADDRESS   PORTS     AGE</span><br><span class="line">9kubernetes-dashboard   nginx   k8s.example.com             80, 443   6m47s</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºç®¡ç†å‘˜sa</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create serviceaccount kube-dashboard-admin-sa -n kube-system</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding kube-dashboard-admin-sa \</span><br><span class="line">--clusterrole=cluster-admin --serviceaccount=kube-system:kube-dashboard-admin-sa</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºé›†ç¾¤ç®¡ç†å‘˜ç™»å½•dashboardæ‰€éœ€token:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create token kube-dashboard-admin-sa -n kube-system --duration=87600h</span><br><span class="line"></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IkFZN3I4cGxrd3VKc0NJek80Z3M0bUlsVEdjYnhnNUI3d3NJNkJmaXJpeEkifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoyMDM0NTA4Mzc3LCJpYXQiOjE3MTkxNDgzNzcsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJrdWJlLWRhc2hib2FyZC1hZG1pbi1zYSIsInVpZCI6ImM3MjA1Nzk0LWJjYTgtNDM1OC04ZTQ5LWU1MjE1NGRjYWViNyJ9fSwibmJmIjoxNzE5MTQ4Mzc3LCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06a3ViZS1kYXNoYm9hcmQtYWRtaW4tc2EifQ.bVeV50hgZYAB2m92kf_N-M0bMaQrB6aCToD8IZUo2go4BTbHDflSzS4s6l6oR6dwxC3qalex9Mhs-GbwLqcyZjU4aBDa9a4pWsOG8dUn24AO4dpXiKv2sBnoLlje4TC3AZPjcigs4Ngp7Ac2_g7Jv2PkO5Ke_GqKiJvv56SLdDagplPEaR82Pa8IEaZIlqzNhwlJFPXFW52f_kqVq54j2-xiLWx3r91gwPTnkbzXgv_AN-ud30iCtEO3NyPID6C7Vv5aEqUC5CIEOz019-Qj_7cW_KFByecEF6iI009ifqmKNMaUwvlI6T8TheXUqB50cyKrBj3O1UpDEYjsKpn2pA</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ä¸Šé¢çš„tokenç™»å½•k8s dashboard</p>
<p><a href="/../pic/image-20240623220646715.png" title="image-20240623220646715" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240623220646715.png" alt="image-20240623220646715"></a></p>
<h2 id="å·¥ä½œèŠ‚ç‚¹é…ç½®"><a href="#å·¥ä½œèŠ‚ç‚¹é…ç½®" class="headerlink" title="å·¥ä½œèŠ‚ç‚¹é…ç½®"></a>å·¥ä½œèŠ‚ç‚¹é…ç½®</h2><p>æ·»åŠ å·¥ä½œèŠ‚ç‚¹åŒæ ·éœ€è¦è¿›è¡Œå¦‚ä¸Šçš„å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>åŸºç¡€é…ç½®</li>
<li>éƒ¨ç½²å®¹å™¨è¿è¡Œæ—¶</li>
<li>å®‰è£…kubeadm</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦è¿›è¡Œé¢å¤–çš„é…ç½®</p>
<ol>
<li><p><strong>å¢å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶</strong></p>
<p>å¦åˆ™å¯åŠ¨å®¹å™¨å¯èƒ½ä¼šå‡ºç°ç±»ä¼¼æŠ¥é”™ï¼š<code>&quot;System.IO.IOException: The configured user limit (128) on the number of inotify instances has been reached.&quot;</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸´æ—¶å¢åŠ </span></span><br><span class="line"><span class="built_in">echo</span> 8192 &gt; /proc/sys/fs/inotify/max_user_instances	</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥é…ç½®</span></span><br><span class="line"><span class="built_in">echo</span> fs.inotify.max_user_watches=65534 |  <span class="built_in">tee</span> -a /etc/sysctl.conf &amp;&amp;  sysctl -p</span><br><span class="line"><span class="built_in">echo</span> fs.inotify.max_user_instances=65534 |  <span class="built_in">tee</span> -a /etc/sysctl.conf &amp;&amp;  sysctl -p</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ç¦ç”¨apparmorç®¡ç†runc</strong></p>
<p>å¦åˆ™å½“apiserverè°ƒç”¨kubeletåˆ é™¤å®¹å™¨æ—¶ï¼Œå‘½ä»¤è¡Œä¼šå¡ä½ï¼Œå®¹å™¨ä¸€ç›´å¤„äºterminatingçŠ¶æ€ï¼Œdescribeç›¸å…³podï¼Œä¼šå‘ç°ç±»ä¼¼æŠ¥é”™ï¼š<code>unknown error after kill: runc did not terminate successfully: exit status 1: unable to signal init: permission denied\n: unknown&quot;</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/apparmor.d/disable      <span class="comment">#å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line"><span class="built_in">ln</span> -s /etc/apparmor.d/runc /etc/apparmor.d/disable/</span><br><span class="line">apparmor_parser -R /etc/apparmor.d/runc</span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure></li>
</ol>
<p>é…ç½®å®Œæˆä¹‹åï¼Œä¸»èŠ‚ç‚¹è¿è¡Œ<code>kubeadm token create --print-join-command</code>ï¼Œä¼šè¾“å‡ºå·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼Œåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸‹ã€‚</p>
</div><script src="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery) {
        var options1 = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2024-11-16</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« é‚“èƒ–èƒ–</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/K8S/'>
                            K8S
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/'>
                            å­¦ä¹ ç¬”è®°
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
             

            
                

            
        </span>
    
</div>
<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>