<!DOCTYPE html>
<html lang="en">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="Prometheus监控全讲解" />
    <meta name="hexo-theme-A4" content="v1.9.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Dengpangpang</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Dengpangpang</a> 
            <span class="description"></span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">🍟首页</a></li>
            
        
            
                <li><a href="/list/">📝文章</a></li>
            
        
            
                <li><a href="/tags/">🏷️标签</a></li>
            
        
            
                <li><a href="/categories/">🗂️分类</a></li>
            
        
            
                <li><a href="/about/">👁️关于</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            Prometheus监控全讲解
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Prometheus%E7%9B%91%E6%8E%A7%E5%85%A8%E8%AE%B2%E8%A7%A3"><span class="post-toc-text">Prometheus监控全讲解</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Prometheus%E7%9B%91%E6%8E%A7%E7%90%86%E8%AE%BA"><span class="post-toc-text">Prometheus监控理论</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7%E5%92%8C%E7%99%BD%E7%9B%92%E7%9B%91%E6%8E%A7"><span class="post-toc-text">黑盒监控和白盒监控</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%BB%84%E9%87%91%E6%8C%87%E6%A0%87"><span class="post-toc-text">黄金指标</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Prometheus%E6%9E%B6%E6%9E%84"><span class="post-toc-text">Prometheus架构</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5"><span class="post-toc-text">Prometheus监控实践</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2Prometheus"><span class="post-toc-text">部署Prometheus</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%89%A9%E7%90%86%E8%8A%82%E7%82%B9%E7%9A%84%E7%9B%91%E6%8E%A7"><span class="post-toc-text">物理节点的监控</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="post-toc-text">集群中的组件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1Pod%E4%BF%A1%E6%81%AF"><span class="post-toc-text">业务Pod信息</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF"><span class="post-toc-text">集群状态信息</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#PromQL%E8%AF%AD%E6%B3%95%E4%B8%8EGrafana%E5%87%BA%E5%9B%BE"><span class="post-toc-text">PromQL语法与Grafana出图</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#PromQL%E8%AF%AD%E6%B3%95"><span class="post-toc-text">PromQL语法</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%A0%87%E7%AD%BE%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2"><span class="post-toc-text">标签匹配查询</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%8C%E5%85%83%E6%93%8D%E4%BD%9C"><span class="post-toc-text">二元操作</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="post-toc-text">聚合操作</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="post-toc-text">内置函数</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Grafana%E5%87%BA%E5%9B%BE"><span class="post-toc-text">Grafana出图</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Altermanager%E5%91%8A%E8%AD%A6"><span class="post-toc-text">Altermanager告警</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2Alertmanager"><span class="post-toc-text">部署Alertmanager</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Alert%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="post-toc-text">Alert配置优化</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AF%B9%E6%8E%A5%E7%AC%AC%E4%B8%89%E6%96%B9OA%E8%BD%AF%E4%BB%B6"><span class="post-toc-text">对接第三方OA软件</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Promethues-Operator%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E9%A1%B9%E4%B8%8E%E6%8A%A5%E8%AD%A6"><span class="post-toc-text">Promethues Operator自定义监控项与报警</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Promethues-Operator%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="post-toc-text">Promethues Operator高级用法</span></a></li></ol></li></ol>
            
        
        <link rel="stylesheet" type="text/css" href="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/css/lightgallery.min.css" /><div class=".article-gallery"><h1 id="Prometheus监控全讲解"><a href="#Prometheus监控全讲解" class="headerlink" title="Prometheus监控全讲解"></a>Prometheus监控全讲解</h1><h2 id="Prometheus监控理论"><a href="#Prometheus监控理论" class="headerlink" title="Prometheus监控理论"></a>Prometheus监控理论</h2><h3 id="黑盒监控和白盒监控"><a href="#黑盒监控和白盒监控" class="headerlink" title="黑盒监控和白盒监控"></a>黑盒监控和白盒监控</h3><p>黑盒监控指的是监控外部用户可见的系统行为，白盒监控指的是监控内部暴露出来的指标信息。它们一个对外，一个对内。二者在功能上有 2 点区别。</p>
<ul>
<li>监控角度不同：黑盒更偏向于外侧，你可以理解为是通过某个功能或者具体的某个接口来观察，它并不清楚内部是如何实现的；而白盒则更倾向于从内侧监控，它是代码层面的，从内部的视角来解读整个系统。</li>
<li>面向对象不同：黑盒更倾向于看到这个问题的现象，比如某个端口挂掉了无法再提供服务，它面向的是当下所发生的故障；白盒则更加倾向于面向产生问题的原因，比如我们在日志中可以通过堆栈信息分析出故障的根源。</li>
</ul>
<blockquote>
<p><strong>黑盒监控</strong></p>
</blockquote>
<p>黑盒中的监控一般可以细分为如下的 4 类内容。</p>
<ul>
<li>端口状态：通过程序检测具体业务的端口是否存活。可以简单确定程序是否有在提供服务，如果端口都无法连接，那么肯定是系统出现了问题。通常我们也会结合进程检测使用，如果进程存活，但是端口不存在，则说明可能程序存在某些问题，没有将服务暴露出来。</li>
<li>证书检测：通过检测证书是否有效，确认用户是否可以正常访问。现在的网站服务基本都是使用的 HTTPS，如果证书出现了问题，则可能是浏览器认定为不安全，阻止了用户访问。</li>
<li>探活：通过心跳检测来判定服务是否存活，比如定期通过具体的某个接口检测我们的服务是否运行正常。如果在这里出现异常，则说明我们的系统存在问题。</li>
<li>端到端功能检测：这个就相对复杂一些。通常是通过定期进行端到端的测试，结合业务流程感知业务是否在执行正常，比如我们可以通过 UI 或者接口自动化测试工具，来确认页面中返回的数据或者数据是否是正确的。</li>
</ul>
<blockquote>
<p><strong>白盒监控</strong></p>
</blockquote>
<p>白盒监控中重要的数据维度：</p>
<ul>
<li>日志：通过日志记录可以了解到程序的运行状态，程序中是否存在异常。</li>
<li>指标：数值形式的指标可以帮助我们了解到系统中的数据走向、流量情况等。</li>
<li>链路追踪：我们可以细粒度到程序的代码行级别来将链路可视化，这可以帮助我们了解程序的执行流程。</li>
</ul>
<h3 id="黄金指标"><a href="#黄金指标" class="headerlink" title="黄金指标"></a><strong>黄金指标</strong></h3><p>黄金指标是 Google 针对大量分布式监控的经验总结，它可以在服务级别帮助衡量终端用户体验、服务中断、业务影响等层面的问题，有 4 类指标信息，分为<strong>错误、延迟、流量和饱和度</strong>。无论你监控的数据再复杂、再令人眼花缭乱，都可以套用在这 4 类上。</p>
<ul>
<li><p>错误</p>
<p>错误指的是当前系统所有发生过的错误请求，我们可以通过错误请求个数计算出相应的错误率。</p>
<p>在基础层中，我们可以把系统宕机、进程或者端口挂掉、网络丢包这样的情况认定为是故障。在业务层中，监控的内容也就相对比较多了，比如http状态码500、日志中出现的错误，都是可以被认定为“错误”的指标。</p>
</li>
<li><p>延迟</p>
<p><strong>延迟指的是服务在处理请求时花费的时间。</strong>我们经常说的接口耗时、响应时长指的就是延迟。在这里需要注意一点：一般在统计延迟时，并不会把成功或者错误的信息分开统计。这样的统计方式会使我们更难了解到真实的情况，所以在统计时常常需要把它们区分开。以一个 HTTP 接口为例，响应状态码正确的（200）和错误的（500）请求，它们的耗时一定会有差别，因为<strong>正确的请求走完了全流程，而错误的可能只进行了某一部分流程，我们就需要把这两个请求的耗时在统计时分别记录</strong>。</p>
<p>在基础层中，我们可以监控 I&#x2F;O 等待、网络延迟等信息。在业务层中，则可以监控接口调用的耗时、MySQL 查询的耗时等信息。</p>
<p>延迟在系统中是一个十分关键的指标，很多时候我们的服务并不会产生错误，但很可能会有延迟，延迟在 HTTP 层会影响用户体验，在数据库中出现高延迟会导致请求错误，这是我们需要着重关注的。</p>
</li>
<li><p>流量</p>
<p>流量是表现系统负载情况的数据，比如我们常见的 QPS、UV。通过这个指标我们能确切了解到服务当前承受了多大的压力，请求量和处理量有多大。我们常说的容量规划，其实是流量规划。通过流量，我们可以得知当前系统运行的状况，是否到达了它的负荷上限。</p>
<p>在基础层中，常见的监控指标有磁盘的读写速度、网络 I&#x2F;O 情况等。在业务层中则有请求量、MySQL 查询次数等等。</p>
<p>通过观察流量相关的指标，可以了解到是否存在突增突降的情况，从而判断是否遭受到了攻击或者是否在进行某些活动。</p>
</li>
<li><p>饱和度</p>
<p>饱和度通常是指某个资源的使用率。通常指的是我们通过容量的最大值和现在的使用量，来判断这个容量是否“满”了。某些程序，如果资源饱和度过高，可能会导致执行缓慢，甚至无法使用。比如 CPU 使用率如果达到 100%，会出现执行缓慢。</p>
<p>饱和度一般也会配合其他指标一起使用，比如在使用网络 I&#x2F;O 时，网卡都是有流量上限的，我们通过流量上限值和当前网络 I&#x2F;O 的使用情况，可以得知相应的饱和度。饱和度是衡量我们这个系统是否到达瓶颈的关键。如饱和度过高，这时候就需要考虑扩容、减少数据量或是其他降低饱和度的操作了。</p>
<p>在基础层中，需要监控的指标有 CPU 使用率、I&#x2F;O 使用率、句柄使用情况等。在业务层中则会有线程池的线程使用数、JVM 中的堆内存使用率等信息。</p>
</li>
</ul>
<h3 id="Prometheus架构"><a href="#Prometheus架构" class="headerlink" title="Prometheus架构"></a>Prometheus架构</h3><p><a href="/../pic/z6cqx.png" title="Prometheus architecture" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/z6cqx.png" alt="Prometheus architecture"></a></p>
<p>宏观来说，Prometheus的架构可以分为三段式：</p>
<ul>
<li><p>上游的负责采集监控指标的的组件</p>
<p>prometheus server配置中的一个个监控目标target，包括kubernetes中运行的服务和它本身的一些组件、基于文件的自动发现、各种exporter服务、Pushgateway等</p>
</li>
<li><p>中游负责保存数据的组件</p>
<ul>
<li>Retrieval：对接上游，周期性去上游的监控目标target里拉取监控数据</li>
<li>TSDB：按照时序存储数据</li>
<li>HTTP server: 对下游暴漏访问TSDB的接口</li>
</ul>
</li>
<li><p>下游负责使用数据的组件</p>
<ul>
<li>Altermanager： 接口prometheus推送过来的报警信息，然后发送给不同的报警媒介</li>
<li>Grafana：负责出图</li>
</ul>
</li>
</ul>
<h2 id="Prometheus监控实践"><a href="#Prometheus监控实践" class="headerlink" title="Prometheus监控实践"></a>Prometheus监控实践</h2><h3 id="部署Prometheus"><a href="#部署Prometheus" class="headerlink" title="部署Prometheus"></a>部署Prometheus</h3><blockquote>
<p><strong>storage.yaml</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage</span><br><span class="line">provisioner: kubernetes.io/no-provisioner</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-local</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  local:</span><br><span class="line">    path: /data/k8s/prometheus</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">            - key: kubernetes.io/hostname</span><br><span class="line">              operator: In</span><br><span class="line">              values:</span><br><span class="line">                - k8s-master-01</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-data</span><br><span class="line">  namespace: monitor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line">  storageClassName: local-storage</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>configmap.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s # Prometheus每隔15s就会从所有配置的目标端点抓取最新的数据</span></span><br><span class="line"><span class="string">      scrape_timeout: 15s  # 某个抓取操作在 15 秒内未完成，会被视为超时，不会包含在最新的数据中。</span></span><br><span class="line"><span class="string">      evaluation_interval: 15s #  # 每15s对告警规则进行计算</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">      - job_name: &quot;prometheus&quot;</span></span><br><span class="line"><span class="string">        static_configs:</span></span><br><span class="line"><span class="string">        - targets: [&quot;localhost:9090&quot;]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>deployment.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">securityContext:</span>  <span class="comment"># 增加这一段</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">harbor.in-road.com/dengjinjun/prometheus:2.53.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span> <span class="comment"># 指定tsdb数据路径</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.retention.time=24h&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-admin-api&#x27;</span> <span class="comment"># 控制对admin HTTP API的访问，其中包括删除时间序列等功能</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-lifecycle&#x27;</span> <span class="comment"># 支持热更新，直接执行localhost:9090/-/reload立即生效</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/prometheus&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/prometheus&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">prometheus-data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/control-plane&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>prometheus-rdbc.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;extensions&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> <span class="comment"># 用来对非资源型 metrics 进行操作的权限声明</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span> <span class="comment"># 由于我们要获取的资源信息，在每一个 namespace 下面都有可能存在，所以我们这里使用的是 ClusterRole 的资源对象</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure>

<h3 id="物理节点的监控"><a href="#物理节点的监控" class="headerlink" title="物理节点的监控"></a>物理节点的监控</h3><p>通过在物理节点上安装node exporter，然后在prometheus配置文件中添加监控项来实现</p>
<blockquote>
<p><strong>node-exporter.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 由于我们要获取到的数据是主机的监控指标数据，而我们的 node-exporter 是运行在容器中的，</span></span><br><span class="line">      <span class="comment"># 所以我们必须确保在容器内可以看到宿主机上的一些状态信息，为此我们做了两件事</span></span><br><span class="line">      <span class="comment"># 第一：配置了如下三条Pod安全策略为true，确保在pod内可以访问到宿主机上的PID namespace、IPC namespace 以及主机网络</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 第二：将主机的 /dev、/proc、/sys这些目录挂载到容器中，物理节点的很多数据都在这些目录中</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/proc</span>  <span class="comment"># top命令查看到的cpu状态就来自于/proc/stat, 命令free -h看到的内存状态就来自于/proc/meminfo</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">      <span class="comment"># 此外由于我们集群使用的是 kubeadm 搭建的，所以如果希望 master 节点也一起被监控，则需要添加相应的容忍</span></span><br><span class="line">      <span class="comment"># 下面这条容忍设置的含义是：无论节点上存在何种 Taints，该 Pod 都会容忍这些 Taints，从而能够分布到所有节点上。</span></span><br><span class="line">      <span class="comment"># 这是确保监控工具 DaemonSet 可被部署到 Kubernetes 集群所有节点上的常见做法。</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&#x27;Exists&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 我们所有节点都有这个标签</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">harbor.in-road.com/dengjinjun/node-exporter:1.3.1</span></span><br><span class="line">          <span class="attr">args:</span> <span class="comment"># 选项定制详见：https://github.com/prometheus/node_exporter</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.listen-address=$(HOSTIP):9100</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.procfs=/host/proc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.sysfs=/host/sys</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.rootfs=/host/root</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.hwmon</span> <span class="comment"># 禁用不需要的一些采集器</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nfs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nfsd</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nvme</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.dmi</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.arp</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/containerd/.+|/var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)$</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOSTIP</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">65534</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/proc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/sys</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/root</span></span><br><span class="line">              <span class="attr">mountPropagation:</span> <span class="string">HostToContainer</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>prometheus.yml</strong></p>
</blockquote>
<p>这里添加监控项有两种方式，一种是手动添加静态监控项，另一种是配置动态发现</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加静态监控项，一般用于kubernetes之外的物理节点</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;node-exporter&quot;</span>  </span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;10.100.183.5:9100&quot;</span>,<span class="string">&quot;10.100.183.6:9100&quot;</span>,<span class="string">&quot;10.100.183.7:9100&quot;</span>,<span class="string">&quot;10.100.183.8:9100&quot;</span>,<span class="string">&quot;10.100.183.10:9100&quot;</span>,<span class="string">&quot;10.100.183.13:9100&quot;</span>] </span><br><span class="line">        </span><br><span class="line"><span class="comment"># 配置自动发现，一般用于kubernetes之内的物理节点</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;nodes&#x27;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]  <span class="comment"># 获取到地址</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">&#x27;(.*):10250&#x27;</span> <span class="comment"># 用正则regex匹配上面获取到的地址，(.*)获取到的是ip地址部分，加括号代表存入一个正则分组</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">&#x27;$&#123;1&#125;:9100&#x27;</span> <span class="comment"># 取出上面正则分组的内容即ip地址，然后后面拼一个9100端口，即完成端口替换</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__address__</span> <span class="comment"># 替换的目标</span></span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span>           <span class="comment"># 动作为replace</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span> <span class="comment"># 增加</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="comment"># 在kubernetes内的节点，还可以添加kubelet的自动发现，可以拿到kubelet提供的默认接口：https://node_ip:10250/metrics提供的物理节点相关的信息  </span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubelet&#x27;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span>            </span><br></pre></td></tr></table></figure>

<h3 id="集群中的组件"><a href="#集群中的组件" class="headerlink" title="集群中的组件"></a>集群中的组件</h3><p>组件信息和集群中资源的信息，一般都自带了metrics接口，可以通过添加静态target或者动态发现，都是在<code>prometheus.yaml</code>中配置的</p>
<blockquote>
<p><strong>添加物理节点上容器的监控项</strong></p>
</blockquote>
<p>添加容器相关信息，一般容器都是通过cadvisor来获取信息的，现在cadvisor会集成在kubelet组件中，所以本质上也还是通过kubelet提供的接口实现的，不过跟上面kubelet不同的是，容器相关的信息用的是另外一个接口：<a target="_blank" rel="noopener" href="https://node_ip:10250/metrics/cadvisor">https://node_ip:10250/metrics/cadvisor</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-cadvisor&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">/metrics/cadvisor</span> <span class="comment"># &lt;nodeip&gt;/metrics -&gt; &lt;nodeip&gt;/metrics/cadvisor</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path_</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>添加apiserver的监控项</strong></p>
</blockquote>
<p>这些以集群内Pod运行的系统组件都需要通过svc来访问，apiserver是有一个svc的，在默认的命名空间下，通过<code>kubectl get ep</code>可以看到其endpoint。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>,<span class="string">__meta_kubernetes_service_name</span>,<span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>添加controller-manager的监控项</strong></p>
</blockquote>
<p>Pod的IP是不固定的，controller-manager默认没有svc，需要先创建一个svc，给prometheus访问。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https-metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">10257</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">10257</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-controller-manager</span></span><br></pre></td></tr></table></figure>

<p>在<code>/etc/kubernetes/manifest</code>目录下各个组件的配置文件中可以看到，<code>--bind-address=127.0.0.1</code>，说明每台机器上的组件默认都是监听本机地址的，需要把这个地址改为<code>0.0.0.0</code>，更改之后kubelet会自动重启它们。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-controller-manager&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>,<span class="string">__meta_kubernetes_service_name</span>,<span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">kube-system;kube-controller-manager;https-metrics</span></span><br></pre></td></tr></table></figure>

<p>类似的原理，添加<code>kube-scheduler</code>的监控也是一样的，不在赘述</p>
<blockquote>
<p><strong>添加etcd的监控项</strong></p>
</blockquote>
<p>etcd跟上面两个有一些不同之处，一是它是http协议访问的</p>
<p>etcd-svc.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">etcd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">2381</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">2381</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<p>二是它监听地址的配置是<code>--listen-metrics-urls=http://127.0.0.1:2381</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;etcd&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">kube-system;etcd;http</span></span><br></pre></td></tr></table></figure>

<h3 id="业务Pod信息"><a href="#业务Pod信息" class="headerlink" title="业务Pod信息"></a>业务Pod信息</h3><p>k8s中运行的服务，如果没有自带&#x2F;metrics接口，比如Redis、MySQL，这类需要在Pod中使用sidecar模式启动exporter容器来实现，并且这个sidecar容器需要能被prometheus自动发现并访问。</p>
<p>综上，业务Pod的监控需要满足三个条件：</p>
<ol>
<li>具备&#x2F;metrics接口</li>
<li>具备svc，svc生成的endpoint能被prometheus访问到</li>
<li>svc需要具备一些注解或标签，以便于promtheus筛选，比如：<code>prometheus.io/scrape:true</code></li>
</ol>
<p>以coredns为例，三个条件都已经满足，下面是promtheus配置文件的补充内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-endpoints&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="comment"># 1、匹配元数据__meta_kubernetes_service_annotation_prometheus_io_scrape包含&quot;true&quot;的留下</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 2、__meta_kubernetes_service_annotation_prometheus_io_scheme的值中包含0或1个https，则改名为__scheme__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">  <span class="comment"># 3、__meta_kubernetes_service_annotation_prometheus_io_path的值至少有一个任意字符，则改名为__metrics_path__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span>            </span><br><span class="line">  <span class="comment"># 4、提取ip与port拼接到一起格式为: 1.1.1.1:3333，然后赋值给新label名：__address__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span> <span class="comment"># RE2 正则规则，+是一次多多次，?是0次或1次，其中?:表示非匹&gt;配组(意思就是不获取匹配结果)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1:$2</span>        </span><br><span class="line">  <span class="comment"># 5、添加标签</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span>         </span><br><span class="line">  <span class="comment"># 6、名称空间标签替换为kubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span>          </span><br><span class="line">  <span class="comment"># 7、服务名替换为kubernetes_name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_name</span>        </span><br><span class="line">  <span class="comment"># 8、pod名替换为kubernetes_pod_name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></table></figure>

<h3 id="集群状态信息"><a href="#集群状态信息" class="headerlink" title="集群状态信息"></a>集群状态信息</h3><p>上述监控在各个维度上提供了相应资源的监控项，但是并不完善，因为kubernetes集群中还有一些资源状态信息需要被收集和监控，比如：</p>
<ul>
<li>某个业务Pod当前的副本数量是多少，有多少个是可用的</li>
<li>处于running&#x2F;stopping&#x2F;terminated状态的Pod有多少</li>
<li>Pod重启了多少次</li>
<li>有多少个Job在等待运行</li>
</ul>
<p>无论是apiserver、cadvisor，还是业务Pod暴露的metrics信息，都无法提供上述指标，所以我们需要一种新的exporter，来提供全局的状态指标：<code>kube-state-metrics</code></p>
<p>注意：<code>kube-state-metrics</code>与<code>metrics</code>并不相同，虽然它们都是用于监控指标的收集，但是<code>metrics-server</code>提供实时的资源监控指标，更多的是给HPA做决策，不擅长做历史数据分析；而<code>kube-state-metrics</code>更擅长做这件事，对接Prometheus提供历史数据分析。</p>
<p>部署</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kube-state-metrics.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压并进入目录</span></span><br><span class="line">unzip kube-state-metrics-main.zip </span><br><span class="line"><span class="built_in">cd</span> kube-state-metrics-main/examples/standard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在service.yaml文件中添加注解：prometheus.io/scrape: &quot;true&quot;，然后把镜像换成国内可用的，部署即可</span></span><br><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure>



<h2 id="PromQL语法与Grafana出图"><a href="#PromQL语法与Grafana出图" class="headerlink" title="PromQL语法与Grafana出图"></a>PromQL语法与Grafana出图</h2><h3 id="PromQL语法"><a href="#PromQL语法" class="headerlink" title="PromQL语法"></a>PromQL语法</h3><p>prometheus监控中对于采集过来的数据统一称为metrics数据。总体上来说metrics是对采集过来的数据的一种统称。</p>
<p>metrics数据分为以下几种类型：</p>
<ul>
<li>Gauge：最简单的度量指标，只有一个简单的返回值（瞬时状态），比如当前的cpu使用率，内存使用率，磁盘使用率，温度等，这种就是Gauge类型的代表。</li>
<li>Counter：Counters就是计数器，它的统计数据是递增的，比如http请求的总数，出现的错误总数，总的处理时间，api请求数等</li>
<li>Histograms：统计在一定的时间范围内数据的分布情况，还提供度量指标的总和，数据以直方图显示。其主要用于表示一段时间内对数据的采样，并能够对其指定区间及总数进行统计。根据统计区间计算。如请求的持续&#x2F;延长时间，请求的响应大小等。</li>
<li>Summary：类似Histogram，用于表示一段时间内数据采样结果，其直接存储quantile数据，而不是根据统计区间计算出来的。不需要计算，直接存储结果。</li>
</ul>
<p>PromQL是Prometheus实现监控查询的核心功能，通过PromQL，用户可以非常方便地对监控样本数据进行统计分析，PromQL支持常见的运算操作符，同时PromQL中还提供了大量的内置函数可以实现对数据的高级处理。</p>
<p>下面是集中常见的PromQL查询语法：</p>
<h4 id="标签匹配查询"><a href="#标签匹配查询" class="headerlink" title="标签匹配查询"></a>标签匹配查询</h4><p>最简单的查询方式，Prometheus通过指标名称和标签唯一定义一条时间序列进行查询。</p>
<p>比如想要查询CPU总的使用时间，可以输入指标名称<code>node_cpu_seconds_total</code>，可以看到出现的metrics项</p>
<p><a target="_blank" rel="noopener" href="https://dengjinjun.site/pic/image-20240401190302326.png"><a href="/../pic/image-20240401190302326.png" title="image-20240401190302326" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240401190302326.png" alt="image-20240401190302326"></a></a></p>
<p>如果想要查询更详细的维度，比如CPU在内核态的使用时间，可以使用标签，即在指标名称后追加<code>&#123;mode=&quot;system&quot;&#125;</code></p>
<p><a target="_blank" rel="noopener" href="https://dengjinjun.site/pic/image-20240401190717919.png"><a href="/../pic/image-20240401190717919.png" title="image-20240401190717919" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240401190717919.png" alt="image-20240401190717919"></a></a></p>
<p>使用技巧：</p>
<ol>
<li>在使用标签查询时，可以添加多个标签，比如<code>node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;system&quot;&#125;</code></li>
<li>在使用标签查询时，可以使用<code>=</code>和<code>!=</code>，比如<code>node_cpu_seconds_total&#123;mode=&quot;system&quot;&#125;</code>，不看内核态的时间</li>
<li>除了完全匹配外，还可以使用正则表达式，匹配符号使用<code>=~</code>模糊匹配，使用<code>!~</code>表示反向模糊匹配</li>
<li>使用正则表达式的时候，在标签的值里面使用<code>|</code>表示逻辑或，比如<code>node_cpu_seconds_total&#123;mode=~&quot;system|nice&quot;&#125;</code></li>
<li>上面几个例子查询到的都是瞬时向量，可以在查询表达式后面添加<code>[1m]</code>，查询1分钟内所有样本数据，此时查询到的是区间向量。</li>
</ol>
<h4 id="二元操作"><a href="#二元操作" class="headerlink" title="二元操作"></a>二元操作</h4><p>二元操作符包括：数学运算符，逻辑运算符，布尔运算符</p>
<blockquote>
<p><strong>数学运算</strong></p>
</blockquote>
<p>PromQL支持对查询到的数据进行数学运算，对结果进行二次加工。</p>
<ul>
<li><code>+</code> (加法)</li>
<li><code>-</code> (减法)</li>
<li><code>*</code> (乘法)</li>
<li><code>/</code> (除法)</li>
<li><code>%</code> (求余)</li>
<li><code>^</code> (幂运算)</li>
</ul>
<p>比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以 MB 为单位显示空闲内存</span></span><br><span class="line">node_memory_MemFree_bytes / (1024 * 1024)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展示主机磁盘的I/O总量</span></span><br><span class="line">node_disk_written_bytes_total + node_disk_read_bytes_total</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>布尔运算</strong></p>
</blockquote>
<p>PromQL支持对查询到的数据的值进行布尔运算，对结果进行过滤。</p>
<p>另外，使用bool修改符后，布尔运算不会对结果进行过滤，而是将各个样本的数据与标量进行比较，得出结果0或1</p>
<ul>
<li><code>==</code> (相等)</li>
<li><code>!=</code> (不相等)</li>
<li><code>&gt;</code> (大于)</li>
<li><code>&lt;</code> (小于)</li>
<li><code>&gt;=</code> (大于等于)</li>
<li><code>&lt;=</code> (小于等于)</li>
<li><code>bool</code>(布尔修饰符，需要结合其他布尔符号使用)</li>
</ul>
<p>比如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CPU运行时间大于10s的监控项数据</span></span><br><span class="line">node_cpu_seconds_total &gt; 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查内存使用率大于90%的机器</span></span><br><span class="line">(node_memory_MemTotal_bytes - node_memory_MemFree_bytes)/node_memory_MemTotal_bytes &gt; 0.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查的HTTP请求量是否超过1000，如果大于1000则返回1，否则返回0</span></span><br><span class="line">http_requests_total &gt; bool 1000</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>集合运算符</strong></p>
</blockquote>
<p>PromQL支持两个瞬时向量之间的操作，可以在两个瞬时向量之间进行相应的集合操作，产生一个新的向量</p>
<ul>
<li><code>and</code> (并且)</li>
<li><code>or</code> (或者)</li>
<li><code>unless</code> (排除)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vector1 and vector2 会产生一个新的向量，新向量包含vector1中完全匹配vector2中的元素组成</span><br><span class="line">vector1 or vector2 会产生一个新的向量，新向量包含vector1和vector2中所有的样本数据</span><br><span class="line">vector1 unless vector2 会产生一个新的向量，新向量由vector1中没有与vector2匹配的元素组成</span><br></pre></td></tr></table></figure>

<h4 id="聚合操作"><a href="#聚合操作" class="headerlink" title="聚合操作"></a>聚合操作</h4><p>聚合操作符作用于瞬时向量，可以将瞬时表达式返回的样本数据进行聚合，形成一个新的时间序列。</p>
<p>Prometheus提供了下列内置的聚合操作符：</p>
<ul>
<li><code>sum ()</code>求和</li>
<li><code>min ()</code>最小值</li>
<li><code>max()</code> 最大值</li>
<li><code>avg()</code> 平均值</li>
<li><code>stddev()</code> 标准差</li>
<li><code>stdvar()</code> 标准方差</li>
<li><code>count()</code> 计数</li>
<li><code>count_values()</code> 对value进行计数</li>
<li><code>bottomk()</code> 后n条时序</li>
<li><code>topk()</code> 前n条时序</li>
<li><code>quantile()</code> 分位数</li>
<li><code>by()</code>分组</li>
</ul>
<p>聚合操作的语法如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 求和</span></span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total)		<span class="comment"># CPU运行总时间</span></span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total)by(cpu)		<span class="comment"># 按照cpu分组</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计数，统计返回了多少条数据</span></span><br><span class="line">count(node_cpu_seconds_total)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计前n条时序和后n条时序</span></span><br><span class="line">topk(3, <span class="built_in">sum</span>(node_cpu_seconds_total)  by (mode))		<span class="comment"># CPU运行时间按模式分组，统计前三组</span></span><br><span class="line">bottomk(3, <span class="built_in">sum</span>(node_cpu_seconds_total)  by (mode))		<span class="comment"># CPU运行时间按模式分组，统计前三组</span></span><br></pre></td></tr></table></figure>

<h4 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h4><p>此处介绍三个内置函数，用于区间向量</p>
<ul>
<li><code>increase()</code>增长量</li>
<li><code>rate()</code>增长率</li>
<li><code>irate()</code>瞬时增长率</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">increase() 函数中的参数是一个区间向量，increase函数获取区间向量中的第一个后最后一个样本并返回其增长量。因此，可以通过以下表达式计算CPU运行指标的平均每秒增长率：increase(node_cpu_seconds_total[2m])/120</span><br><span class="line"></span><br><span class="line">rate()函数可以直接计算区间向量在时间窗口内平均增长速率。因此，通过下面的表达式可以得到与上面increase函数相同的结果：rate(node_cpu_seconds_total[2m])</span><br><span class="line"></span><br><span class="line">需要注意的是,使用rate()或者increase()函数去计算样本的平均增长速率，容易陷入“长尾问题”，即无法反应在时间窗口内样本数据的突发变化。 例如，对于主机而言在2分钟的时间窗口内，可能在某一个由于访问量或者其它问题导致CPU占用100%的情况，但是计算时间窗口内的平均增长率却无法反应出该问题。为了解决该问题，PromQL提供了另外一个灵敏度更高的函数irate()， irate函数是通过区间向量中最后两个样本数据来计算区间向量的增长速率，所以可以近似反映瞬时增长率：irate(node_cpu_seconds_total[2m])</span><br><span class="line"></span><br><span class="line">总结：rate适用于增长趋势稳定的场景; irate适用于指标时刻发生剧烈变化的场景</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># author: Jason Yin</span></span><br><span class="line"></span><br><span class="line">INSTANCE=`hostname -s`</span><br><span class="line"></span><br><span class="line">DOCKER_NAMES=`docker -H docker-server ps --format <span class="string">&quot;&#123;&#123;.Names&#125;&#125;&quot;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算单个容器的运行时间</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_runtime</span></span>()&#123;</span><br><span class="line">    start_time=`docker -H docker-server inspect -f <span class="string">&#x27;&#123;&#123;.State.StartedAt&#125;&#125;&#x27;</span> <span class="variable">$1</span>`</span><br><span class="line">    start_time_stamp=`<span class="built_in">date</span> +%s -d <span class="string">&quot;<span class="variable">$start_time</span>&quot;</span>`</span><br><span class="line">    now=`<span class="built_in">date</span> +%s`</span><br><span class="line">    <span class="built_in">let</span> run_time=<span class="variable">$now</span>-<span class="variable">$start_time_stamp</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$run_time</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$run_time</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span><span class="string">&quot;# HELP docker_runtime time sec</span></span><br><span class="line"><span class="string"># TYPE docker_runtime gauge</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span> &gt; temp.log</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;DOCKER_NAMES&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    runtime=`get_runtime <span class="variable">$i</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;docker_runtime&#123;name=\&quot;<span class="variable">$i</span>\&quot;&#125; <span class="variable">$runtime</span>&quot;</span> &gt;&gt; temp.log</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">curl --data-binary <span class="string">&quot;@temp.log&quot;</span> http://192.168.110.155:9091/metrics/job/pushgateway/instance/<span class="variable">$INSTANCE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -f temp.log</span><br></pre></td></tr></table></figure>

<h3 id="Grafana出图"><a href="#Grafana出图" class="headerlink" title="Grafana出图"></a>Grafana出图</h3><p>安装grafana，然后可以使用grafana社区中提供的在线模板，也可以把模板下载下来，修改其中的PromQL语句再添加到自己的dashboard，更进一步，可以自己创建dashboard，自己编写业务相关的PromQL语句。</p>
<p>不再赘述。</p>
<h2 id="Altermanager告警"><a href="#Altermanager告警" class="headerlink" title="Altermanager告警"></a>Altermanager告警</h2><h3 id="部署Alertmanager"><a href="#部署Alertmanager" class="headerlink" title="部署Alertmanager"></a>部署Alertmanager</h3><p><code>alertmanager-config.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alert-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">template_email.tmpl:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &#123;&#123; define &quot;email.html&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;</span></span><br><span class="line"><span class="string">        @报警&lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- range .Alerts &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;实例:&lt;/strong&gt; &#123;&#123; .Labels.instance &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;概述:&lt;/strong&gt; &#123;&#123; .Annotations.summary &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;详情:&lt;/strong&gt; &#123;&#123; .Annotations.description &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;时间:&lt;/strong&gt; &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- end -&#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- end &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span></span><br><span class="line"><span class="string">        @恢复&lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- range .Alerts &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;实例:&lt;/strong&gt; &#123;&#123; .Labels.instance &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;信息:&lt;/strong&gt; &#123;&#123; .Annotations.summary &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;恢复:&lt;/strong&gt; &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- end -&#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- end &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">config.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    templates:  # 增加 templates 配置，指定模板文件</span></span><br><span class="line"><span class="string">    - &#x27;/etc/alertmanager/template_email.tmpl&#x27;</span></span><br><span class="line"><span class="string">    inhibit_rules:</span></span><br><span class="line"><span class="string">      - source_match:</span></span><br><span class="line"><span class="string">          alertname: NodeMemoryUsage  </span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        target_match:</span></span><br><span class="line"><span class="string">          severity: normal</span></span><br><span class="line"><span class="string">        equal:</span></span><br><span class="line"><span class="string">          - instance </span></span><br><span class="line"><span class="string">    # 一、全局配置</span></span><br><span class="line"><span class="string">    global:		</span></span><br><span class="line"><span class="string">      resolve_timeout: 5m  </span></span><br><span class="line"><span class="string">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span></span><br><span class="line"><span class="string">      smtp_from: &#x27;18611453110@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_username: &#x27;18611453110@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_password: &#x27;YKQQBTNSCEXOONLH&#x27;</span></span><br><span class="line"><span class="string">      smtp_hello: &#x27;163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_require_tls: false</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">    # 二、设置报警的路由分发策略</span></span><br><span class="line"><span class="string">    route:</span></span><br><span class="line"><span class="string">      group_by: [&#x27;alertname&#x27;, &#x27;cluster&#x27;]</span></span><br><span class="line"><span class="string">      group_wait: 30s</span></span><br><span class="line"><span class="string">      group_interval: 30s</span></span><br><span class="line"><span class="string">      repeat_interval: 120s</span></span><br><span class="line"><span class="string">      receiver: default 	# 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="attr">routes:</span> 	</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">email</span> </span><br><span class="line">        <span class="attr">group_wait:</span> <span class="string">10s</span>  </span><br><span class="line">        <span class="attr">group_by:</span> [<span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line">        <span class="attr">match:</span> 	</span><br><span class="line">          <span class="attr">team:</span> <span class="string">node</span> 	</span><br><span class="line">        <span class="attr">continue:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">mywebhook</span></span><br><span class="line">        <span class="attr">group_wait:</span> <span class="string">10s</span> </span><br><span class="line">        <span class="attr">group_by:</span> [<span class="string">&#x27;instance&#x27;</span>] </span><br><span class="line">        <span class="attr">match:</span></span><br><span class="line">          <span class="attr">team:</span> <span class="string">node</span></span><br><span class="line">    <span class="comment"># 三、定义接收器，与上面的路由定义中引用的receiver相呼应</span></span><br><span class="line">    <span class="attr">receivers:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">      <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;378533872@qq.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span>         </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;email&#x27;</span></span><br><span class="line">      <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;18611453110@163.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">html:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; template &quot;email.html&quot; . &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;mywebhook&#x27;</span></span><br><span class="line">      <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://promoter:8080/dingtalk/webhook1/send&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># alertmanager-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertcfg</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">alert-config</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">          <span class="comment">#image: prom/alertmanager:v0.27.0 搞成国内的地址</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/egon-k8s-test/alertmanager:v0.27.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/alertmanager/config.yml&#x27;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9093</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/alertmanager&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">alertcfg</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># alertmanager-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<h3 id="Alert配置优化"><a href="#Alert配置优化" class="headerlink" title="Alert配置优化"></a>Alert配置优化</h3><blockquote>
<p><strong>报警规则</strong></p>
</blockquote>
<p>报警指标是由promtheus通过计算得到，所以promtheus的配置文件需要有所改动：</p>
<p><code>promtheus.yml</code>增加以下内容，对接alertmanager：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">alertmanager:9093</span> </span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules.yml</span> </span><br></pre></td></tr></table></figure>

<p>增加一个<code>rules.yml</code>文件，挂载到<code>/etc/prometheus/rules.yml</code>中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  groups:</span></span><br><span class="line"><span class="string">  - name: recording_rules</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">    - record: job:node_memory_MemFree_bytes:percent</span></span><br><span class="line"><span class="string">      expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100</span></span><br><span class="line"><span class="string">  - name: test-node-mem</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">    - alert: NodeMemoryUsage  </span></span><br><span class="line"><span class="string">      expr: job:node_memory_MemFree_bytes:percent &gt; 20</span></span><br><span class="line"><span class="string">      for: 2m</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        team: node</span></span><br><span class="line"><span class="string">        severity: critical</span></span><br><span class="line"><span class="string">      annotations:</span></span><br><span class="line"><span class="string">        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: High Memory usage detected&quot;</span></span><br><span class="line"><span class="string">        description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 20% (current value is: &#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">  - name: test-node-load</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">      - alert: NodeLoad</span></span><br><span class="line"><span class="string">        expr: node_load5 &lt; 1  # 故意设置这个值，让它报警，正常应该是超过某个值才报警，而不是小于</span></span><br><span class="line"><span class="string">        for: 2m</span></span><br><span class="line"><span class="string">        labels: </span></span><br><span class="line"><span class="string">          team: node</span></span><br><span class="line"><span class="string">          severity: normal</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &#x27;&#123;&#123; $labels.instance &#125;&#125;: Low node load deteched&#x27;</span></span><br><span class="line"><span class="string">          description: &#x27;&#123;&#123; $labels.instance &#125;&#125;: node load is below 1 (current value is: &#123;&#123; $value &#125;&#125;)&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>延迟报警</strong></p>
</blockquote>
<p>延迟告警机制，可以用于防止瞬间的、短暂的噪音引起不必要的告警，从而提高告警的质量和可用性。下面是三个重要的参数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当一个新的报警分组被创建后，需要等待至少 group_wait 时间来初始化通知</span></span><br><span class="line"><span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line"><span class="comment"># 短期聚合: group_interval 确保在短时间内，同一分组的多个告警将会合并/聚合到一起等待被发送，避免过于频繁的告警通知。</span></span><br><span class="line"><span class="attr">group_interval:</span> <span class="string">30s</span></span><br><span class="line"><span class="comment"># 长期提醒: repeat_interval确保长时间未解决的告警不会被遗忘，Alertmanager每隔一段时间定期提醒相关人员，直到告警被解决。实现中为快速显示效果设置为120s,一般是一小时或更久.</span></span><br><span class="line"><span class="attr">repeat_interval:</span> <span class="string">120s</span> </span><br></pre></td></tr></table></figure>

<p>上述三个参数的综合解释：</p>
<ol>
<li>当一个新的告警被创建时，等待至少 group_wait 时间来初始化通知，这种方式可以确保能有足够的时间为同一分组来获取&#x2F;累积多个警报，然后一起触发这个报警信息。</li>
<li>然后开始一个 group_interval 窗口(例如 30 秒)，在 group_interval 窗口内，任何新的同分组告警会被聚合到一起，但不会立即触发发送。到达短期聚合的时间点后，告警信息将一起发送。</li>
<li>长期聚合的窗口用于延迟原有为解决的告警信息，如果没有抵达 repeat_interval 的时间点，则原有未解决的报警不会重复发送，直到到达下一个 repeat_interval 时间点。</li>
</ol>
<blockquote>
<p><strong>分组合并</strong></p>
</blockquote>
<p>在复杂的监控系统中，告警规则可能非常多，分组合并的机制可以根据不同的服务、应用或功能模块进行分类，将多个告警输出合并为一个通知，减少告警通知的数量，避免告警风暴。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义用于告警分组的标签。当有多个告警消息有相同的 alertname 和 cluster 标签时，这些告警消息将会被聚合到同一个分组中</span></span><br><span class="line"><span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;cluster&#x27;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>静默</strong></p>
</blockquote>
<p>静默机制可以让一些监控报警在我们设定的时间内哑火&#x2F;闭嘴，不要让其一直发报警，静默的应用场景一般是在处理已知问题或维护期间，频繁触发并发送的报警信息十分烦人，可以对该报警进行静默设置。</p>
<p>静默是在alertmanager的管理界面中配置的。</p>
<blockquote>
<p><strong>抑制</strong></p>
</blockquote>
<p>某个告警触发后，与其相关的一些报警可能伴随着一齐触发，比如节点宕机了，会触发节点宕机的报警，该节点上的服务也都挂掉了也会触发一系列这些服务的故障报警，然而根因是节点宕机了，所以那些随之产生的报警项是无用的干扰项，应该加以抑制。</p>
<p>可以在promtheus的配置文件中添加抑制规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span>		<span class="comment"># 用于匹配那些触发了的告警规则中的标签</span></span><br><span class="line">      <span class="attr">alertname:</span> <span class="string">NodeMemoryUsage</span> 	<span class="comment"># 告警规则的名字，promethus自动添加的标签</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span>			<span class="comment"># 用于标记告警等级的标签</span></span><br><span class="line">    <span class="attr">target_match:</span>		<span class="comment"># 用来匹配那些需要被抑制的告警规则的标签</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">normal</span> 	</span><br><span class="line">    <span class="attr">equal:</span>				</span><br><span class="line">      <span class="bullet">-</span> <span class="string">instance</span>      <span class="comment"># instance也是警规则自带的标签，对应节点名。这里同一节点上的normal等级的告警会被抑制</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>告警恢复与通知</strong></p>
</blockquote>
<p>告警产生之后，需要给运维人员发送适当的通知，告警恢复之后，自然也需要告知相关人员系统告警状态已恢复。之所以把告警恢复与通知放到一块，是因为本质上，告警恢复机制也是通过告警状态的通知逻辑来实现的。</p>
<p>下面是定义的一个路由匹配规则和接收者</p>
<p>路由匹配，这是其中的一个子路由，继承父路由的所有属性，可以进行覆盖和更具体的规则匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">email</span>  			<span class="comment">#  匹配此子路由的告警将发送到的接收器，跟下面的接收者对应</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span>  			<span class="comment">#  等待时间，可覆盖父路由的</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;instance&#x27;</span>]		<span class="comment"># 根据instance做分组</span></span><br><span class="line">  <span class="attr">match:</span> 			<span class="comment"># 告警标签匹配条件，只有匹配到特定条件的告警才会应用该子路由规则。</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">node</span> 	<span class="comment"># 只有拥有 team=node 标签的告警才会路由到 email 接收器。</span></span><br><span class="line">  <span class="attr">continue:</span> <span class="literal">true</span>	<span class="comment"># 匹配到这个路由之后，允许继续向下匹配</span></span><br></pre></td></tr></table></figure>

<p>接收者的定义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;email&#x27;</span>		<span class="comment"># 跟上面的路由匹配中定义的receiver对应</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;378533872@qq.com&#x27;</span></span><br><span class="line">    <span class="attr">html:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; template &quot;email.html&quot; . &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">send_resolved:</span> <span class="literal">true</span>  <span class="comment"># 告警状态恢复时，是否发送通知</span></span><br></pre></td></tr></table></figure>

<p>Promtheus中的告警规则有两个状态：<code>alerting</code> 和 <code>resolved</code>。在上面的告警规则中，关键字<code>for</code>的值是2m，代表当告警条件<code>expr</code>在定义的持续时间内保持为<code>true</code>时，告警触发，告警状态变为<code>alerting</code>，会给alertmanager发送告警状态，在alertmanager中，有一个参数<code>resolve_timeout: 5m</code> ，代表当alertmanager持续多长时间未接收到告警后，标记告警状态为 <code>resolved</code>，即恢复状态。</p>
<blockquote>
<p><strong>定制模板</strong></p>
</blockquote>
<p>减少无用信息，突出重点信息，增强可读性，美观。</p>
<p>下面是在alertmanager中定义的一个邮件模板，<code>template_email.tmpl</code>，作为一个文件单独挂载，可以在receivers中通过自定义的名字<code>email.html</code>被指定</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">template_email.tmpl: |-</span><br><span class="line">  &#123;&#123; define &quot;email.html&quot; &#125;&#125;</span><br><span class="line">  &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class="line">      @报警<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- range .Alerts &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>实例:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Labels.instance &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>概述:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Annotations.summary &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>详情:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Annotations.description &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>时间:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- end -&#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class="line">      @恢复<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- range .Alerts &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>实例:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Labels.instance &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>信息:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Annotations.summary &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>恢复:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- end -&#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>性能优化</strong></p>
</blockquote>
<p>当Promtheus中的告警规则过多时，不可避免的会增大系统开销，所以性能优化也是需要注意的一个点。</p>
<p>基于Recording Rule机制，可以把多条报警规则里共用的表达式提取出来，由prometheus server周期性计算、计算的结果当成一个指标&#x2F;时序数据存放下来，如此，其他的报警规则直接共用该现成的结果即可，避免重复的计算的开销。</p>
<p>下面是一个Recording Rule机制的例子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">recording_rules</span></span><br><span class="line">      <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">job:node_memory_MemFree_bytes:percent</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(node_memory_MemTotal_bytes</span> <span class="bullet">-</span> <span class="string">(node_memory_MemFree_bytes</span> <span class="string">+</span> <span class="string">node_memory_Buffers_bytes</span> <span class="string">+</span> <span class="string">node_memory_Cached_bytes))</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes</span> <span class="string">*</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>上面的例子中，把复杂的表达式定义了一个新的名字<code>job:node_memory_MemFree_bytes:percent</code>，这个名字可以在其他告警规则中被引用，实现重用，并且还可以直接在Promtheus中使用这个名字代替PromQL语句查询。</p>
<h3 id="对接第三方OA软件"><a href="#对接第三方OA软件" class="headerlink" title="对接第三方OA软件"></a>对接第三方OA软件</h3><p>参考：<a target="_blank" rel="noopener" href="https://github.com/feiyu563/PrometheusAlert">https://github.com/feiyu563/PrometheusAlert</a></p>
<h2 id="Promethues-Operator自定义监控项与报警"><a href="#Promethues-Operator自定义监控项与报警" class="headerlink" title="Promethues Operator自定义监控项与报警"></a>Promethues Operator自定义监控项与报警</h2><p>​		<br>​	</p>
<h2 id="Promethues-Operator高级用法"><a href="#Promethues-Operator高级用法" class="headerlink" title="Promethues Operator高级用法"></a>Promethues Operator高级用法</h2></div><script src="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery) {
        var options1 = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-01-11</span>
            
                <span>该篇文章被 邓胖胖</span>
            
            
                <span>打上标签:
                    
                    
                        <a href='/tags/Prometheus/'>
                            Prometheus
                        </a>
                    
                </span>
             
             
                <span>归为分类:
                    
                    
                        <a href='/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/'>
                            学习笔记
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>上一篇：<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">上一篇：<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
             

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- 返回的按钮-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>