<!DOCTYPE html>
<html lang="en">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="Prometheusç›‘æ§å…¨è®²è§£" />
    <meta name="hexo-theme-A4" content="v1.9.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Dengpangpang</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Dengpangpang</a> 
            <span class="description"></span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">ğŸŸé¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">ğŸ“æ–‡ç« </a></li>
            
        
            
                <li><a href="/tags/">ğŸ·ï¸æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">ğŸ—‚ï¸åˆ†ç±»</a></li>
            
        
            
                <li><a href="/about/">ğŸ‘ï¸å…³äº</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            Prometheusç›‘æ§å…¨è®²è§£
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Prometheus%E7%9B%91%E6%8E%A7%E5%85%A8%E8%AE%B2%E8%A7%A3"><span class="post-toc-text">Prometheusç›‘æ§å…¨è®²è§£</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Prometheus%E7%9B%91%E6%8E%A7%E7%90%86%E8%AE%BA"><span class="post-toc-text">Prometheusç›‘æ§ç†è®º</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%BB%91%E7%9B%92%E7%9B%91%E6%8E%A7%E5%92%8C%E7%99%BD%E7%9B%92%E7%9B%91%E6%8E%A7"><span class="post-toc-text">é»‘ç›’ç›‘æ§å’Œç™½ç›’ç›‘æ§</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%BB%84%E9%87%91%E6%8C%87%E6%A0%87"><span class="post-toc-text">é»„é‡‘æŒ‡æ ‡</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Prometheus%E6%9E%B6%E6%9E%84"><span class="post-toc-text">Prometheusæ¶æ„</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E8%B7%B5"><span class="post-toc-text">Prometheusç›‘æ§å®è·µ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2Prometheus"><span class="post-toc-text">éƒ¨ç½²Prometheus</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%89%A9%E7%90%86%E8%8A%82%E7%82%B9%E7%9A%84%E7%9B%91%E6%8E%A7"><span class="post-toc-text">ç‰©ç†èŠ‚ç‚¹çš„ç›‘æ§</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="post-toc-text">é›†ç¾¤ä¸­çš„ç»„ä»¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%9A%E5%8A%A1Pod%E4%BF%A1%E6%81%AF"><span class="post-toc-text">ä¸šåŠ¡Podä¿¡æ¯</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF"><span class="post-toc-text">é›†ç¾¤çŠ¶æ€ä¿¡æ¯</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#PromQL%E8%AF%AD%E6%B3%95%E4%B8%8EGrafana%E5%87%BA%E5%9B%BE"><span class="post-toc-text">PromQLè¯­æ³•ä¸Grafanaå‡ºå›¾</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#PromQL%E8%AF%AD%E6%B3%95"><span class="post-toc-text">PromQLè¯­æ³•</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%A0%87%E7%AD%BE%E5%8C%B9%E9%85%8D%E6%9F%A5%E8%AF%A2"><span class="post-toc-text">æ ‡ç­¾åŒ¹é…æŸ¥è¯¢</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E4%BA%8C%E5%85%83%E6%93%8D%E4%BD%9C"><span class="post-toc-text">äºŒå…ƒæ“ä½œ</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C"><span class="post-toc-text">èšåˆæ“ä½œ</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="post-toc-text">å†…ç½®å‡½æ•°</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Grafana%E5%87%BA%E5%9B%BE"><span class="post-toc-text">Grafanaå‡ºå›¾</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Altermanager%E5%91%8A%E8%AD%A6"><span class="post-toc-text">Altermanagerå‘Šè­¦</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%83%A8%E7%BD%B2Alertmanager"><span class="post-toc-text">éƒ¨ç½²Alertmanager</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Alert%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="post-toc-text">Alerté…ç½®ä¼˜åŒ–</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AF%B9%E6%8E%A5%E7%AC%AC%E4%B8%89%E6%96%B9OA%E8%BD%AF%E4%BB%B6"><span class="post-toc-text">å¯¹æ¥ç¬¬ä¸‰æ–¹OAè½¯ä»¶</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Promethues-Operator"><span class="post-toc-text">Promethues Operator</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Promethues-Operator%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="post-toc-text">Promethues Operatoré«˜çº§ç”¨æ³•</span></a></li></ol></li></ol>
            
        
        <link rel="stylesheet" type="text/css" href="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/css/lightgallery.min.css" /><div class=".article-gallery"><h1 id="Prometheusç›‘æ§å…¨è®²è§£"><a href="#Prometheusç›‘æ§å…¨è®²è§£" class="headerlink" title="Prometheusç›‘æ§å…¨è®²è§£"></a>Prometheusç›‘æ§å…¨è®²è§£</h1><h2 id="Prometheusç›‘æ§ç†è®º"><a href="#Prometheusç›‘æ§ç†è®º" class="headerlink" title="Prometheusç›‘æ§ç†è®º"></a>Prometheusç›‘æ§ç†è®º</h2><h3 id="é»‘ç›’ç›‘æ§å’Œç™½ç›’ç›‘æ§"><a href="#é»‘ç›’ç›‘æ§å’Œç™½ç›’ç›‘æ§" class="headerlink" title="é»‘ç›’ç›‘æ§å’Œç™½ç›’ç›‘æ§"></a>é»‘ç›’ç›‘æ§å’Œç™½ç›’ç›‘æ§</h3><p>é»‘ç›’ç›‘æ§æŒ‡çš„æ˜¯ç›‘æ§å¤–éƒ¨ç”¨æˆ·å¯è§çš„ç³»ç»Ÿè¡Œä¸ºï¼Œç™½ç›’ç›‘æ§æŒ‡çš„æ˜¯ç›‘æ§å†…éƒ¨æš´éœ²å‡ºæ¥çš„æŒ‡æ ‡ä¿¡æ¯ã€‚å®ƒä»¬ä¸€ä¸ªå¯¹å¤–ï¼Œä¸€ä¸ªå¯¹å†…ã€‚äºŒè€…åœ¨åŠŸèƒ½ä¸Šæœ‰ 2 ç‚¹åŒºåˆ«ã€‚</p>
<ul>
<li>ç›‘æ§è§’åº¦ä¸åŒï¼šé»‘ç›’æ›´åå‘äºå¤–ä¾§ï¼Œä½ å¯ä»¥ç†è§£ä¸ºæ˜¯é€šè¿‡æŸä¸ªåŠŸèƒ½æˆ–è€…å…·ä½“çš„æŸä¸ªæ¥å£æ¥è§‚å¯Ÿï¼Œå®ƒå¹¶ä¸æ¸…æ¥šå†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼›è€Œç™½ç›’åˆ™æ›´å€¾å‘äºä»å†…ä¾§ç›‘æ§ï¼Œå®ƒæ˜¯ä»£ç å±‚é¢çš„ï¼Œä»å†…éƒ¨çš„è§†è§’æ¥è§£è¯»æ•´ä¸ªç³»ç»Ÿã€‚</li>
<li>é¢å‘å¯¹è±¡ä¸åŒï¼šé»‘ç›’æ›´å€¾å‘äºçœ‹åˆ°è¿™ä¸ªé—®é¢˜çš„ç°è±¡ï¼Œæ¯”å¦‚æŸä¸ªç«¯å£æŒ‚æ‰äº†æ— æ³•å†æä¾›æœåŠ¡ï¼Œå®ƒé¢å‘çš„æ˜¯å½“ä¸‹æ‰€å‘ç”Ÿçš„æ•…éšœï¼›ç™½ç›’åˆ™æ›´åŠ å€¾å‘äºé¢å‘äº§ç”Ÿé—®é¢˜çš„åŸå› ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨æ—¥å¿—ä¸­å¯ä»¥é€šè¿‡å †æ ˆä¿¡æ¯åˆ†æå‡ºæ•…éšœçš„æ ¹æºã€‚</li>
</ul>
<blockquote>
<p><strong>é»‘ç›’ç›‘æ§</strong></p>
</blockquote>
<p>é»‘ç›’ä¸­çš„ç›‘æ§ä¸€èˆ¬å¯ä»¥ç»†åˆ†ä¸ºå¦‚ä¸‹çš„ 4 ç±»å†…å®¹ã€‚</p>
<ul>
<li>ç«¯å£çŠ¶æ€ï¼šé€šè¿‡ç¨‹åºæ£€æµ‹å…·ä½“ä¸šåŠ¡çš„ç«¯å£æ˜¯å¦å­˜æ´»ã€‚å¯ä»¥ç®€å•ç¡®å®šç¨‹åºæ˜¯å¦æœ‰åœ¨æä¾›æœåŠ¡ï¼Œå¦‚æœç«¯å£éƒ½æ— æ³•è¿æ¥ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯ç³»ç»Ÿå‡ºç°äº†é—®é¢˜ã€‚é€šå¸¸æˆ‘ä»¬ä¹Ÿä¼šç»“åˆè¿›ç¨‹æ£€æµ‹ä½¿ç”¨ï¼Œå¦‚æœè¿›ç¨‹å­˜æ´»ï¼Œä½†æ˜¯ç«¯å£ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜å¯èƒ½ç¨‹åºå­˜åœ¨æŸäº›é—®é¢˜ï¼Œæ²¡æœ‰å°†æœåŠ¡æš´éœ²å‡ºæ¥ã€‚</li>
<li>è¯ä¹¦æ£€æµ‹ï¼šé€šè¿‡æ£€æµ‹è¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼Œç¡®è®¤ç”¨æˆ·æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®ã€‚ç°åœ¨çš„ç½‘ç«™æœåŠ¡åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨çš„ HTTPSï¼Œå¦‚æœè¯ä¹¦å‡ºç°äº†é—®é¢˜ï¼Œåˆ™å¯èƒ½æ˜¯æµè§ˆå™¨è®¤å®šä¸ºä¸å®‰å…¨ï¼Œé˜»æ­¢äº†ç”¨æˆ·è®¿é—®ã€‚</li>
<li>æ¢æ´»ï¼šé€šè¿‡å¿ƒè·³æ£€æµ‹æ¥åˆ¤å®šæœåŠ¡æ˜¯å¦å­˜æ´»ï¼Œæ¯”å¦‚å®šæœŸé€šè¿‡å…·ä½“çš„æŸä¸ªæ¥å£æ£€æµ‹æˆ‘ä»¬çš„æœåŠ¡æ˜¯å¦è¿è¡Œæ­£å¸¸ã€‚å¦‚æœåœ¨è¿™é‡Œå‡ºç°å¼‚å¸¸ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬çš„ç³»ç»Ÿå­˜åœ¨é—®é¢˜ã€‚</li>
<li>ç«¯åˆ°ç«¯åŠŸèƒ½æ£€æµ‹ï¼šè¿™ä¸ªå°±ç›¸å¯¹å¤æ‚ä¸€äº›ã€‚é€šå¸¸æ˜¯é€šè¿‡å®šæœŸè¿›è¡Œç«¯åˆ°ç«¯çš„æµ‹è¯•ï¼Œç»“åˆä¸šåŠ¡æµç¨‹æ„ŸçŸ¥ä¸šåŠ¡æ˜¯å¦åœ¨æ‰§è¡Œæ­£å¸¸ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ UI æˆ–è€…æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼Œæ¥ç¡®è®¤é¡µé¢ä¸­è¿”å›çš„æ•°æ®æˆ–è€…æ•°æ®æ˜¯å¦æ˜¯æ­£ç¡®çš„ã€‚</li>
</ul>
<blockquote>
<p><strong>ç™½ç›’ç›‘æ§</strong></p>
</blockquote>
<p>ç™½ç›’ç›‘æ§ä¸­é‡è¦çš„æ•°æ®ç»´åº¦ï¼š</p>
<ul>
<li>æ—¥å¿—ï¼šé€šè¿‡æ—¥å¿—è®°å½•å¯ä»¥äº†è§£åˆ°ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œç¨‹åºä¸­æ˜¯å¦å­˜åœ¨å¼‚å¸¸ã€‚</li>
<li>æŒ‡æ ‡ï¼šæ•°å€¼å½¢å¼çš„æŒ‡æ ‡å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£åˆ°ç³»ç»Ÿä¸­çš„æ•°æ®èµ°å‘ã€æµé‡æƒ…å†µç­‰ã€‚</li>
<li>é“¾è·¯è¿½è¸ªï¼šæˆ‘ä»¬å¯ä»¥ç»†ç²’åº¦åˆ°ç¨‹åºçš„ä»£ç è¡Œçº§åˆ«æ¥å°†é“¾è·¯å¯è§†åŒ–ï¼Œè¿™å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</li>
</ul>
<h3 id="é»„é‡‘æŒ‡æ ‡"><a href="#é»„é‡‘æŒ‡æ ‡" class="headerlink" title="é»„é‡‘æŒ‡æ ‡"></a><strong>é»„é‡‘æŒ‡æ ‡</strong></h3><p>é»„é‡‘æŒ‡æ ‡æ˜¯ Google é’ˆå¯¹å¤§é‡åˆ†å¸ƒå¼ç›‘æ§çš„ç»éªŒæ€»ç»“ï¼Œå®ƒå¯ä»¥åœ¨æœåŠ¡çº§åˆ«å¸®åŠ©è¡¡é‡ç»ˆç«¯ç”¨æˆ·ä½“éªŒã€æœåŠ¡ä¸­æ–­ã€ä¸šåŠ¡å½±å“ç­‰å±‚é¢çš„é—®é¢˜ï¼Œæœ‰ 4 ç±»æŒ‡æ ‡ä¿¡æ¯ï¼Œåˆ†ä¸º<strong>é”™è¯¯ã€å»¶è¿Ÿã€æµé‡å’Œé¥±å’Œåº¦</strong>ã€‚æ— è®ºä½ ç›‘æ§çš„æ•°æ®å†å¤æ‚ã€å†ä»¤äººçœ¼èŠ±ç¼­ä¹±ï¼Œéƒ½å¯ä»¥å¥—ç”¨åœ¨è¿™ 4 ç±»ä¸Šã€‚</p>
<ul>
<li><p>é”™è¯¯</p>
<p>é”™è¯¯æŒ‡çš„æ˜¯å½“å‰ç³»ç»Ÿæ‰€æœ‰å‘ç”Ÿè¿‡çš„é”™è¯¯è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é”™è¯¯è¯·æ±‚ä¸ªæ•°è®¡ç®—å‡ºç›¸åº”çš„é”™è¯¯ç‡ã€‚</p>
<p>åœ¨åŸºç¡€å±‚ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç³»ç»Ÿå®•æœºã€è¿›ç¨‹æˆ–è€…ç«¯å£æŒ‚æ‰ã€ç½‘ç»œä¸¢åŒ…è¿™æ ·çš„æƒ…å†µè®¤å®šä¸ºæ˜¯æ•…éšœã€‚åœ¨ä¸šåŠ¡å±‚ä¸­ï¼Œç›‘æ§çš„å†…å®¹ä¹Ÿå°±ç›¸å¯¹æ¯”è¾ƒå¤šäº†ï¼Œæ¯”å¦‚httpçŠ¶æ€ç 500ã€æ—¥å¿—ä¸­å‡ºç°çš„é”™è¯¯ï¼Œéƒ½æ˜¯å¯ä»¥è¢«è®¤å®šä¸ºâ€œé”™è¯¯â€çš„æŒ‡æ ‡ã€‚</p>
</li>
<li><p>å»¶è¿Ÿ</p>
<p><strong>å»¶è¿ŸæŒ‡çš„æ˜¯æœåŠ¡åœ¨å¤„ç†è¯·æ±‚æ—¶èŠ±è´¹çš„æ—¶é—´ã€‚</strong>æˆ‘ä»¬ç»å¸¸è¯´çš„æ¥å£è€—æ—¶ã€å“åº”æ—¶é•¿æŒ‡çš„å°±æ˜¯å»¶è¿Ÿã€‚åœ¨è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼šä¸€èˆ¬åœ¨ç»Ÿè®¡å»¶è¿Ÿæ—¶ï¼Œå¹¶ä¸ä¼šæŠŠæˆåŠŸæˆ–è€…é”™è¯¯çš„ä¿¡æ¯åˆ†å¼€ç»Ÿè®¡ã€‚è¿™æ ·çš„ç»Ÿè®¡æ–¹å¼ä¼šä½¿æˆ‘ä»¬æ›´éš¾äº†è§£åˆ°çœŸå®çš„æƒ…å†µï¼Œæ‰€ä»¥åœ¨ç»Ÿè®¡æ—¶å¸¸å¸¸éœ€è¦æŠŠå®ƒä»¬åŒºåˆ†å¼€ã€‚ä»¥ä¸€ä¸ª HTTP æ¥å£ä¸ºä¾‹ï¼Œå“åº”çŠ¶æ€ç æ­£ç¡®çš„ï¼ˆ200ï¼‰å’Œé”™è¯¯çš„ï¼ˆ500ï¼‰è¯·æ±‚ï¼Œå®ƒä»¬çš„è€—æ—¶ä¸€å®šä¼šæœ‰å·®åˆ«ï¼Œå› ä¸º<strong>æ­£ç¡®çš„è¯·æ±‚èµ°å®Œäº†å…¨æµç¨‹ï¼Œè€Œé”™è¯¯çš„å¯èƒ½åªè¿›è¡Œäº†æŸä¸€éƒ¨åˆ†æµç¨‹ï¼Œæˆ‘ä»¬å°±éœ€è¦æŠŠè¿™ä¸¤ä¸ªè¯·æ±‚çš„è€—æ—¶åœ¨ç»Ÿè®¡æ—¶åˆ†åˆ«è®°å½•</strong>ã€‚</p>
<p>åœ¨åŸºç¡€å±‚ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘æ§ I&#x2F;O ç­‰å¾…ã€ç½‘ç»œå»¶è¿Ÿç­‰ä¿¡æ¯ã€‚åœ¨ä¸šåŠ¡å±‚ä¸­ï¼Œåˆ™å¯ä»¥ç›‘æ§æ¥å£è°ƒç”¨çš„è€—æ—¶ã€MySQL æŸ¥è¯¢çš„è€—æ—¶ç­‰ä¿¡æ¯ã€‚</p>
<p>å»¶è¿Ÿåœ¨ç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ªååˆ†å…³é”®çš„æŒ‡æ ‡ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬çš„æœåŠ¡å¹¶ä¸ä¼šäº§ç”Ÿé”™è¯¯ï¼Œä½†å¾ˆå¯èƒ½ä¼šæœ‰å»¶è¿Ÿï¼Œå»¶è¿Ÿåœ¨ HTTP å±‚ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œåœ¨æ•°æ®åº“ä¸­å‡ºç°é«˜å»¶è¿Ÿä¼šå¯¼è‡´è¯·æ±‚é”™è¯¯ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦ç€é‡å…³æ³¨çš„ã€‚</p>
</li>
<li><p>æµé‡</p>
<p>æµé‡æ˜¯è¡¨ç°ç³»ç»Ÿè´Ÿè½½æƒ…å†µçš„æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸è§çš„ QPSã€UVã€‚é€šè¿‡è¿™ä¸ªæŒ‡æ ‡æˆ‘ä»¬èƒ½ç¡®åˆ‡äº†è§£åˆ°æœåŠ¡å½“å‰æ‰¿å—äº†å¤šå¤§çš„å‹åŠ›ï¼Œè¯·æ±‚é‡å’Œå¤„ç†é‡æœ‰å¤šå¤§ã€‚æˆ‘ä»¬å¸¸è¯´çš„å®¹é‡è§„åˆ’ï¼Œå…¶å®æ˜¯æµé‡è§„åˆ’ã€‚é€šè¿‡æµé‡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥å½“å‰ç³»ç»Ÿè¿è¡Œçš„çŠ¶å†µï¼Œæ˜¯å¦åˆ°è¾¾äº†å®ƒçš„è´Ÿè·ä¸Šé™ã€‚</p>
<p>åœ¨åŸºç¡€å±‚ä¸­ï¼Œå¸¸è§çš„ç›‘æ§æŒ‡æ ‡æœ‰ç£ç›˜çš„è¯»å†™é€Ÿåº¦ã€ç½‘ç»œ I&#x2F;O æƒ…å†µç­‰ã€‚åœ¨ä¸šåŠ¡å±‚ä¸­åˆ™æœ‰è¯·æ±‚é‡ã€MySQL æŸ¥è¯¢æ¬¡æ•°ç­‰ç­‰ã€‚</p>
<p>é€šè¿‡è§‚å¯Ÿæµé‡ç›¸å…³çš„æŒ‡æ ‡ï¼Œå¯ä»¥äº†è§£åˆ°æ˜¯å¦å­˜åœ¨çªå¢çªé™çš„æƒ…å†µï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦é­å—åˆ°äº†æ”»å‡»æˆ–è€…æ˜¯å¦åœ¨è¿›è¡ŒæŸäº›æ´»åŠ¨ã€‚</p>
</li>
<li><p>é¥±å’Œåº¦</p>
<p>é¥±å’Œåº¦é€šå¸¸æ˜¯æŒ‡æŸä¸ªèµ„æºçš„ä½¿ç”¨ç‡ã€‚é€šå¸¸æŒ‡çš„æ˜¯æˆ‘ä»¬é€šè¿‡å®¹é‡çš„æœ€å¤§å€¼å’Œç°åœ¨çš„ä½¿ç”¨é‡ï¼Œæ¥åˆ¤æ–­è¿™ä¸ªå®¹é‡æ˜¯å¦â€œæ»¡â€äº†ã€‚æŸäº›ç¨‹åºï¼Œå¦‚æœèµ„æºé¥±å’Œåº¦è¿‡é«˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‰§è¡Œç¼“æ…¢ï¼Œç”šè‡³æ— æ³•ä½¿ç”¨ã€‚æ¯”å¦‚ CPU ä½¿ç”¨ç‡å¦‚æœè¾¾åˆ° 100%ï¼Œä¼šå‡ºç°æ‰§è¡Œç¼“æ…¢ã€‚</p>
<p>é¥±å’Œåº¦ä¸€èˆ¬ä¹Ÿä¼šé…åˆå…¶ä»–æŒ‡æ ‡ä¸€èµ·ä½¿ç”¨ï¼Œæ¯”å¦‚åœ¨ä½¿ç”¨ç½‘ç»œ I&#x2F;O æ—¶ï¼Œç½‘å¡éƒ½æ˜¯æœ‰æµé‡ä¸Šé™çš„ï¼Œæˆ‘ä»¬é€šè¿‡æµé‡ä¸Šé™å€¼å’Œå½“å‰ç½‘ç»œ I&#x2F;O çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥å¾—çŸ¥ç›¸åº”çš„é¥±å’Œåº¦ã€‚é¥±å’Œåº¦æ˜¯è¡¡é‡æˆ‘ä»¬è¿™ä¸ªç³»ç»Ÿæ˜¯å¦åˆ°è¾¾ç“¶é¢ˆçš„å…³é”®ã€‚å¦‚é¥±å’Œåº¦è¿‡é«˜ï¼Œè¿™æ—¶å€™å°±éœ€è¦è€ƒè™‘æ‰©å®¹ã€å‡å°‘æ•°æ®é‡æˆ–æ˜¯å…¶ä»–é™ä½é¥±å’Œåº¦çš„æ“ä½œäº†ã€‚</p>
<p>åœ¨åŸºç¡€å±‚ä¸­ï¼Œéœ€è¦ç›‘æ§çš„æŒ‡æ ‡æœ‰ CPU ä½¿ç”¨ç‡ã€I&#x2F;O ä½¿ç”¨ç‡ã€å¥æŸ„ä½¿ç”¨æƒ…å†µç­‰ã€‚åœ¨ä¸šåŠ¡å±‚ä¸­åˆ™ä¼šæœ‰çº¿ç¨‹æ± çš„çº¿ç¨‹ä½¿ç”¨æ•°ã€JVM ä¸­çš„å †å†…å­˜ä½¿ç”¨ç‡ç­‰ä¿¡æ¯ã€‚</p>
</li>
</ul>
<h3 id="Prometheusæ¶æ„"><a href="#Prometheusæ¶æ„" class="headerlink" title="Prometheusæ¶æ„"></a>Prometheusæ¶æ„</h3><p><a href="/../pic/z6cqx.png" title="Prometheus architecture" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/z6cqx.png" alt="Prometheus architecture"></a></p>
<p>å®è§‚æ¥è¯´ï¼ŒPrometheusçš„æ¶æ„å¯ä»¥åˆ†ä¸ºä¸‰æ®µå¼ï¼š</p>
<ul>
<li><p>ä¸Šæ¸¸çš„è´Ÿè´£é‡‡é›†ç›‘æ§æŒ‡æ ‡çš„çš„ç»„ä»¶</p>
<p>prometheus serveré…ç½®ä¸­çš„ä¸€ä¸ªä¸ªç›‘æ§ç›®æ ‡targetï¼ŒåŒ…æ‹¬kubernetesä¸­è¿è¡Œçš„æœåŠ¡å’Œå®ƒæœ¬èº«çš„ä¸€äº›ç»„ä»¶ã€åŸºäºæ–‡ä»¶çš„è‡ªåŠ¨å‘ç°ã€å„ç§exporteræœåŠ¡ã€Pushgatewayç­‰</p>
</li>
<li><p>ä¸­æ¸¸è´Ÿè´£ä¿å­˜æ•°æ®çš„ç»„ä»¶</p>
<ul>
<li>Retrievalï¼šå¯¹æ¥ä¸Šæ¸¸ï¼Œå‘¨æœŸæ€§å»ä¸Šæ¸¸çš„ç›‘æ§ç›®æ ‡targeté‡Œæ‹‰å–ç›‘æ§æ•°æ®</li>
<li>TSDBï¼šæŒ‰ç…§æ—¶åºå­˜å‚¨æ•°æ®</li>
<li>HTTP server: å¯¹ä¸‹æ¸¸æš´æ¼è®¿é—®TSDBçš„æ¥å£</li>
</ul>
</li>
<li><p>ä¸‹æ¸¸è´Ÿè´£ä½¿ç”¨æ•°æ®çš„ç»„ä»¶</p>
<ul>
<li>Altermanagerï¼š æ¥å£prometheusæ¨é€è¿‡æ¥çš„æŠ¥è­¦ä¿¡æ¯ï¼Œç„¶åå‘é€ç»™ä¸åŒçš„æŠ¥è­¦åª’ä»‹</li>
<li>Grafanaï¼šè´Ÿè´£å‡ºå›¾</li>
</ul>
</li>
</ul>
<h2 id="Prometheusç›‘æ§å®è·µ"><a href="#Prometheusç›‘æ§å®è·µ" class="headerlink" title="Prometheusç›‘æ§å®è·µ"></a>Prometheusç›‘æ§å®è·µ</h2><h3 id="éƒ¨ç½²Prometheus"><a href="#éƒ¨ç½²Prometheus" class="headerlink" title="éƒ¨ç½²Prometheus"></a>éƒ¨ç½²Prometheus</h3><blockquote>
<p><strong>storage.yaml</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage</span><br><span class="line">provisioner: kubernetes.io/no-provisioner</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-local</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 20Gi</span><br><span class="line">  storageClassName: local-storage</span><br><span class="line">  local:</span><br><span class="line">    path: /data/k8s/prometheus</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">        - matchExpressions:</span><br><span class="line">            - key: kubernetes.io/hostname</span><br><span class="line">              operator: In</span><br><span class="line">              values:</span><br><span class="line">                - k8s-master-01</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus-data</span><br><span class="line">  namespace: monitor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 20Gi</span><br><span class="line">  storageClassName: local-storage</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>configmap.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s # Prometheusæ¯éš”15så°±ä¼šä»æ‰€æœ‰é…ç½®çš„ç›®æ ‡ç«¯ç‚¹æŠ“å–æœ€æ–°çš„æ•°æ®</span></span><br><span class="line"><span class="string">      scrape_timeout: 15s  # æŸä¸ªæŠ“å–æ“ä½œåœ¨ 15 ç§’å†…æœªå®Œæˆï¼Œä¼šè¢«è§†ä¸ºè¶…æ—¶ï¼Œä¸ä¼šåŒ…å«åœ¨æœ€æ–°çš„æ•°æ®ä¸­ã€‚</span></span><br><span class="line"><span class="string">      evaluation_interval: 15s #  # æ¯15så¯¹å‘Šè­¦è§„åˆ™è¿›è¡Œè®¡ç®—</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">      - job_name: &quot;prometheus&quot;</span></span><br><span class="line"><span class="string">        static_configs:</span></span><br><span class="line"><span class="string">        - targets: [&quot;localhost:9090&quot;]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>deployment.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">securityContext:</span>  <span class="comment"># å¢åŠ è¿™ä¸€æ®µ</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">harbor.in-road.com/dengjinjun/prometheus:2.53.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span> <span class="comment"># æŒ‡å®štsdbæ•°æ®è·¯å¾„</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--storage.tsdb.retention.time=24h&#x27;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-admin-api&#x27;</span> <span class="comment"># æ§åˆ¶å¯¹admin HTTP APIçš„è®¿é—®ï¼Œå…¶ä¸­åŒ…æ‹¬åˆ é™¤æ—¶é—´åºåˆ—ç­‰åŠŸèƒ½</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--web.enable-lifecycle&#x27;</span> <span class="comment"># æ”¯æŒçƒ­æ›´æ–°ï¼Œç›´æ¥æ‰§è¡Œlocalhost:9090/-/reloadç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/prometheus&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/prometheus&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">prometheus-data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/control-plane&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9090</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>prometheus-rdbc.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;extensions&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> <span class="comment"># ç”¨æ¥å¯¹éèµ„æºå‹ metrics è¿›è¡Œæ“ä½œçš„æƒé™å£°æ˜</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span> <span class="comment"># ç”±äºæˆ‘ä»¬è¦è·å–çš„èµ„æºä¿¡æ¯ï¼Œåœ¨æ¯ä¸€ä¸ª namespace ä¸‹é¢éƒ½æœ‰å¯èƒ½å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ ClusterRole çš„èµ„æºå¯¹è±¡</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">monitor</span></span><br></pre></td></tr></table></figure>

<h3 id="ç‰©ç†èŠ‚ç‚¹çš„ç›‘æ§"><a href="#ç‰©ç†èŠ‚ç‚¹çš„ç›‘æ§" class="headerlink" title="ç‰©ç†èŠ‚ç‚¹çš„ç›‘æ§"></a>ç‰©ç†èŠ‚ç‚¹çš„ç›‘æ§</h3><p>é€šè¿‡åœ¨ç‰©ç†èŠ‚ç‚¹ä¸Šå®‰è£…node exporterï¼Œç„¶ååœ¨prometheusé…ç½®æ–‡ä»¶ä¸­æ·»åŠ ç›‘æ§é¡¹æ¥å®ç°</p>
<blockquote>
<p><strong>node-exporter.yaml</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># ç”±äºæˆ‘ä»¬è¦è·å–åˆ°çš„æ•°æ®æ˜¯ä¸»æœºçš„ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œè€Œæˆ‘ä»¬çš„ node-exporter æ˜¯è¿è¡Œåœ¨å®¹å™¨ä¸­çš„ï¼Œ</span></span><br><span class="line">      <span class="comment"># æ‰€ä»¥æˆ‘ä»¬å¿…é¡»ç¡®ä¿åœ¨å®¹å™¨å†…å¯ä»¥çœ‹åˆ°å®¿ä¸»æœºä¸Šçš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œä¸ºæ­¤æˆ‘ä»¬åšäº†ä¸¤ä»¶äº‹</span></span><br><span class="line">      <span class="comment"># ç¬¬ä¸€ï¼šé…ç½®äº†å¦‚ä¸‹ä¸‰æ¡Podå®‰å…¨ç­–ç•¥ä¸ºtrueï¼Œç¡®ä¿åœ¨podå†…å¯ä»¥è®¿é—®åˆ°å®¿ä¸»æœºä¸Šçš„PID namespaceã€IPC namespace ä»¥åŠä¸»æœºç½‘ç»œ</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># ç¬¬äºŒï¼šå°†ä¸»æœºçš„ /devã€/procã€/sysè¿™äº›ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œç‰©ç†èŠ‚ç‚¹çš„å¾ˆå¤šæ•°æ®éƒ½åœ¨è¿™äº›ç›®å½•ä¸­</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/proc</span>  <span class="comment"># topå‘½ä»¤æŸ¥çœ‹åˆ°çš„cpuçŠ¶æ€å°±æ¥è‡ªäº/proc/stat, å‘½ä»¤free -hçœ‹åˆ°çš„å†…å­˜çŠ¶æ€å°±æ¥è‡ªäº/proc/meminfo</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">      <span class="comment"># æ­¤å¤–ç”±äºæˆ‘ä»¬é›†ç¾¤ä½¿ç”¨çš„æ˜¯ kubeadm æ­å»ºçš„ï¼Œæ‰€ä»¥å¦‚æœå¸Œæœ› master èŠ‚ç‚¹ä¹Ÿä¸€èµ·è¢«ç›‘æ§ï¼Œåˆ™éœ€è¦æ·»åŠ ç›¸åº”çš„å®¹å¿</span></span><br><span class="line">      <span class="comment"># ä¸‹é¢è¿™æ¡å®¹å¿è®¾ç½®çš„å«ä¹‰æ˜¯ï¼šæ— è®ºèŠ‚ç‚¹ä¸Šå­˜åœ¨ä½•ç§ Taintsï¼Œè¯¥ Pod éƒ½ä¼šå®¹å¿è¿™äº› Taintsï¼Œä»è€Œèƒ½å¤Ÿåˆ†å¸ƒåˆ°æ‰€æœ‰èŠ‚ç‚¹ä¸Šã€‚</span></span><br><span class="line">      <span class="comment"># è¿™æ˜¯ç¡®ä¿ç›‘æ§å·¥å…· DaemonSet å¯è¢«éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„å¸¸è§åšæ³•ã€‚</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&#x27;Exists&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># æˆ‘ä»¬æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ªæ ‡ç­¾</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">harbor.in-road.com/dengjinjun/node-exporter:1.3.1</span></span><br><span class="line">          <span class="attr">args:</span> <span class="comment"># é€‰é¡¹å®šåˆ¶è¯¦è§ï¼šhttps://github.com/prometheus/node_exporter</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--web.listen-address=$(HOSTIP):9100</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.procfs=/host/proc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.sysfs=/host/sys</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--path.rootfs=/host/root</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.hwmon</span> <span class="comment"># ç¦ç”¨ä¸éœ€è¦çš„ä¸€äº›é‡‡é›†å™¨</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nfs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nfsd</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.nvme</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.dmi</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--no-collector.arp</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/containerd/.+|/var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-fs-types=^(autofs|binfmt_misc|cgroup|configfs|debugfs|devpts|devtmpfs|fusectl|hugetlbfs|mqueue|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|sysfs|tracefs)$</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOSTIP</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">180Mi</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">65534</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/proc</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/sys</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/host/root</span></span><br><span class="line">              <span class="attr">mountPropagation:</span> <span class="string">HostToContainer</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>prometheus.yml</strong></p>
</blockquote>
<p>è¿™é‡Œæ·»åŠ ç›‘æ§é¡¹æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯æ‰‹åŠ¨æ·»åŠ é™æ€ç›‘æ§é¡¹ï¼Œå¦ä¸€ç§æ˜¯é…ç½®åŠ¨æ€å‘ç°</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ é™æ€ç›‘æ§é¡¹ï¼Œä¸€èˆ¬ç”¨äºkubernetesä¹‹å¤–çš„ç‰©ç†èŠ‚ç‚¹</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;node-exporter&quot;</span>  </span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;10.100.183.5:9100&quot;</span>,<span class="string">&quot;10.100.183.6:9100&quot;</span>,<span class="string">&quot;10.100.183.7:9100&quot;</span>,<span class="string">&quot;10.100.183.8:9100&quot;</span>,<span class="string">&quot;10.100.183.10:9100&quot;</span>,<span class="string">&quot;10.100.183.13:9100&quot;</span>] </span><br><span class="line">        </span><br><span class="line"><span class="comment"># é…ç½®è‡ªåŠ¨å‘ç°ï¼Œä¸€èˆ¬ç”¨äºkubernetesä¹‹å†…çš„ç‰©ç†èŠ‚ç‚¹</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;nodes&#x27;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]  <span class="comment"># è·å–åˆ°åœ°å€</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">&#x27;(.*):10250&#x27;</span> <span class="comment"># ç”¨æ­£åˆ™regexåŒ¹é…ä¸Šé¢è·å–åˆ°çš„åœ°å€ï¼Œ(.*)è·å–åˆ°çš„æ˜¯ipåœ°å€éƒ¨åˆ†ï¼ŒåŠ æ‹¬å·ä»£è¡¨å­˜å…¥ä¸€ä¸ªæ­£åˆ™åˆ†ç»„</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">&#x27;$&#123;1&#125;:9100&#x27;</span> <span class="comment"># å–å‡ºä¸Šé¢æ­£åˆ™åˆ†ç»„çš„å†…å®¹å³ipåœ°å€ï¼Œç„¶ååé¢æ‹¼ä¸€ä¸ª9100ç«¯å£ï¼Œå³å®Œæˆç«¯å£æ›¿æ¢</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__address__</span> <span class="comment"># æ›¿æ¢çš„ç›®æ ‡</span></span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span>           <span class="comment"># åŠ¨ä½œä¸ºreplace</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span> <span class="comment"># å¢åŠ </span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="comment"># åœ¨kuberneteså†…çš„èŠ‚ç‚¹ï¼Œè¿˜å¯ä»¥æ·»åŠ kubeletçš„è‡ªåŠ¨å‘ç°ï¼Œå¯ä»¥æ‹¿åˆ°kubeletæä¾›çš„é»˜è®¤æ¥å£ï¼šhttps://node_ip:10250/metricsæä¾›çš„ç‰©ç†èŠ‚ç‚¹ç›¸å…³çš„ä¿¡æ¯  </span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubelet&#x27;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span>            </span><br></pre></td></tr></table></figure>

<h3 id="é›†ç¾¤ä¸­çš„ç»„ä»¶"><a href="#é›†ç¾¤ä¸­çš„ç»„ä»¶" class="headerlink" title="é›†ç¾¤ä¸­çš„ç»„ä»¶"></a>é›†ç¾¤ä¸­çš„ç»„ä»¶</h3><p>ç»„ä»¶ä¿¡æ¯å’Œé›†ç¾¤ä¸­èµ„æºçš„ä¿¡æ¯ï¼Œä¸€èˆ¬éƒ½è‡ªå¸¦äº†metricsæ¥å£ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ é™æ€targetæˆ–è€…åŠ¨æ€å‘ç°ï¼Œéƒ½æ˜¯åœ¨<code>prometheus.yaml</code>ä¸­é…ç½®çš„</p>
<blockquote>
<p><strong>æ·»åŠ ç‰©ç†èŠ‚ç‚¹ä¸Šå®¹å™¨çš„ç›‘æ§é¡¹</strong></p>
</blockquote>
<p>æ·»åŠ å®¹å™¨ç›¸å…³ä¿¡æ¯ï¼Œä¸€èˆ¬å®¹å™¨éƒ½æ˜¯é€šè¿‡cadvisoræ¥è·å–ä¿¡æ¯çš„ï¼Œç°åœ¨cadvisorä¼šé›†æˆåœ¨kubeletç»„ä»¶ä¸­ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šä¹Ÿè¿˜æ˜¯é€šè¿‡kubeletæä¾›çš„æ¥å£å®ç°çš„ï¼Œä¸è¿‡è·Ÿä¸Šé¢kubeletä¸åŒçš„æ˜¯ï¼Œå®¹å™¨ç›¸å…³çš„ä¿¡æ¯ç”¨çš„æ˜¯å¦å¤–ä¸€ä¸ªæ¥å£ï¼š<a target="_blank" rel="noopener" href="https://node_ip:10250/metrics/cadvisor">https://node_ip:10250/metrics/cadvisor</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-cadvisor&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">/metrics/cadvisor</span> <span class="comment"># &lt;nodeip&gt;/metrics -&gt; &lt;nodeip&gt;/metrics/cadvisor</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path_</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>æ·»åŠ apiserverçš„ç›‘æ§é¡¹</strong></p>
</blockquote>
<p>è¿™äº›ä»¥é›†ç¾¤å†…Podè¿è¡Œçš„ç³»ç»Ÿç»„ä»¶éƒ½éœ€è¦é€šè¿‡svcæ¥è®¿é—®ï¼Œapiserveræ˜¯æœ‰ä¸€ä¸ªsvcçš„ï¼Œåœ¨é»˜è®¤çš„å‘½åç©ºé—´ä¸‹ï¼Œé€šè¿‡<code>kubectl get ep</code>å¯ä»¥çœ‹åˆ°å…¶endpointã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>,<span class="string">__meta_kubernetes_service_name</span>,<span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>æ·»åŠ controller-managerçš„ç›‘æ§é¡¹</strong></p>
</blockquote>
<p>Podçš„IPæ˜¯ä¸å›ºå®šçš„ï¼Œcontroller-manageré»˜è®¤æ²¡æœ‰svcï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªsvcï¼Œç»™prometheusè®¿é—®ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https-metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">10257</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">10257</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-controller-manager</span></span><br></pre></td></tr></table></figure>

<p>åœ¨<code>/etc/kubernetes/manifest</code>ç›®å½•ä¸‹å„ä¸ªç»„ä»¶çš„é…ç½®æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>--bind-address=127.0.0.1</code>ï¼Œè¯´æ˜æ¯å°æœºå™¨ä¸Šçš„ç»„ä»¶é»˜è®¤éƒ½æ˜¯ç›‘å¬æœ¬æœºåœ°å€çš„ï¼Œéœ€è¦æŠŠè¿™ä¸ªåœ°å€æ”¹ä¸º<code>0.0.0.0</code>ï¼Œæ›´æ”¹ä¹‹åkubeletä¼šè‡ªåŠ¨é‡å¯å®ƒä»¬ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kube-controller-manager&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>,<span class="string">__meta_kubernetes_service_name</span>,<span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">kube-system;kube-controller-manager;https-metrics</span></span><br></pre></td></tr></table></figure>

<p>ç±»ä¼¼çš„åŸç†ï¼Œæ·»åŠ <code>kube-scheduler</code>çš„ç›‘æ§ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä¸åœ¨èµ˜è¿°</p>
<blockquote>
<p><strong>æ·»åŠ etcdçš„ç›‘æ§é¡¹</strong></p>
</blockquote>
<p>etcdè·Ÿä¸Šé¢ä¸¤ä¸ªæœ‰ä¸€äº›ä¸åŒä¹‹å¤„ï¼Œä¸€æ˜¯å®ƒæ˜¯httpåè®®è®¿é—®çš„</p>
<p>etcd-svc.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">etcd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">2381</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">2381</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<p>äºŒæ˜¯å®ƒç›‘å¬åœ°å€çš„é…ç½®æ˜¯<code>--listen-metrics-urls=http://127.0.0.1:2381</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;etcd&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">kube-system;etcd;http</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¸šåŠ¡Podä¿¡æ¯"><a href="#ä¸šåŠ¡Podä¿¡æ¯" class="headerlink" title="ä¸šåŠ¡Podä¿¡æ¯"></a>ä¸šåŠ¡Podä¿¡æ¯</h3><p>k8sä¸­è¿è¡Œçš„æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰è‡ªå¸¦&#x2F;metricsæ¥å£ï¼Œæ¯”å¦‚Redisã€MySQLï¼Œè¿™ç±»éœ€è¦åœ¨Podä¸­ä½¿ç”¨sidecaræ¨¡å¼å¯åŠ¨exporterå®¹å™¨æ¥å®ç°ï¼Œå¹¶ä¸”è¿™ä¸ªsidecarå®¹å™¨éœ€è¦èƒ½è¢«prometheusè‡ªåŠ¨å‘ç°å¹¶è®¿é—®ã€‚</p>
<p>ç»¼ä¸Šï¼Œä¸šåŠ¡Podçš„ç›‘æ§éœ€è¦æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>å…·å¤‡&#x2F;metricsæ¥å£</li>
<li>å…·å¤‡svcï¼Œsvcç”Ÿæˆçš„endpointèƒ½è¢«prometheusè®¿é—®åˆ°</li>
<li>svcéœ€è¦å…·å¤‡ä¸€äº›æ³¨è§£æˆ–æ ‡ç­¾ï¼Œä»¥ä¾¿äºpromtheusç­›é€‰ï¼Œæ¯”å¦‚ï¼š<code>prometheus.io/scrape:true</code></li>
</ol>
<p>ä»¥corednsä¸ºä¾‹ï¼Œä¸‰ä¸ªæ¡ä»¶éƒ½å·²ç»æ»¡è¶³ï¼Œä¸‹é¢æ˜¯promtheusé…ç½®æ–‡ä»¶çš„è¡¥å……å†…å®¹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-endpoints&#x27;</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="comment"># 1ã€åŒ¹é…å…ƒæ•°æ®__meta_kubernetes_service_annotation_prometheus_io_scrapeåŒ…å«&quot;true&quot;çš„ç•™ä¸‹</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 2ã€__meta_kubernetes_service_annotation_prometheus_io_schemeçš„å€¼ä¸­åŒ…å«0æˆ–1ä¸ªhttpsï¼Œåˆ™æ”¹åä¸º__scheme__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">  <span class="comment"># 3ã€__meta_kubernetes_service_annotation_prometheus_io_pathçš„å€¼è‡³å°‘æœ‰ä¸€ä¸ªä»»æ„å­—ç¬¦ï¼Œåˆ™æ”¹åä¸º__metrics_path__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span>            </span><br><span class="line">  <span class="comment"># 4ã€æå–ipä¸portæ‹¼æ¥åˆ°ä¸€èµ·æ ¼å¼ä¸º: 1.1.1.1:3333ï¼Œç„¶åèµ‹å€¼ç»™æ–°labelåï¼š__address__</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span> <span class="comment"># RE2 æ­£åˆ™è§„åˆ™ï¼Œ+æ˜¯ä¸€æ¬¡å¤šå¤šæ¬¡ï¼Œ?æ˜¯0æ¬¡æˆ–1æ¬¡ï¼Œå…¶ä¸­?:è¡¨ç¤ºéåŒ¹&gt;é…ç»„(æ„æ€å°±æ˜¯ä¸è·å–åŒ¹é…ç»“æœ)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1:$2</span>        </span><br><span class="line">  <span class="comment"># 5ã€æ·»åŠ æ ‡ç­¾</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span>         </span><br><span class="line">  <span class="comment"># 6ã€åç§°ç©ºé—´æ ‡ç­¾æ›¿æ¢ä¸ºkubernetes_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span>          </span><br><span class="line">  <span class="comment"># 7ã€æœåŠ¡åæ›¿æ¢ä¸ºkubernetes_name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_name</span>        </span><br><span class="line">  <span class="comment"># 8ã€podåæ›¿æ¢ä¸ºkubernetes_pod_name</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></table></figure>

<h3 id="é›†ç¾¤çŠ¶æ€ä¿¡æ¯"><a href="#é›†ç¾¤çŠ¶æ€ä¿¡æ¯" class="headerlink" title="é›†ç¾¤çŠ¶æ€ä¿¡æ¯"></a>é›†ç¾¤çŠ¶æ€ä¿¡æ¯</h3><p>ä¸Šè¿°ç›‘æ§åœ¨å„ä¸ªç»´åº¦ä¸Šæä¾›äº†ç›¸åº”èµ„æºçš„ç›‘æ§é¡¹ï¼Œä½†æ˜¯å¹¶ä¸å®Œå–„ï¼Œå› ä¸ºkubernetesé›†ç¾¤ä¸­è¿˜æœ‰ä¸€äº›èµ„æºçŠ¶æ€ä¿¡æ¯éœ€è¦è¢«æ”¶é›†å’Œç›‘æ§ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æŸä¸ªä¸šåŠ¡Podå½“å‰çš„å‰¯æœ¬æ•°é‡æ˜¯å¤šå°‘ï¼Œæœ‰å¤šå°‘ä¸ªæ˜¯å¯ç”¨çš„</li>
<li>å¤„äºrunning&#x2F;stopping&#x2F;terminatedçŠ¶æ€çš„Podæœ‰å¤šå°‘</li>
<li>Podé‡å¯äº†å¤šå°‘æ¬¡</li>
<li>æœ‰å¤šå°‘ä¸ªJobåœ¨ç­‰å¾…è¿è¡Œ</li>
</ul>
<p>æ— è®ºæ˜¯apiserverã€cadvisorï¼Œè¿˜æ˜¯ä¸šåŠ¡Podæš´éœ²çš„metricsä¿¡æ¯ï¼Œéƒ½æ— æ³•æä¾›ä¸Šè¿°æŒ‡æ ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æ–°çš„exporterï¼Œæ¥æä¾›å…¨å±€çš„çŠ¶æ€æŒ‡æ ‡ï¼š<code>kube-state-metrics</code></p>
<p>æ³¨æ„ï¼š<code>kube-state-metrics</code>ä¸<code>metrics</code>å¹¶ä¸ç›¸åŒï¼Œè™½ç„¶å®ƒä»¬éƒ½æ˜¯ç”¨äºç›‘æ§æŒ‡æ ‡çš„æ”¶é›†ï¼Œä½†æ˜¯<code>metrics-server</code>æä¾›å®æ—¶çš„èµ„æºç›‘æ§æŒ‡æ ‡ï¼Œæ›´å¤šçš„æ˜¯ç»™HPAåšå†³ç­–ï¼Œä¸æ“…é•¿åšå†å²æ•°æ®åˆ†æï¼›è€Œ<code>kube-state-metrics</code>æ›´æ“…é•¿åšè¿™ä»¶äº‹ï¼Œå¯¹æ¥Prometheusæä¾›å†å²æ•°æ®åˆ†æã€‚</p>
<p>éƒ¨ç½²</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/kubernetes/kube-state-metrics.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹å¹¶è¿›å…¥ç›®å½•</span></span><br><span class="line">unzip kube-state-metrics-main.zip </span><br><span class="line"><span class="built_in">cd</span> kube-state-metrics-main/examples/standard</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨service.yamlæ–‡ä»¶ä¸­æ·»åŠ æ³¨è§£ï¼šprometheus.io/scrape: &quot;true&quot;ï¼Œç„¶åæŠŠé•œåƒæ¢æˆå›½å†…å¯ç”¨çš„ï¼Œéƒ¨ç½²å³å¯</span></span><br><span class="line">kubectl apply -f .</span><br></pre></td></tr></table></figure>



<h2 id="PromQLè¯­æ³•ä¸Grafanaå‡ºå›¾"><a href="#PromQLè¯­æ³•ä¸Grafanaå‡ºå›¾" class="headerlink" title="PromQLè¯­æ³•ä¸Grafanaå‡ºå›¾"></a>PromQLè¯­æ³•ä¸Grafanaå‡ºå›¾</h2><h3 id="PromQLè¯­æ³•"><a href="#PromQLè¯­æ³•" class="headerlink" title="PromQLè¯­æ³•"></a>PromQLè¯­æ³•</h3><p>prometheusç›‘æ§ä¸­å¯¹äºé‡‡é›†è¿‡æ¥çš„æ•°æ®ç»Ÿä¸€ç§°ä¸ºmetricsæ•°æ®ã€‚æ€»ä½“ä¸Šæ¥è¯´metricsæ˜¯å¯¹é‡‡é›†è¿‡æ¥çš„æ•°æ®çš„ä¸€ç§ç»Ÿç§°ã€‚</p>
<p>metricsæ•°æ®åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p>
<ul>
<li>Gaugeï¼šæœ€ç®€å•çš„åº¦é‡æŒ‡æ ‡ï¼Œåªæœ‰ä¸€ä¸ªç®€å•çš„è¿”å›å€¼ï¼ˆç¬æ—¶çŠ¶æ€ï¼‰ï¼Œæ¯”å¦‚å½“å‰çš„cpuä½¿ç”¨ç‡ï¼Œå†…å­˜ä½¿ç”¨ç‡ï¼Œç£ç›˜ä½¿ç”¨ç‡ï¼Œæ¸©åº¦ç­‰ï¼Œè¿™ç§å°±æ˜¯Gaugeç±»å‹çš„ä»£è¡¨ã€‚</li>
<li>Counterï¼šCounterså°±æ˜¯è®¡æ•°å™¨ï¼Œå®ƒçš„ç»Ÿè®¡æ•°æ®æ˜¯é€’å¢çš„ï¼Œæ¯”å¦‚httpè¯·æ±‚çš„æ€»æ•°ï¼Œå‡ºç°çš„é”™è¯¯æ€»æ•°ï¼Œæ€»çš„å¤„ç†æ—¶é—´ï¼Œapiè¯·æ±‚æ•°ç­‰</li>
<li>Histogramsï¼šç»Ÿè®¡åœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œè¿˜æä¾›åº¦é‡æŒ‡æ ‡çš„æ€»å’Œï¼Œæ•°æ®ä»¥ç›´æ–¹å›¾æ˜¾ç¤ºã€‚å…¶ä¸»è¦ç”¨äºè¡¨ç¤ºä¸€æ®µæ—¶é—´å†…å¯¹æ•°æ®çš„é‡‡æ ·ï¼Œå¹¶èƒ½å¤Ÿå¯¹å…¶æŒ‡å®šåŒºé—´åŠæ€»æ•°è¿›è¡Œç»Ÿè®¡ã€‚æ ¹æ®ç»Ÿè®¡åŒºé—´è®¡ç®—ã€‚å¦‚è¯·æ±‚çš„æŒç»­&#x2F;å»¶é•¿æ—¶é—´ï¼Œè¯·æ±‚çš„å“åº”å¤§å°ç­‰ã€‚</li>
<li>Summaryï¼šç±»ä¼¼Histogramï¼Œç”¨äºè¡¨ç¤ºä¸€æ®µæ—¶é—´å†…æ•°æ®é‡‡æ ·ç»“æœï¼Œå…¶ç›´æ¥å­˜å‚¨quantileæ•°æ®ï¼Œè€Œä¸æ˜¯æ ¹æ®ç»Ÿè®¡åŒºé—´è®¡ç®—å‡ºæ¥çš„ã€‚ä¸éœ€è¦è®¡ç®—ï¼Œç›´æ¥å­˜å‚¨ç»“æœã€‚</li>
</ul>
<p>PromQLæ˜¯Prometheuså®ç°ç›‘æ§æŸ¥è¯¢çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œé€šè¿‡PromQLï¼Œç”¨æˆ·å¯ä»¥éå¸¸æ–¹ä¾¿åœ°å¯¹ç›‘æ§æ ·æœ¬æ•°æ®è¿›è¡Œç»Ÿè®¡åˆ†æï¼ŒPromQLæ”¯æŒå¸¸è§çš„è¿ç®—æ“ä½œç¬¦ï¼ŒåŒæ—¶PromQLä¸­è¿˜æä¾›äº†å¤§é‡çš„å†…ç½®å‡½æ•°å¯ä»¥å®ç°å¯¹æ•°æ®çš„é«˜çº§å¤„ç†ã€‚</p>
<p>ä¸‹é¢æ˜¯é›†ä¸­å¸¸è§çš„PromQLæŸ¥è¯¢è¯­æ³•ï¼š</p>
<h4 id="æ ‡ç­¾åŒ¹é…æŸ¥è¯¢"><a href="#æ ‡ç­¾åŒ¹é…æŸ¥è¯¢" class="headerlink" title="æ ‡ç­¾åŒ¹é…æŸ¥è¯¢"></a>æ ‡ç­¾åŒ¹é…æŸ¥è¯¢</h4><p>æœ€ç®€å•çš„æŸ¥è¯¢æ–¹å¼ï¼ŒPrometheusé€šè¿‡æŒ‡æ ‡åç§°å’Œæ ‡ç­¾å”¯ä¸€å®šä¹‰ä¸€æ¡æ—¶é—´åºåˆ—è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<p>æ¯”å¦‚æƒ³è¦æŸ¥è¯¢CPUæ€»çš„ä½¿ç”¨æ—¶é—´ï¼Œå¯ä»¥è¾“å…¥æŒ‡æ ‡åç§°<code>node_cpu_seconds_total</code>ï¼Œå¯ä»¥çœ‹åˆ°å‡ºç°çš„metricsé¡¹</p>
<p><a target="_blank" rel="noopener" href="https://dengjinjun.site/pic/image-20240401190302326.png"><a href="/../pic/image-20240401190302326.png" title="image-20240401190302326" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240401190302326.png" alt="image-20240401190302326"></a></a></p>
<p>å¦‚æœæƒ³è¦æŸ¥è¯¢æ›´è¯¦ç»†çš„ç»´åº¦ï¼Œæ¯”å¦‚CPUåœ¨å†…æ ¸æ€çš„ä½¿ç”¨æ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾ï¼Œå³åœ¨æŒ‡æ ‡åç§°åè¿½åŠ <code>&#123;mode=&quot;system&quot;&#125;</code></p>
<p><a target="_blank" rel="noopener" href="https://dengjinjun.site/pic/image-20240401190717919.png"><a href="/../pic/image-20240401190717919.png" title="image-20240401190717919" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20240401190717919.png" alt="image-20240401190717919"></a></a></p>
<p>ä½¿ç”¨æŠ€å·§ï¼š</p>
<ol>
<li>åœ¨ä½¿ç”¨æ ‡ç­¾æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªæ ‡ç­¾ï¼Œæ¯”å¦‚<code>node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;system&quot;&#125;</code></li>
<li>åœ¨ä½¿ç”¨æ ‡ç­¾æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>=</code>å’Œ<code>!=</code>ï¼Œæ¯”å¦‚<code>node_cpu_seconds_total&#123;mode=&quot;system&quot;&#125;</code>ï¼Œä¸çœ‹å†…æ ¸æ€çš„æ—¶é—´</li>
<li>é™¤äº†å®Œå…¨åŒ¹é…å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…ç¬¦å·ä½¿ç”¨<code>=~</code>æ¨¡ç³ŠåŒ¹é…ï¼Œä½¿ç”¨<code>!~</code>è¡¨ç¤ºåå‘æ¨¡ç³ŠåŒ¹é…</li>
<li>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œåœ¨æ ‡ç­¾çš„å€¼é‡Œé¢ä½¿ç”¨<code>|</code>è¡¨ç¤ºé€»è¾‘æˆ–ï¼Œæ¯”å¦‚<code>node_cpu_seconds_total&#123;mode=~&quot;system|nice&quot;&#125;</code></li>
<li>ä¸Šé¢å‡ ä¸ªä¾‹å­æŸ¥è¯¢åˆ°çš„éƒ½æ˜¯ç¬æ—¶å‘é‡ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢è¡¨è¾¾å¼åé¢æ·»åŠ <code>[1m]</code>ï¼ŒæŸ¥è¯¢1åˆ†é’Ÿå†…æ‰€æœ‰æ ·æœ¬æ•°æ®ï¼Œæ­¤æ—¶æŸ¥è¯¢åˆ°çš„æ˜¯åŒºé—´å‘é‡ã€‚</li>
</ol>
<h4 id="äºŒå…ƒæ“ä½œ"><a href="#äºŒå…ƒæ“ä½œ" class="headerlink" title="äºŒå…ƒæ“ä½œ"></a>äºŒå…ƒæ“ä½œ</h4><p>äºŒå…ƒæ“ä½œç¬¦åŒ…æ‹¬ï¼šæ•°å­¦è¿ç®—ç¬¦ï¼Œé€»è¾‘è¿ç®—ç¬¦ï¼Œå¸ƒå°”è¿ç®—ç¬¦</p>
<blockquote>
<p><strong>æ•°å­¦è¿ç®—</strong></p>
</blockquote>
<p>PromQLæ”¯æŒå¯¹æŸ¥è¯¢åˆ°çš„æ•°æ®è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œå¯¹ç»“æœè¿›è¡ŒäºŒæ¬¡åŠ å·¥ã€‚</p>
<ul>
<li><code>+</code> (åŠ æ³•)</li>
<li><code>-</code> (å‡æ³•)</li>
<li><code>*</code> (ä¹˜æ³•)</li>
<li><code>/</code> (é™¤æ³•)</li>
<li><code>%</code> (æ±‚ä½™)</li>
<li><code>^</code> (å¹‚è¿ç®—)</li>
</ul>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥ MB ä¸ºå•ä½æ˜¾ç¤ºç©ºé—²å†…å­˜</span></span><br><span class="line">node_memory_MemFree_bytes / (1024 * 1024)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å±•ç¤ºä¸»æœºç£ç›˜çš„I/Oæ€»é‡</span></span><br><span class="line">node_disk_written_bytes_total + node_disk_read_bytes_total</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>å¸ƒå°”è¿ç®—</strong></p>
</blockquote>
<p>PromQLæ”¯æŒå¯¹æŸ¥è¯¢åˆ°çš„æ•°æ®çš„å€¼è¿›è¡Œå¸ƒå°”è¿ç®—ï¼Œå¯¹ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚</p>
<p>å¦å¤–ï¼Œä½¿ç”¨boolä¿®æ”¹ç¬¦åï¼Œå¸ƒå°”è¿ç®—ä¸ä¼šå¯¹ç»“æœè¿›è¡Œè¿‡æ»¤ï¼Œè€Œæ˜¯å°†å„ä¸ªæ ·æœ¬çš„æ•°æ®ä¸æ ‡é‡è¿›è¡Œæ¯”è¾ƒï¼Œå¾—å‡ºç»“æœ0æˆ–1</p>
<ul>
<li><code>==</code> (ç›¸ç­‰)</li>
<li><code>!=</code> (ä¸ç›¸ç­‰)</li>
<li><code>&gt;</code> (å¤§äº)</li>
<li><code>&lt;</code> (å°äº)</li>
<li><code>&gt;=</code> (å¤§äºç­‰äº)</li>
<li><code>&lt;=</code> (å°äºç­‰äº)</li>
<li><code>bool</code>(å¸ƒå°”ä¿®é¥°ç¬¦ï¼Œéœ€è¦ç»“åˆå…¶ä»–å¸ƒå°”ç¬¦å·ä½¿ç”¨)</li>
</ul>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CPUè¿è¡Œæ—¶é—´å¤§äº10sçš„ç›‘æ§é¡¹æ•°æ®</span></span><br><span class="line">node_cpu_seconds_total &gt; 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡å¤§äº90%çš„æœºå™¨</span></span><br><span class="line">(node_memory_MemTotal_bytes - node_memory_MemFree_bytes)/node_memory_MemTotal_bytes &gt; 0.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥çš„HTTPè¯·æ±‚é‡æ˜¯å¦è¶…è¿‡1000ï¼Œå¦‚æœå¤§äº1000åˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0</span></span><br><span class="line">http_requests_total &gt; bool 1000</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>é›†åˆè¿ç®—ç¬¦</strong></p>
</blockquote>
<p>PromQLæ”¯æŒä¸¤ä¸ªç¬æ—¶å‘é‡ä¹‹é—´çš„æ“ä½œï¼Œå¯ä»¥åœ¨ä¸¤ä¸ªç¬æ—¶å‘é‡ä¹‹é—´è¿›è¡Œç›¸åº”çš„é›†åˆæ“ä½œï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„å‘é‡</p>
<ul>
<li><code>and</code> (å¹¶ä¸”)</li>
<li><code>or</code> (æˆ–è€…)</li>
<li><code>unless</code> (æ’é™¤)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vector1 and vector2 ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å‘é‡ï¼Œæ–°å‘é‡åŒ…å«vector1ä¸­å®Œå…¨åŒ¹é…vector2ä¸­çš„å…ƒç´ ç»„æˆ</span><br><span class="line">vector1 or vector2 ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å‘é‡ï¼Œæ–°å‘é‡åŒ…å«vector1å’Œvector2ä¸­æ‰€æœ‰çš„æ ·æœ¬æ•°æ®</span><br><span class="line">vector1 unless vector2 ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„å‘é‡ï¼Œæ–°å‘é‡ç”±vector1ä¸­æ²¡æœ‰ä¸vector2åŒ¹é…çš„å…ƒç´ ç»„æˆ</span><br></pre></td></tr></table></figure>

<h4 id="èšåˆæ“ä½œ"><a href="#èšåˆæ“ä½œ" class="headerlink" title="èšåˆæ“ä½œ"></a>èšåˆæ“ä½œ</h4><p>èšåˆæ“ä½œç¬¦ä½œç”¨äºç¬æ—¶å‘é‡ï¼Œå¯ä»¥å°†ç¬æ—¶è¡¨è¾¾å¼è¿”å›çš„æ ·æœ¬æ•°æ®è¿›è¡Œèšåˆï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æ—¶é—´åºåˆ—ã€‚</p>
<p>Prometheusæä¾›äº†ä¸‹åˆ—å†…ç½®çš„èšåˆæ“ä½œç¬¦ï¼š</p>
<ul>
<li><code>sum ()</code>æ±‚å’Œ</li>
<li><code>min ()</code>æœ€å°å€¼</li>
<li><code>max()</code> æœ€å¤§å€¼</li>
<li><code>avg()</code> å¹³å‡å€¼</li>
<li><code>stddev()</code> æ ‡å‡†å·®</li>
<li><code>stdvar()</code> æ ‡å‡†æ–¹å·®</li>
<li><code>count()</code> è®¡æ•°</li>
<li><code>count_values()</code> å¯¹valueè¿›è¡Œè®¡æ•°</li>
<li><code>bottomk()</code> ånæ¡æ—¶åº</li>
<li><code>topk()</code> å‰næ¡æ—¶åº</li>
<li><code>quantile()</code> åˆ†ä½æ•°</li>
<li><code>by()</code>åˆ†ç»„</li>
</ul>
<p>èšåˆæ“ä½œçš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br></pre></td></tr></table></figure>

<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ±‚å’Œ</span></span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total)		<span class="comment"># CPUè¿è¡Œæ€»æ—¶é—´</span></span><br><span class="line"><span class="built_in">sum</span>(node_cpu_seconds_total)by(cpu)		<span class="comment"># æŒ‰ç…§cpuåˆ†ç»„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡æ•°ï¼Œç»Ÿè®¡è¿”å›äº†å¤šå°‘æ¡æ•°æ®</span></span><br><span class="line">count(node_cpu_seconds_total)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å‰næ¡æ—¶åºå’Œånæ¡æ—¶åº</span></span><br><span class="line">topk(3, <span class="built_in">sum</span>(node_cpu_seconds_total)  by (mode))		<span class="comment"># CPUè¿è¡Œæ—¶é—´æŒ‰æ¨¡å¼åˆ†ç»„ï¼Œç»Ÿè®¡å‰ä¸‰ç»„</span></span><br><span class="line">bottomk(3, <span class="built_in">sum</span>(node_cpu_seconds_total)  by (mode))		<span class="comment"># CPUè¿è¡Œæ—¶é—´æŒ‰æ¨¡å¼åˆ†ç»„ï¼Œç»Ÿè®¡å‰ä¸‰ç»„</span></span><br></pre></td></tr></table></figure>

<h4 id="å†…ç½®å‡½æ•°"><a href="#å†…ç½®å‡½æ•°" class="headerlink" title="å†…ç½®å‡½æ•°"></a>å†…ç½®å‡½æ•°</h4><p>æ­¤å¤„ä»‹ç»ä¸‰ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨äºåŒºé—´å‘é‡</p>
<ul>
<li><code>increase()</code>å¢é•¿é‡</li>
<li><code>rate()</code>å¢é•¿ç‡</li>
<li><code>irate()</code>ç¬æ—¶å¢é•¿ç‡</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">increase() å‡½æ•°ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ªåŒºé—´å‘é‡ï¼Œincreaseå‡½æ•°è·å–åŒºé—´å‘é‡ä¸­çš„ç¬¬ä¸€ä¸ªåæœ€åä¸€ä¸ªæ ·æœ¬å¹¶è¿”å›å…¶å¢é•¿é‡ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹è¡¨è¾¾å¼è®¡ç®—CPUè¿è¡ŒæŒ‡æ ‡çš„å¹³å‡æ¯ç§’å¢é•¿ç‡ï¼šincrease(node_cpu_seconds_total[2m])/120</span><br><span class="line"></span><br><span class="line">rate()å‡½æ•°å¯ä»¥ç›´æ¥è®¡ç®—åŒºé—´å‘é‡åœ¨æ—¶é—´çª—å£å†…å¹³å‡å¢é•¿é€Ÿç‡ã€‚å› æ­¤ï¼Œé€šè¿‡ä¸‹é¢çš„è¡¨è¾¾å¼å¯ä»¥å¾—åˆ°ä¸ä¸Šé¢increaseå‡½æ•°ç›¸åŒçš„ç»“æœï¼šrate(node_cpu_seconds_total[2m])</span><br><span class="line"></span><br><span class="line">éœ€è¦æ³¨æ„çš„æ˜¯,ä½¿ç”¨rate()æˆ–è€…increase()å‡½æ•°å»è®¡ç®—æ ·æœ¬çš„å¹³å‡å¢é•¿é€Ÿç‡ï¼Œå®¹æ˜“é™·å…¥â€œé•¿å°¾é—®é¢˜â€ï¼Œå³æ— æ³•ååº”åœ¨æ—¶é—´çª—å£å†…æ ·æœ¬æ•°æ®çš„çªå‘å˜åŒ–ã€‚ ä¾‹å¦‚ï¼Œå¯¹äºä¸»æœºè€Œè¨€åœ¨2åˆ†é’Ÿçš„æ—¶é—´çª—å£å†…ï¼Œå¯èƒ½åœ¨æŸä¸€ä¸ªç”±äºè®¿é—®é‡æˆ–è€…å…¶å®ƒé—®é¢˜å¯¼è‡´CPUå ç”¨100%çš„æƒ…å†µï¼Œä½†æ˜¯è®¡ç®—æ—¶é—´çª—å£å†…çš„å¹³å‡å¢é•¿ç‡å´æ— æ³•ååº”å‡ºè¯¥é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼ŒPromQLæä¾›äº†å¦å¤–ä¸€ä¸ªçµæ•åº¦æ›´é«˜çš„å‡½æ•°irate()ï¼Œ irateå‡½æ•°æ˜¯é€šè¿‡åŒºé—´å‘é‡ä¸­æœ€åä¸¤ä¸ªæ ·æœ¬æ•°æ®æ¥è®¡ç®—åŒºé—´å‘é‡çš„å¢é•¿é€Ÿç‡ï¼Œæ‰€ä»¥å¯ä»¥è¿‘ä¼¼åæ˜ ç¬æ—¶å¢é•¿ç‡ï¼širate(node_cpu_seconds_total[2m])</span><br><span class="line"></span><br><span class="line">æ€»ç»“ï¼šrateé€‚ç”¨äºå¢é•¿è¶‹åŠ¿ç¨³å®šçš„åœºæ™¯; irateé€‚ç”¨äºæŒ‡æ ‡æ—¶åˆ»å‘ç”Ÿå‰§çƒˆå˜åŒ–çš„åœºæ™¯</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># author: Jason Yin</span></span><br><span class="line"></span><br><span class="line">INSTANCE=`hostname -s`</span><br><span class="line"></span><br><span class="line">DOCKER_NAMES=`docker -H docker-server ps --format <span class="string">&quot;&#123;&#123;.Names&#125;&#125;&quot;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—å•ä¸ªå®¹å™¨çš„è¿è¡Œæ—¶é—´</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_runtime</span></span>()&#123;</span><br><span class="line">    start_time=`docker -H docker-server inspect -f <span class="string">&#x27;&#123;&#123;.State.StartedAt&#125;&#125;&#x27;</span> <span class="variable">$1</span>`</span><br><span class="line">    start_time_stamp=`<span class="built_in">date</span> +%s -d <span class="string">&quot;<span class="variable">$start_time</span>&quot;</span>`</span><br><span class="line">    now=`<span class="built_in">date</span> +%s`</span><br><span class="line">    <span class="built_in">let</span> run_time=<span class="variable">$now</span>-<span class="variable">$start_time_stamp</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$run_time</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$run_time</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span><span class="string">&quot;# HELP docker_runtime time sec</span></span><br><span class="line"><span class="string"># TYPE docker_runtime gauge</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span> &gt; temp.log</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;DOCKER_NAMES&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    runtime=`get_runtime <span class="variable">$i</span>`</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;docker_runtime&#123;name=\&quot;<span class="variable">$i</span>\&quot;&#125; <span class="variable">$runtime</span>&quot;</span> &gt;&gt; temp.log</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">curl --data-binary <span class="string">&quot;@temp.log&quot;</span> http://192.168.110.155:9091/metrics/job/pushgateway/instance/<span class="variable">$INSTANCE</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -f temp.log</span><br></pre></td></tr></table></figure>

<h3 id="Grafanaå‡ºå›¾"><a href="#Grafanaå‡ºå›¾" class="headerlink" title="Grafanaå‡ºå›¾"></a>Grafanaå‡ºå›¾</h3><p>å®‰è£…grafanaï¼Œç„¶åå¯ä»¥ä½¿ç”¨grafanaç¤¾åŒºä¸­æä¾›çš„åœ¨çº¿æ¨¡æ¿ï¼Œä¹Ÿå¯ä»¥æŠŠæ¨¡æ¿ä¸‹è½½ä¸‹æ¥ï¼Œä¿®æ”¹å…¶ä¸­çš„PromQLè¯­å¥å†æ·»åŠ åˆ°è‡ªå·±çš„dashboardï¼Œæ›´è¿›ä¸€æ­¥ï¼Œå¯ä»¥è‡ªå·±åˆ›å»ºdashboardï¼Œè‡ªå·±ç¼–å†™ä¸šåŠ¡ç›¸å…³çš„PromQLè¯­å¥ã€‚</p>
<p>ä¸å†èµ˜è¿°ã€‚</p>
<h2 id="Altermanagerå‘Šè­¦"><a href="#Altermanagerå‘Šè­¦" class="headerlink" title="Altermanagerå‘Šè­¦"></a>Altermanagerå‘Šè­¦</h2><h3 id="éƒ¨ç½²Alertmanager"><a href="#éƒ¨ç½²Alertmanager" class="headerlink" title="éƒ¨ç½²Alertmanager"></a>éƒ¨ç½²Alertmanager</h3><p><code>alertmanager-config.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alert-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">template_email.tmpl:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &#123;&#123; define &quot;email.html&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;</span></span><br><span class="line"><span class="string">        @æŠ¥è­¦&lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- range .Alerts &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;å®ä¾‹:&lt;/strong&gt; &#123;&#123; .Labels.instance &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;æ¦‚è¿°:&lt;/strong&gt; &#123;&#123; .Annotations.summary &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;è¯¦æƒ…:&lt;/strong&gt; &#123;&#123; .Annotations.description &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;æ—¶é—´:&lt;/strong&gt; &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- end -&#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- end &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span></span><br><span class="line"><span class="string">        @æ¢å¤&lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- range .Alerts &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;å®ä¾‹:&lt;/strong&gt; &#123;&#123; .Labels.instance &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;ä¿¡æ¯:&lt;/strong&gt; &#123;&#123; .Annotations.summary &#125;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="string">        &lt;strong&gt;æ¢å¤:&lt;/strong&gt; &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span></span><br><span class="line"><span class="string">        &lt;br&gt;</span></span><br><span class="line"><span class="string">        &#123;&#123;- end -&#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123;- end &#125;&#125;</span></span><br><span class="line"><span class="string">    &#123;&#123; end &#125;&#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">config.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    templates:  # å¢åŠ  templates é…ç½®ï¼ŒæŒ‡å®šæ¨¡æ¿æ–‡ä»¶</span></span><br><span class="line"><span class="string">    - &#x27;/etc/alertmanager/template_email.tmpl&#x27;</span></span><br><span class="line"><span class="string">    inhibit_rules:</span></span><br><span class="line"><span class="string">      - source_match:</span></span><br><span class="line"><span class="string">          alertname: NodeMemoryUsage  </span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        target_match:</span></span><br><span class="line"><span class="string">          severity: normal</span></span><br><span class="line"><span class="string">        equal:</span></span><br><span class="line"><span class="string">          - instance </span></span><br><span class="line"><span class="string">    # ä¸€ã€å…¨å±€é…ç½®</span></span><br><span class="line"><span class="string">    global:		</span></span><br><span class="line"><span class="string">      resolve_timeout: 5m  </span></span><br><span class="line"><span class="string">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span></span><br><span class="line"><span class="string">      smtp_from: &#x27;18611453110@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_username: &#x27;18611453110@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_password: &#x27;YKQQBTNSCEXOONLH&#x27;</span></span><br><span class="line"><span class="string">      smtp_hello: &#x27;163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_require_tls: false</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">    # äºŒã€è®¾ç½®æŠ¥è­¦çš„è·¯ç”±åˆ†å‘ç­–ç•¥</span></span><br><span class="line"><span class="string">    route:</span></span><br><span class="line"><span class="string">      group_by: [&#x27;alertname&#x27;, &#x27;cluster&#x27;]</span></span><br><span class="line"><span class="string">      group_wait: 30s</span></span><br><span class="line"><span class="string">      group_interval: 30s</span></span><br><span class="line"><span class="string">      repeat_interval: 120s</span></span><br><span class="line"><span class="string">      receiver: default 	# é»˜è®¤çš„receiverï¼šå¦‚æœä¸€ä¸ªæŠ¥è­¦æ²¡æœ‰è¢«ä¸€ä¸ªrouteåŒ¹é…ï¼Œåˆ™å‘é€ç»™é»˜è®¤çš„æ¥æ”¶å™¨</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="attr">routes:</span> 	</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">email</span> </span><br><span class="line">        <span class="attr">group_wait:</span> <span class="string">10s</span>  </span><br><span class="line">        <span class="attr">group_by:</span> [<span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line">        <span class="attr">match:</span> 	</span><br><span class="line">          <span class="attr">team:</span> <span class="string">node</span> 	</span><br><span class="line">        <span class="attr">continue:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">mywebhook</span></span><br><span class="line">        <span class="attr">group_wait:</span> <span class="string">10s</span> </span><br><span class="line">        <span class="attr">group_by:</span> [<span class="string">&#x27;instance&#x27;</span>] </span><br><span class="line">        <span class="attr">match:</span></span><br><span class="line">          <span class="attr">team:</span> <span class="string">node</span></span><br><span class="line">    <span class="comment"># ä¸‰ã€å®šä¹‰æ¥æ”¶å™¨ï¼Œä¸ä¸Šé¢çš„è·¯ç”±å®šä¹‰ä¸­å¼•ç”¨çš„receiverç›¸å‘¼åº”</span></span><br><span class="line">    <span class="attr">receivers:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">      <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;378533872@qq.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span>         </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;email&#x27;</span></span><br><span class="line">      <span class="attr">email_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;18611453110@163.com&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">html:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; template &quot;email.html&quot; . &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;mywebhook&#x27;</span></span><br><span class="line">      <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://promoter:8080/dingtalk/webhook1/send&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># alertmanager-deploy.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertcfg</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">alert-config</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">          <span class="comment">#image: prom/alertmanager:v0.27.0 ææˆå›½å†…çš„åœ°å€</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/egon-k8s-test/alertmanager:v0.27.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&#x27;--config.file=/etc/alertmanager/config.yml&#x27;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9093</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&#x27;/etc/alertmanager&#x27;</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">alertcfg</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># alertmanager-svc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<h3 id="Alerté…ç½®ä¼˜åŒ–"><a href="#Alerté…ç½®ä¼˜åŒ–" class="headerlink" title="Alerté…ç½®ä¼˜åŒ–"></a>Alerté…ç½®ä¼˜åŒ–</h3><blockquote>
<p><strong>æŠ¥è­¦è§„åˆ™</strong></p>
</blockquote>
<p>æŠ¥è­¦æŒ‡æ ‡æ˜¯ç”±promtheusé€šè¿‡è®¡ç®—å¾—åˆ°ï¼Œæ‰€ä»¥promtheusçš„é…ç½®æ–‡ä»¶éœ€è¦æœ‰æ‰€æ”¹åŠ¨ï¼š</p>
<p><code>promtheus.yml</code>å¢åŠ ä»¥ä¸‹å†…å®¹ï¼Œå¯¹æ¥alertmanagerï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">alertmanager:9093</span> </span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules.yml</span> </span><br></pre></td></tr></table></figure>

<p>å¢åŠ ä¸€ä¸ª<code>rules.yml</code>æ–‡ä»¶ï¼ŒæŒ‚è½½åˆ°<code>/etc/prometheus/rules.yml</code>ä¸­ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  groups:</span></span><br><span class="line"><span class="string">  - name: recording_rules</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">    - record: job:node_memory_MemFree_bytes:percent</span></span><br><span class="line"><span class="string">      expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100</span></span><br><span class="line"><span class="string">  - name: test-node-mem</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">    - alert: NodeMemoryUsage  </span></span><br><span class="line"><span class="string">      expr: job:node_memory_MemFree_bytes:percent &gt; 20</span></span><br><span class="line"><span class="string">      for: 2m</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        team: node</span></span><br><span class="line"><span class="string">        severity: critical</span></span><br><span class="line"><span class="string">      annotations:</span></span><br><span class="line"><span class="string">        summary: &quot;&#123;&#123;$labels.instance&#125;&#125;: High Memory usage detected&quot;</span></span><br><span class="line"><span class="string">        description: &quot;&#123;&#123;$labels.instance&#125;&#125;: Memory usage is above 20% (current value is: &#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">  - name: test-node-load</span></span><br><span class="line"><span class="string">    rules:</span></span><br><span class="line"><span class="string">      - alert: NodeLoad</span></span><br><span class="line"><span class="string">        expr: node_load5 &lt; 1  # æ•…æ„è®¾ç½®è¿™ä¸ªå€¼ï¼Œè®©å®ƒæŠ¥è­¦ï¼Œæ­£å¸¸åº”è¯¥æ˜¯è¶…è¿‡æŸä¸ªå€¼æ‰æŠ¥è­¦ï¼Œè€Œä¸æ˜¯å°äº</span></span><br><span class="line"><span class="string">        for: 2m</span></span><br><span class="line"><span class="string">        labels: </span></span><br><span class="line"><span class="string">          team: node</span></span><br><span class="line"><span class="string">          severity: normal</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &#x27;&#123;&#123; $labels.instance &#125;&#125;: Low node load deteched&#x27;</span></span><br><span class="line"><span class="string">          description: &#x27;&#123;&#123; $labels.instance &#125;&#125;: node load is below 1 (current value is: &#123;&#123; $value &#125;&#125;)&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>å»¶è¿ŸæŠ¥è­¦</strong></p>
</blockquote>
<p>å»¶è¿Ÿå‘Šè­¦æœºåˆ¶ï¼Œå¯ä»¥ç”¨äºé˜²æ­¢ç¬é—´çš„ã€çŸ­æš‚çš„å™ªéŸ³å¼•èµ·ä¸å¿…è¦çš„å‘Šè­¦ï¼Œä»è€Œæé«˜å‘Šè­¦çš„è´¨é‡å’Œå¯ç”¨æ€§ã€‚ä¸‹é¢æ˜¯ä¸‰ä¸ªé‡è¦çš„å‚æ•°ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å½“ä¸€ä¸ªæ–°çš„æŠ¥è­¦åˆ†ç»„è¢«åˆ›å»ºåï¼Œéœ€è¦ç­‰å¾…è‡³å°‘ group_wait æ—¶é—´æ¥åˆå§‹åŒ–é€šçŸ¥</span></span><br><span class="line"><span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line"><span class="comment"># çŸ­æœŸèšåˆ: group_interval ç¡®ä¿åœ¨çŸ­æ—¶é—´å†…ï¼ŒåŒä¸€åˆ†ç»„çš„å¤šä¸ªå‘Šè­¦å°†ä¼šåˆå¹¶/èšåˆåˆ°ä¸€èµ·ç­‰å¾…è¢«å‘é€ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„å‘Šè­¦é€šçŸ¥ã€‚</span></span><br><span class="line"><span class="attr">group_interval:</span> <span class="string">30s</span></span><br><span class="line"><span class="comment"># é•¿æœŸæé†’: repeat_intervalç¡®ä¿é•¿æ—¶é—´æœªè§£å†³çš„å‘Šè­¦ä¸ä¼šè¢«é—å¿˜ï¼ŒAlertmanageræ¯éš”ä¸€æ®µæ—¶é—´å®šæœŸæé†’ç›¸å…³äººå‘˜ï¼Œç›´åˆ°å‘Šè­¦è¢«è§£å†³ã€‚å®ç°ä¸­ä¸ºå¿«é€Ÿæ˜¾ç¤ºæ•ˆæœè®¾ç½®ä¸º120s,ä¸€èˆ¬æ˜¯ä¸€å°æ—¶æˆ–æ›´ä¹….</span></span><br><span class="line"><span class="attr">repeat_interval:</span> <span class="string">120s</span> </span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä¸‰ä¸ªå‚æ•°çš„ç»¼åˆè§£é‡Šï¼š</p>
<ol>
<li>å½“ä¸€ä¸ªæ–°çš„å‘Šè­¦è¢«åˆ›å»ºæ—¶ï¼Œç­‰å¾…è‡³å°‘ group_wait æ—¶é—´æ¥åˆå§‹åŒ–é€šçŸ¥ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿èƒ½æœ‰è¶³å¤Ÿçš„æ—¶é—´ä¸ºåŒä¸€åˆ†ç»„æ¥è·å–&#x2F;ç´¯ç§¯å¤šä¸ªè­¦æŠ¥ï¼Œç„¶åä¸€èµ·è§¦å‘è¿™ä¸ªæŠ¥è­¦ä¿¡æ¯ã€‚</li>
<li>ç„¶åå¼€å§‹ä¸€ä¸ª group_interval çª—å£(ä¾‹å¦‚ 30 ç§’)ï¼Œåœ¨ group_interval çª—å£å†…ï¼Œä»»ä½•æ–°çš„åŒåˆ†ç»„å‘Šè­¦ä¼šè¢«èšåˆåˆ°ä¸€èµ·ï¼Œä½†ä¸ä¼šç«‹å³è§¦å‘å‘é€ã€‚åˆ°è¾¾çŸ­æœŸèšåˆçš„æ—¶é—´ç‚¹åï¼Œå‘Šè­¦ä¿¡æ¯å°†ä¸€èµ·å‘é€ã€‚</li>
<li>é•¿æœŸèšåˆçš„çª—å£ç”¨äºå»¶è¿ŸåŸæœ‰ä¸ºè§£å†³çš„å‘Šè­¦ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æŠµè¾¾ repeat_interval çš„æ—¶é—´ç‚¹ï¼Œåˆ™åŸæœ‰æœªè§£å†³çš„æŠ¥è­¦ä¸ä¼šé‡å¤å‘é€ï¼Œç›´åˆ°åˆ°è¾¾ä¸‹ä¸€ä¸ª repeat_interval æ—¶é—´ç‚¹ã€‚</li>
</ol>
<blockquote>
<p><strong>åˆ†ç»„åˆå¹¶</strong></p>
</blockquote>
<p>åœ¨å¤æ‚çš„ç›‘æ§ç³»ç»Ÿä¸­ï¼Œå‘Šè­¦è§„åˆ™å¯èƒ½éå¸¸å¤šï¼Œåˆ†ç»„åˆå¹¶çš„æœºåˆ¶å¯ä»¥æ ¹æ®ä¸åŒçš„æœåŠ¡ã€åº”ç”¨æˆ–åŠŸèƒ½æ¨¡å—è¿›è¡Œåˆ†ç±»ï¼Œå°†å¤šä¸ªå‘Šè­¦è¾“å‡ºåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥ï¼Œå‡å°‘å‘Šè­¦é€šçŸ¥çš„æ•°é‡ï¼Œé¿å…å‘Šè­¦é£æš´ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ç”¨äºå‘Šè­¦åˆ†ç»„çš„æ ‡ç­¾ã€‚å½“æœ‰å¤šä¸ªå‘Šè­¦æ¶ˆæ¯æœ‰ç›¸åŒçš„ alertname å’Œ cluster æ ‡ç­¾æ—¶ï¼Œè¿™äº›å‘Šè­¦æ¶ˆæ¯å°†ä¼šè¢«èšåˆåˆ°åŒä¸€ä¸ªåˆ†ç»„ä¸­</span></span><br><span class="line"><span class="attr">group_by:</span> [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;cluster&#x27;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>é™é»˜</strong></p>
</blockquote>
<p>é™é»˜æœºåˆ¶å¯ä»¥è®©ä¸€äº›ç›‘æ§æŠ¥è­¦åœ¨æˆ‘ä»¬è®¾å®šçš„æ—¶é—´å†…å“‘ç«&#x2F;é—­å˜´ï¼Œä¸è¦è®©å…¶ä¸€ç›´å‘æŠ¥è­¦ï¼Œé™é»˜çš„åº”ç”¨åœºæ™¯ä¸€èˆ¬æ˜¯åœ¨å¤„ç†å·²çŸ¥é—®é¢˜æˆ–ç»´æŠ¤æœŸé—´ï¼Œé¢‘ç¹è§¦å‘å¹¶å‘é€çš„æŠ¥è­¦ä¿¡æ¯ååˆ†çƒ¦äººï¼Œå¯ä»¥å¯¹è¯¥æŠ¥è­¦è¿›è¡Œé™é»˜è®¾ç½®ã€‚</p>
<p>é™é»˜æ˜¯åœ¨alertmanagerçš„ç®¡ç†ç•Œé¢ä¸­é…ç½®çš„ã€‚</p>
<blockquote>
<p><strong>æŠ‘åˆ¶</strong></p>
</blockquote>
<p>æŸä¸ªå‘Šè­¦è§¦å‘åï¼Œä¸å…¶ç›¸å…³çš„ä¸€äº›æŠ¥è­¦å¯èƒ½ä¼´éšç€ä¸€é½è§¦å‘ï¼Œæ¯”å¦‚èŠ‚ç‚¹å®•æœºäº†ï¼Œä¼šè§¦å‘èŠ‚ç‚¹å®•æœºçš„æŠ¥è­¦ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„æœåŠ¡ä¹Ÿéƒ½æŒ‚æ‰äº†ä¹Ÿä¼šè§¦å‘ä¸€ç³»åˆ—è¿™äº›æœåŠ¡çš„æ•…éšœæŠ¥è­¦ï¼Œç„¶è€Œæ ¹å› æ˜¯èŠ‚ç‚¹å®•æœºäº†ï¼Œæ‰€ä»¥é‚£äº›éšä¹‹äº§ç”Ÿçš„æŠ¥è­¦é¡¹æ˜¯æ— ç”¨çš„å¹²æ‰°é¡¹ï¼Œåº”è¯¥åŠ ä»¥æŠ‘åˆ¶ã€‚</p>
<p>å¯ä»¥åœ¨promtheusçš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æŠ‘åˆ¶è§„åˆ™ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span>		<span class="comment"># ç”¨äºåŒ¹é…é‚£äº›è§¦å‘äº†çš„å‘Šè­¦è§„åˆ™ä¸­çš„æ ‡ç­¾</span></span><br><span class="line">      <span class="attr">alertname:</span> <span class="string">NodeMemoryUsage</span> 	<span class="comment"># å‘Šè­¦è§„åˆ™çš„åå­—ï¼Œpromethusè‡ªåŠ¨æ·»åŠ çš„æ ‡ç­¾</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">critical</span>			<span class="comment"># ç”¨äºæ ‡è®°å‘Šè­¦ç­‰çº§çš„æ ‡ç­¾</span></span><br><span class="line">    <span class="attr">target_match:</span>		<span class="comment"># ç”¨æ¥åŒ¹é…é‚£äº›éœ€è¦è¢«æŠ‘åˆ¶çš„å‘Šè­¦è§„åˆ™çš„æ ‡ç­¾</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">normal</span> 	</span><br><span class="line">    <span class="attr">equal:</span>				</span><br><span class="line">      <span class="bullet">-</span> <span class="string">instance</span>      <span class="comment"># instanceä¹Ÿæ˜¯è­¦è§„åˆ™è‡ªå¸¦çš„æ ‡ç­¾ï¼Œå¯¹åº”èŠ‚ç‚¹åã€‚è¿™é‡ŒåŒä¸€èŠ‚ç‚¹ä¸Šçš„normalç­‰çº§çš„å‘Šè­¦ä¼šè¢«æŠ‘åˆ¶</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>å‘Šè­¦æ¢å¤ä¸é€šçŸ¥</strong></p>
</blockquote>
<p>å‘Šè­¦äº§ç”Ÿä¹‹åï¼Œéœ€è¦ç»™è¿ç»´äººå‘˜å‘é€é€‚å½“çš„é€šçŸ¥ï¼Œå‘Šè­¦æ¢å¤ä¹‹åï¼Œè‡ªç„¶ä¹Ÿéœ€è¦å‘ŠçŸ¥ç›¸å…³äººå‘˜ç³»ç»Ÿå‘Šè­¦çŠ¶æ€å·²æ¢å¤ã€‚ä¹‹æ‰€ä»¥æŠŠå‘Šè­¦æ¢å¤ä¸é€šçŸ¥æ”¾åˆ°ä¸€å—ï¼Œæ˜¯å› ä¸ºæœ¬è´¨ä¸Šï¼Œå‘Šè­¦æ¢å¤æœºåˆ¶ä¹Ÿæ˜¯é€šè¿‡å‘Šè­¦çŠ¶æ€çš„é€šçŸ¥é€»è¾‘æ¥å®ç°çš„ã€‚</p>
<p>ä¸‹é¢æ˜¯å®šä¹‰çš„ä¸€ä¸ªè·¯ç”±åŒ¹é…è§„åˆ™å’Œæ¥æ”¶è€…</p>
<p>è·¯ç”±åŒ¹é…ï¼Œè¿™æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå­è·¯ç”±ï¼Œç»§æ‰¿çˆ¶è·¯ç”±çš„æ‰€æœ‰å±æ€§ï¼Œå¯ä»¥è¿›è¡Œè¦†ç›–å’Œæ›´å…·ä½“çš„è§„åˆ™åŒ¹é…ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">email</span>  			<span class="comment">#  åŒ¹é…æ­¤å­è·¯ç”±çš„å‘Šè­¦å°†å‘é€åˆ°çš„æ¥æ”¶å™¨ï¼Œè·Ÿä¸‹é¢çš„æ¥æ”¶è€…å¯¹åº”</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span>  			<span class="comment">#  ç­‰å¾…æ—¶é—´ï¼Œå¯è¦†ç›–çˆ¶è·¯ç”±çš„</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;instance&#x27;</span>]		<span class="comment"># æ ¹æ®instanceåšåˆ†ç»„</span></span><br><span class="line">  <span class="attr">match:</span> 			<span class="comment"># å‘Šè­¦æ ‡ç­¾åŒ¹é…æ¡ä»¶ï¼Œåªæœ‰åŒ¹é…åˆ°ç‰¹å®šæ¡ä»¶çš„å‘Šè­¦æ‰ä¼šåº”ç”¨è¯¥å­è·¯ç”±è§„åˆ™ã€‚</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">node</span> 	<span class="comment"># åªæœ‰æ‹¥æœ‰ team=node æ ‡ç­¾çš„å‘Šè­¦æ‰ä¼šè·¯ç”±åˆ° email æ¥æ”¶å™¨ã€‚</span></span><br><span class="line">  <span class="attr">continue:</span> <span class="literal">true</span>	<span class="comment"># åŒ¹é…åˆ°è¿™ä¸ªè·¯ç”±ä¹‹åï¼Œå…è®¸ç»§ç»­å‘ä¸‹åŒ¹é…</span></span><br></pre></td></tr></table></figure>

<p>æ¥æ”¶è€…çš„å®šä¹‰</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;email&#x27;</span>		<span class="comment"># è·Ÿä¸Šé¢çš„è·¯ç”±åŒ¹é…ä¸­å®šä¹‰çš„receiverå¯¹åº”</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">&#x27;378533872@qq.com&#x27;</span></span><br><span class="line">    <span class="attr">html:</span> <span class="string">&#x27;<span class="template-variable">&#123;&#123; template &quot;email.html&quot; . &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="attr">send_resolved:</span> <span class="literal">true</span>  <span class="comment"># å‘Šè­¦çŠ¶æ€æ¢å¤æ—¶ï¼Œæ˜¯å¦å‘é€é€šçŸ¥</span></span><br></pre></td></tr></table></figure>

<p>Promtheusä¸­çš„å‘Šè­¦è§„åˆ™æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼š<code>alerting</code> å’Œ <code>resolved</code>ã€‚åœ¨ä¸Šé¢çš„å‘Šè­¦è§„åˆ™ä¸­ï¼Œå…³é”®å­—<code>for</code>çš„å€¼æ˜¯2mï¼Œä»£è¡¨å½“å‘Šè­¦æ¡ä»¶<code>expr</code>åœ¨å®šä¹‰çš„æŒç»­æ—¶é—´å†…ä¿æŒä¸º<code>true</code>æ—¶ï¼Œå‘Šè­¦è§¦å‘ï¼Œå‘Šè­¦çŠ¶æ€å˜ä¸º<code>alerting</code>ï¼Œä¼šç»™alertmanagerå‘é€å‘Šè­¦çŠ¶æ€ï¼Œåœ¨alertmanagerä¸­ï¼Œæœ‰ä¸€ä¸ªå‚æ•°<code>resolve_timeout: 5m</code> ï¼Œä»£è¡¨å½“alertmanageræŒç»­å¤šé•¿æ—¶é—´æœªæ¥æ”¶åˆ°å‘Šè­¦åï¼Œæ ‡è®°å‘Šè­¦çŠ¶æ€ä¸º <code>resolved</code>ï¼Œå³æ¢å¤çŠ¶æ€ã€‚</p>
<blockquote>
<p><strong>å®šåˆ¶æ¨¡æ¿</strong></p>
</blockquote>
<p>å‡å°‘æ— ç”¨ä¿¡æ¯ï¼Œçªå‡ºé‡ç‚¹ä¿¡æ¯ï¼Œå¢å¼ºå¯è¯»æ€§ï¼Œç¾è§‚ã€‚</p>
<p>ä¸‹é¢æ˜¯åœ¨alertmanagerä¸­å®šä¹‰çš„ä¸€ä¸ªé‚®ä»¶æ¨¡æ¿ï¼Œ<code>template_email.tmpl</code>ï¼Œä½œä¸ºä¸€ä¸ªæ–‡ä»¶å•ç‹¬æŒ‚è½½ï¼Œå¯ä»¥åœ¨receiversä¸­é€šè¿‡è‡ªå®šä¹‰çš„åå­—<code>email.html</code>è¢«æŒ‡å®š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">template_email.tmpl: |-</span><br><span class="line">  &#123;&#123; define &quot;email.html&quot; &#125;&#125;</span><br><span class="line">  &#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class="line">      @æŠ¥è­¦<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- range .Alerts &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>å®ä¾‹:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Labels.instance &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>æ¦‚è¿°:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Annotations.summary &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>è¯¦æƒ…:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Annotations.description &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>æ—¶é—´:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- end -&#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  &#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class="line">      @æ¢å¤<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- range .Alerts &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>å®ä¾‹:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Labels.instance &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>ä¿¡æ¯:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; .Annotations.summary &#125;&#125;<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">strong</span>&gt;</span>æ¢å¤:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      &#123;&#123;- end -&#125;&#125;</span><br><span class="line">  &#123;&#123;- end &#125;&#125;</span><br><span class="line">  &#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>æ€§èƒ½ä¼˜åŒ–</strong></p>
</blockquote>
<p>å½“Promtheusä¸­çš„å‘Šè­¦è§„åˆ™è¿‡å¤šæ—¶ï¼Œä¸å¯é¿å…çš„ä¼šå¢å¤§ç³»ç»Ÿå¼€é”€ï¼Œæ‰€ä»¥æ€§èƒ½ä¼˜åŒ–ä¹Ÿæ˜¯éœ€è¦æ³¨æ„çš„ä¸€ä¸ªç‚¹ã€‚</p>
<p>åŸºäºRecording Ruleæœºåˆ¶ï¼Œå¯ä»¥æŠŠå¤šæ¡æŠ¥è­¦è§„åˆ™é‡Œå…±ç”¨çš„è¡¨è¾¾å¼æå–å‡ºæ¥ï¼Œç”±prometheus serverå‘¨æœŸæ€§è®¡ç®—ã€è®¡ç®—çš„ç»“æœå½“æˆä¸€ä¸ªæŒ‡æ ‡&#x2F;æ—¶åºæ•°æ®å­˜æ”¾ä¸‹æ¥ï¼Œå¦‚æ­¤ï¼Œå…¶ä»–çš„æŠ¥è­¦è§„åˆ™ç›´æ¥å…±ç”¨è¯¥ç°æˆçš„ç»“æœå³å¯ï¼Œé¿å…é‡å¤çš„è®¡ç®—çš„å¼€é”€ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªRecording Ruleæœºåˆ¶çš„ä¾‹å­ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">recording_rules</span></span><br><span class="line">      <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">job:node_memory_MemFree_bytes:percent</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(node_memory_MemTotal_bytes</span> <span class="bullet">-</span> <span class="string">(node_memory_MemFree_bytes</span> <span class="string">+</span> <span class="string">node_memory_Buffers_bytes</span> <span class="string">+</span> <span class="string">node_memory_Cached_bytes))</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes</span> <span class="string">*</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒæŠŠå¤æ‚çš„è¡¨è¾¾å¼å®šä¹‰äº†ä¸€ä¸ªæ–°çš„åå­—<code>job:node_memory_MemFree_bytes:percent</code>ï¼Œè¿™ä¸ªåå­—å¯ä»¥åœ¨å…¶ä»–å‘Šè­¦è§„åˆ™ä¸­è¢«å¼•ç”¨ï¼Œå®ç°é‡ç”¨ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ç›´æ¥åœ¨Promtheusä¸­ä½¿ç”¨è¿™ä¸ªåå­—ä»£æ›¿PromQLè¯­å¥æŸ¥è¯¢ã€‚</p>
<h3 id="å¯¹æ¥ç¬¬ä¸‰æ–¹OAè½¯ä»¶"><a href="#å¯¹æ¥ç¬¬ä¸‰æ–¹OAè½¯ä»¶" class="headerlink" title="å¯¹æ¥ç¬¬ä¸‰æ–¹OAè½¯ä»¶"></a>å¯¹æ¥ç¬¬ä¸‰æ–¹OAè½¯ä»¶</h3><p>æŠ¥è­¦ä¿¡æ¯æ¨é€åˆ°é’‰é’‰ã€é£ä¹¦ã€ä¼ä¸šå¾®ä¿¡ç­‰OAè½¯ä»¶</p>
<p>éƒ¨ç½²å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/feiyu563/PrometheusAlert">https://github.com/feiyu563/PrometheusAlert</a></p>
<h2 id="Promethues-Operator"><a href="#Promethues-Operator" class="headerlink" title="Promethues Operator"></a>Promethues Operator</h2><p>æœ‰äººå¼€å‘äº†ä¸€ä¸ªç®¡ç†æ•´ä¸ªprometheusç›‘æ§ä½“ç³»çš„æ§åˆ¶å™¨ï¼ŒåŒ…å«prometheus serverã€alertmanagerã€grafanaç­‰ç»„ä»¶ï¼Œå¹¶ä¸”å¯ä»¥å®ç°é…ç½®æ–‡ä»¶ã€alertmanagerçš„å¯¹æ¥åœ°å€ã€å‘Šè­¦è§„åˆ™çš„è‡ªåŠ¨æ›´æ–°ã€‚</p>
<p>éƒ¨ç½²å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></p>
<h2 id="Promethues-Operatoré«˜çº§ç”¨æ³•"><a href="#Promethues-Operatoré«˜çº§ç”¨æ³•" class="headerlink" title="Promethues Operatoré«˜çº§ç”¨æ³•"></a>Promethues Operatoré«˜çº§ç”¨æ³•</h2></div><script src="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery) {
        var options1 = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-01-11</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« é‚“èƒ–èƒ–</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/Prometheus/'>
                            Prometheus
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/'>
                            å­¦ä¹ ç¬”è®°
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
             

            
                

            
        </span>
    
</div>
<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>