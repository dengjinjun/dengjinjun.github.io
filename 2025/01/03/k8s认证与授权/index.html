<!DOCTYPE html>
<html lang="en">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="K8Sè®¤è¯ä¸æˆæƒ" />
    <meta name="hexo-theme-A4" content="v1.9.1" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Dengpangpang</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Dengpangpang</a> 
            <span class="description"></span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">ğŸŸé¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">ğŸ“æ–‡ç« </a></li>
            
        
            
                <li><a href="/tags/">ğŸ·ï¸æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">ğŸ—‚ï¸åˆ†ç±»</a></li>
            
        
            
                <li><a href="/about/">ğŸ‘ï¸å…³äº</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            K8Sè®¤è¯ä¸æˆæƒ
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#k8s%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83"><span class="post-toc-text">k8sè®¤è¯ä¸æˆæƒ</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#API%E8%AE%BE%E8%AE%A1%E7%BB%93%E6%9E%84"><span class="post-toc-text">APIè®¾è®¡ç»“æ„</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%AE%A4%E8%AF%81%E3%80%81%E6%8E%88%E6%9D%83%E3%80%81%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6"><span class="post-toc-text">è®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#APIServer%E9%AA%8C%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="post-toc-text">APIServeréªŒè¯æµç¨‹</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#RBAC%E6%9C%BA%E5%88%B6"><span class="post-toc-text">RBACæœºåˆ¶</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#context%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="post-toc-text">contextä¸Šä¸‹æ–‡</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ServiceAccount"><span class="post-toc-text">ServiceAccount</span></a></li></ol></li></ol></li></ol>
            
        
        <link rel="stylesheet" type="text/css" href="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/css/lightgallery.min.css" /><div class=".article-gallery"><h1 id="k8sè®¤è¯ä¸æˆæƒ"><a href="#k8sè®¤è¯ä¸æˆæƒ" class="headerlink" title="k8sè®¤è¯ä¸æˆæƒ"></a>k8sè®¤è¯ä¸æˆæƒ</h1><h2 id="APIè®¾è®¡ç»“æ„"><a href="#APIè®¾è®¡ç»“æ„" class="headerlink" title="APIè®¾è®¡ç»“æ„"></a>APIè®¾è®¡ç»“æ„</h2><p>apiserverçš„æ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<ol>
<li><p>å¯¹ç»„ä»¶çš„è´¡çŒ®</p>
<p>å¯¹ä¸‹å°è£…äº†å¯¹etcdæ•°æ®åº“çš„æ“ä½œã€å¯¹ä¸Šæä¾›äº†list-watchæœºåˆ¶</p>
</li>
<li><p>å¯¹å®¢æˆ·ç«¯çš„è´¡çŒ®</p>
<p>å¯¹å®¢æˆ·ç«¯æä¾›äº†apiæ¥å£ï¼ˆæ€»ä½“æ¥æ˜¯åŸºäºRESTFulé£æ ¼è®¾è®¡apiï¼‰</p>
</li>
<li><p>å¯¹å®‰å…¨çš„è´¡çŒ®</p>
<p>è®¤è¯ï¼šæ£€æŸ¥å‡­è¯ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªåˆæ³•è´¦å·</p>
<p>æˆæƒï¼šéªŒè¯è´¦å·å¯¹è¯·æ±‚ä¸­æŒ‡å®šçš„apiæœ‰æ²¡æœ‰æ“ä½œæƒé™</p>
<p>å‡†å…¥æ§åˆ¶ï¼šæä¾›äº†ä¸¤ç§webhookï¼šmutateå’Œvalidate</p>
</li>
</ol>
<blockquote>
<p><strong>APIç»„ç»‡å½¢å¼</strong></p>
</blockquote>
<p>ä¸ºäº†æ–¹ä¾¿æ‰©å±•ä¸æ¼”è¿›ï¼ŒAPIæ¥å£æ”¯æŒåˆ†ç»„ä¸å¤šç‰ˆæœ¬ï¼Œè¿™äº›ç»„ç»‡å½¢å¼ç›´æ¥ä½“ç°åœ¨è®¿é—®èµ„æºçš„RESTful APIä¸Šï¼š</p>
<p><a href="/../pic/image-20250102224445019.png" title="image-20250102224445019" class="gallery-item" style="box-shadow: none;"> <img src="/../pic/image-20250102224445019.png" alt="image-20250102224445019"></a></p>
<ul>
<li><p>é¡¶çº§è·¯å¾„<code>/</code>ï¼šæ‰€æœ‰èµ„æºçš„èµ·å§‹è·¯å¾„</p>
</li>
<li><p>é¡¶çº§å¤§ç±»ï¼šé¡¶çº§è·¯å¾„ä¸‹é¢æœ‰è‹¥å¹²é¡¶çº§å¤§ç±»ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><p>æ ¸å¿ƒèµ„æº <code>/api</code> ï¼šåŒ…å«kubernetesçš„åŸºç¡€èµ„æºå’ŒåŠŸèƒ½ï¼Œä¸‹é¢æ²¡æœ‰åˆ†ç»„</p>
</li>
<li><p>æ‰©å±•èµ„æº <code>/apis </code>ï¼šåŒ…å«æ ¸å¿ƒèµ„æºä¹‹å¤–çš„èµ„æºï¼Œä¸‹é¢ç»†åˆ†ä¸º<code>apps</code>ï¼Œ<code>batch</code>ç­‰èµ„æºç»„ï¼Œæ¯”å¦‚å„ç§æ§åˆ¶å™¨ç­‰ï¼Œä½¿ç”¨<code>/apis/&#123;group&#125;/</code>è·¯å¾„ã€‚</p>
</li>
<li><p>å¥åº·æ£€æŸ¥ç±» <code>/healthz </code>ï¼šç”¨äºæ£€æŸ¥ Kubernetes API Server çš„å¥åº·çŠ¶æ€</p>
</li>
<li><p>æ€§èƒ½æŒ‡æ ‡ç±» <code>/metrics </code>ï¼šç”¨äºè·å– Kubernetes API Server çš„æ€§èƒ½æŒ‡æ ‡æ•°æ®</p>
</li>
</ul>
</li>
<li><p>ç»†åˆ†ç»„ï¼šé¡¶çº§å¤§ç±»ä¸‹é¢åˆç»†åˆ†ä¸º<code>apps</code>ï¼Œ<code>batch</code>ç­‰èµ„æºç»„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨<code>kubectl explain èµ„æº</code>çœ‹åˆ°çš„Groupå­—æ®µçš„å€¼ã€‚èµ„æºç»„ä¸»è¦å­˜åœ¨äºæ‰©å±•èµ„æºå¤§ç±»ä¸‹é¢ï¼Œæ ¸å¿ƒèµ„æºç›´æ¥ä½¿ç”¨<code>/api/v1</code>è·¯å¾„</p>
</li>
<li><p>ç‰ˆæœ¬å·ï¼šæŸç§èµ„æºçš„ç‰ˆæœ¬å·ï¼Œä¸ºäº†æ”¯æŒç‹¬ç«‹çš„æ¼”è¿›ï¼Œkubernetes API æ”¯æŒä¸åŒçš„ç‰ˆæœ¬ï¼Œä»£è¡¨ä¸åŒçš„æˆç†Ÿåº¦</p>
<ul>
<li><p><code>alpha1</code>çº§åˆ«ï¼šæ¯”å¦‚<code>v1alpha1</code>ï¼Œæµ‹è¯•åŠŸèƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„</p>
</li>
<li><p><code>Beta</code>çº§åˆ«ï¼šæ¯”å¦‚<code>v2beta1</code>ï¼Œè¡¨ç¤ºåŠŸèƒ½å·²ç»å®ƒé€šè¿‡äº†å¾ˆå¥½çš„æµ‹è¯•ï¼Œä½†æ˜¯åœ¨éšåçš„ç‰ˆæœ¬ä¸­ä»æœ‰å¯èƒ½å‘ç”Ÿæ›´æ”¹ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯å¯ç”¨çš„ã€‚</p>
</li>
<li><p>ç¨³å®šçº§åˆ«ï¼Œæ¯”å¦‚<code>v1</code>ï¼Œå½“å‰ä»¥åŠåç»­çš„å¾ˆå¤šç‰ˆæœ¬ä¼šæŒç»­ç¨³å®šçš„ç‰ˆæœ¬ã€‚</p>
</li>
</ul>
</li>
<li><p>èµ„æºç±»å‹ï¼šå…·ä½“çš„èµ„æºç±»å‹ï¼Œæ¯”å¦‚<code>Pods</code>ï¼Œ<code>namespaces</code>ç­‰ï¼Œä¸å¤šä»‹ç»ã€‚</p>
</li>
</ul>
<p>æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ kubernetes ä¸­çš„ api å±‚çº§</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get --raw /</span><br><span class="line">kubectl get --raw /apis</span><br><span class="line">kubectl get --raw /apis/apps</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="è®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶"><a href="#è®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶" class="headerlink" title="è®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶"></a>è®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶</h2><h3 id="APIServeréªŒè¯æµç¨‹"><a href="#APIServeréªŒè¯æµç¨‹" class="headerlink" title="APIServeréªŒè¯æµç¨‹"></a>APIServeréªŒè¯æµç¨‹</h3><ol start="0">
<li><p>è¯†åˆ«(Identification)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APIServeré¦–å…ˆéœ€è¦è¯†åˆ«ç”¨æˆ·å®ä½“(Subject),è¯†åˆ«çš„å…³é”®æ˜¯ç”¨æˆ·å®ä½“å…·æœ‰ä¸€ä¸ªè®¿é—®APIServerçš„identityèº«ä»½ï¼Œä½†æ˜¯å‡†ç¡®æ¥è¯´ï¼Œè¯†åˆ«è¿™ä¸€æ­¥å¹¶ä¸åœ¨APIServerçš„éªŒè¯æµç¨‹é‡Œé¢ï¼Œå› ä¸ºç”¨æˆ·å®ä½“åªæ˜¯ä¸€ä¸ªä»£å·ï¼ŒçœŸæ­£ç”¨äºè®¤è¯çš„ä¸œè¥¿æ˜¯ç”¨æˆ·å®ä½“å…³è”çš„å‡­è¯ï¼Œæ¯”å¦‚token,secretç­‰ã€‚</span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¤è¯(Authentication)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APIServeréœ€è¦å¯¹ç”¨æˆ·å®ä½“æ‰€å…³è”çš„å‡­è¯è¿›è¡Œè®¤è¯ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºtoken,secret,è¯ä¹¦ï¼Œhttp+ssl/tlsç­‰æ–¹å¼ï¼Œç”¨äºç¡®è®¤ç”¨æˆ·èº«ä»½ã€‚</span><br></pre></td></tr></table></figure>
</li>
<li><p>æˆæƒ(Authorization)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è®¤è¯æˆåŠŸä¹‹åï¼ŒAPIServerè¿˜éœ€è¦ç¡®è®¤è¯¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰§è¡Œç›¸å…³è¯·æ±‚æ“ä½œçš„æƒé™ã€‚åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œkubernetesæä¾›äº†å‡ ç§æˆæƒæ¨¡å¼ï¼Œæ¯”å¦‚åŸºäºè§’è‰²è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰æˆ–åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰</span><br></pre></td></tr></table></figure>
</li>
<li><p>å‡†å…¥æ§åˆ¶(Admission Controllers)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è¯·æ±‚è¾¾åˆ°APIServerä¹‹åï¼Œé€šè¿‡äº†è®¤è¯å’Œæˆæƒï¼Œä½†æ˜¯åœ¨å°†æ•°æ®æŒä¹…åŒ–åˆ°etcdä¹‹å‰ï¼Œè¿˜éœ€è¦è¿›è¡Œå‡†å…¥æ§åˆ¶ï¼Œè¿™ä¸€é˜¶æ®µå‘ç”Ÿçš„äº‹æƒ…æ˜¯æ‹¦æˆªè¯·æ±‚è¿›è¡Œmutateæˆ–è€…validateæ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰ä»‹ç»çš„APIServeræä¾›çš„ä¸¤ç§webhookã€‚</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="RBACæœºåˆ¶"><a href="#RBACæœºåˆ¶" class="headerlink" title="RBACæœºåˆ¶"></a>RBACæœºåˆ¶</h3><p>RBAC(Role Base Access Control)ï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œkubernetes å¹¶ä¸ä¼šç›´æ¥æŠŠæƒé™èµ‹ç»™æŸä¸ªç”¨æˆ·æˆ–è€…æŸä¸ªç”¨æˆ·ç»„ï¼Œè€Œæ˜¯æŠŠæƒé™èµ‹ç»™æŸä¸ªè§’è‰²(<code>Role</code>æˆ–è€…<code>Cluster Role</code>)ï¼Œç”¨æˆ·å¦‚æœéœ€è¦ç›¸å…³æƒé™ï¼Œå¯ä»¥é€šè¿‡<code>RoleBinding</code>æˆ–è€…<code>ClusterRoleBinding</code>æ¥ç»‘å®šåˆ°å…·ä½“çš„æŸä¸ªè§’è‰²ã€‚</p>
<p>RBACçš„æ ¸å¿ƒæ¦‚å¿µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">						ç»‘å®š										å…³è”</span><br><span class="line">ç”¨æˆ·å®ä½“(ç”¨æˆ·ã€ç»„ã€sa)----------------&gt; è§’è‰²(Roleã€ClusterRole) ----------------&gt; æƒé™(rules)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>è§’è‰²å’Œç»‘å®š</strong></p>
</blockquote>
<p>è§’è‰²åˆ†ä¸ºä¸¤å¤§ç±»ï¼šRoleå’ŒClusterRole</p>
<ul>
<li><p>Role</p>
<p>ç§æœ‰çš„è§’è‰²ï¼Œ<strong>æ­¤ç±»è§’è‰²åªèƒ½å¤Ÿåœ¨å•ä¸ªåç§°ç©ºé—´å†…è¢«çœ‹åˆ°å¹¶åŠ ä»¥å¼•ç”¨</strong>ï¼Œä»£è¡¨è¯¥è§’è‰²æ˜¯è¯¥å‘½åç©ºé—´ç§æœ‰çš„ï¼Œä½†æ˜¯ç§æœ‰è§’è‰²Roleå¹¶ä¸ä¸€å®šåªæ‹¥æœ‰å•ä¸ªå‘½åç©ºé—´çš„æƒé™ï¼Œå®ƒæ˜¯å¦æ‹¥æœ‰æ‰€æœ‰å‘½åç©ºé—´çš„æƒé™ï¼Œå–å†³äºå®ƒçš„ç»‘å®šæ–¹å¼ã€‚</p>
</li>
<li><p>Cluster Role</p>
<p>å…¬å…±çš„è§’è‰²ï¼Œ<strong>æ­¤ç±»è§’è‰²èƒ½å¤Ÿè¢«æ‰€æœ‰çš„åç§°ç©ºé—´çœ‹åˆ°å¹¶åŠ ä»¥å¼•ç”¨</strong>ï¼Œä»£è¡¨æ­¤ç±»è§’è‰²æ˜¯å…¬å…±çš„ã€‚</p>
</li>
</ul>
<p>ç»‘å®šæ˜¯å°†ç”¨æˆ·å®ä½“ä¸æŸä¸ªè§’è‰²è¿›è¡Œå…³è”çš„æ“ä½œã€‚ç»‘å®šæ–¹å¼ä¹Ÿåˆ†ä¸ºä¸¤ç§ï¼šrolebindingå’Œclusterrolebindingã€‚</p>
<ul>
<li><p>rolebinding</p>
<p>ç”¨æˆ·å®ä½“é€šè¿‡rolebindingçš„æ–¹å¼ç»‘å®šæŸä¸ªRoleè§’è‰²ï¼Œ<strong>å¯ä»¥å°†ç”¨æˆ·é”å®šåœ¨æŸä¸ªå‘½åç©ºé—´å†…</strong>ï¼Œæ­¤æ—¶è¯¥ç”¨æˆ·åªå…·æœ‰å•ä¸ªå‘½åç©ºé—´çš„ç›¸å…³æ“ä½œã€‚</p>
</li>
<li><p>clusterrolebinding</p>
<p>ç”¨æˆ·å®ä½“é€šè¿‡clusterrolebindingçš„æ–¹å¼ç»‘å®šæŸä¸ªCluster Roleè§’è‰²ï¼Œ<strong>é‚£ä¹ˆè¯¥ç”¨æˆ·çš„æƒé™èŒƒå›´åœ¨æ•´ä¸ªé›†ç¾¤</strong>ã€‚</p>
</li>
</ul>
<p><strong>æ‰©å±•ï¼š</strong></p>
<p>å¦å¤–è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„ç»‘å®šæ–¹å¼ï¼šç”¨æˆ·å®ä½“ä»¥rolebindingçš„æ–¹å¼ç»‘å®šæŸä¸ªCluster Roleè§’è‰²ï¼Œè¿™æ—¶ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰€æœ‰å‘½åç©ºé—´çš„æƒé™ï¼Ÿ</p>
<p>å…¶å®å¹¶æ²¡æœ‰ï¼Œç”¨æˆ·æƒé™ä»ç„¶è¢«é”å®šåœ¨å•ä¸ªå‘½åç©ºé—´å†…ï¼Œå› ä¸ºæ˜¯å¦æ‹¥æœ‰æ‰€æœ‰å‘½åç©ºé—´çš„æƒé™ï¼Œå¹¶ä¸æ˜¯è§’è‰²å†³å®šçš„ï¼Œè€Œæ˜¯ç”±ç»‘å®šæ–¹å¼å†³å®šçš„ã€‚è¿™ç§æ“ä½œçœ‹ä¼¼æ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯åˆä¸€ä¸ªåœºæ™¯ï¼Œæ˜¯é›†ç¾¤å†…è®¸å¤šä¸ªç”¨æˆ·ï¼Œéœ€è¦å…·æœ‰å„è‡ªçš„å•ä¸ªå‘½åç©ºé—´ä¸‹ç›¸åŒçš„æƒé™ï¼Œå¦‚æœä¸é‡‡å–è¿™ç§æ–¹å¼ï¼Œåªèƒ½ç»™æ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ªRoleï¼Œç„¶åä¸€å¯¹ä¸€ç»‘å®šï¼Œç®¡ç†å’Œæ§åˆ¶å¾ˆéº»çƒ¦ã€‚å¦‚æœé‡‡ç”¨è¿™ç§å¤šä¸ªç”¨æˆ·é€šè¿‡rolebindingçš„ç»‘å®šæ–¹å¼æ¥ç»‘å®šåŒä¸€ä¸ªCluster Roleï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°éœ€æ±‚ï¼Œä¹Ÿä¸ä¼šé€ æˆæƒé™æº¢å‡ºã€‚</p>
<blockquote>
<p><strong>rules</strong></p>
</blockquote>
<p>rulesæ˜¯è§„åˆ™é›†ï¼Œå®šä¹‰åœ¨Roleå’ŒCluster Roleçš„yamlæ–‡ä»¶ä¸­ï¼Œä»£è¡¨æŸä¸ªè§’è‰²å¯¹é‚£äº›APIèµ„æºç»„å…·æœ‰å“ªäº›æ“ä½œæƒé™ã€‚</p>
<p>ä»¥ä¸‹é¢çš„ä¸€ä¸ªRoleè§’è‰²çš„èµ„æºæ¸…å•ä¸ºä¾‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiversion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-role</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">rules:</span>		<span class="comment"># è§„åˆ™é›†</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;apps&#x27;</span>]	<span class="comment"># å…·ä½“çš„èµ„æºç»„ï¼Œèµ„æºç»„ä¼šè‡ªåŠ¨å…³è”èµ„æºå¤§ç±»ï¼Œ&#x27;&#x27;ä»£è¡¨/apiä¸‹æ²¡æœ‰ç»†åˆ†èµ„æºç»„</span></span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&#x27;pods&#x27;</span>]		<span class="comment"># å…·ä½“çš„èµ„æºç±»å‹</span></span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&#x27;get&#x27;</span>,<span class="string">&#x27;watch&#x27;</span>,<span class="string">&#x27;list&#x27;</span>]	<span class="comment"># å…·ä½“çš„æ“ä½œï¼ŒæŸ¥è¯¢æ“ä½œ</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&#x27;apps&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&#x27;deployments&#x27;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&#x27;get&#x27;</span>,<span class="string">&#x27;watch&#x27;</span>,<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;create&#x27;</span>,<span class="string">&#x27;update&#x27;</span>,<span class="string">&#x27;patch&#x27;</span>,<span class="string">&#x27;delete&#x27;</span>]	<span class="comment"># å¢åˆ æ”¹æŸ¥</span></span><br></pre></td></tr></table></figure>

<h3 id="contextä¸Šä¸‹æ–‡"><a href="#contextä¸Šä¸‹æ–‡" class="headerlink" title="contextä¸Šä¸‹æ–‡"></a>contextä¸Šä¸‹æ–‡</h3><p>åŸºäºRBACæœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·å’ŒRoleç±»å‹çš„è§’è‰²ï¼Œç„¶åè¿›è¡Œç»‘å®šï¼Œè¯¥ç”¨æˆ·å°±å…·æœ‰äº†æŸä¸ªå‘½åç©ºé—´ä¸‹çš„ä¸€äº›æƒé™ï¼Œå¤§è‡´æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆåˆ›å»ºä¸€ä¸ªç§é’¥æ–‡ä»¶</span></span><br><span class="line">openssl genrsa -out dengjinjun.key 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç§é’¥æ–‡ä»¶åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ï¼Œdengjinjunè¡¨ç¤ºç”¨æˆ·ï¼Œdevopsè¡¨ç¤ºç»„</span></span><br><span class="line">openssl req -new -key dengjinjun.key -out dengjinjun.csr -subj <span class="string">&quot;/CN=dengjinjun/O=devops&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨k8sçš„caè¯ä¹¦æ¥ç­¾ç½²csræ–‡ä»¶ï¼Œå¾—åˆ°crtæ–‡ä»¶ã€‚k8sçš„caè¯ä¹¦ä¸€èˆ¬ä½äº/etc/kubernetes/pkiç›®å½•ä¸‹é¢</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> dengjinjun.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out dengjinjun.crt -days 500</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨è¯ä¹¦æ–‡ä»¶å’Œç§é’¥æ–‡ä»¶åœ¨é›†ç¾¤ä¸­ä¸ºç”¨æˆ·åˆ›å»ºå‡­è¯</span></span><br><span class="line">kubectl config set-credentials dengjinjun --client-certificate=./dengjinjun.crt --client-key=./dengjinjun.key --embed-certs=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºç”¨æˆ·åˆ›å»ºä¸Šä¸‹æ–‡contextï¼Œæ­¤æ—¶å¯ä»¥æŒ‡å®šå‘½åç©ºé—´ä¹Ÿå¯ä»¥ä¸æŒ‡å®š</span></span><br><span class="line">kubectl config set-context dengjinjun-context --cluster=kubernetes --namespace=<span class="built_in">test</span> --user=egon</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é›†ç¾¤ä¸­æœ‰å“ªäº›ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config get-context</span><br><span class="line">kubectl config view</span><br><span class="line"><span class="comment"># åˆ‡æ¢kubectlå‘½ä»¤ä½¿ç”¨çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config use-context dengjinjun-context</span><br><span class="line"><span class="comment"># æ­¤æ—¶ä½¿ç”¨å‘½ä»¤`kubectl get pod`æ“ä½œapiserverä¼šå‘ç°æ²¡æœ‰ä»»ä½•æƒé™</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªRoleç±»å‹çš„è§’è‰²ï¼Œç”Ÿæˆä¸€ä¸ªæ¨¡æ¿è‡ªå·±ä¿®æ”¹éœ€è¦çš„æƒé™</span></span><br><span class="line">kubectl create role devops-role --verbget,list,watch --resource=pods --dry-run=client -o yaml &gt; role-demo.yaml</span><br><span class="line"> </span><br><span class="line"><span class="comment"># ä½¿ç”¨rolebindingæ–¹å¼å°†ç”¨æˆ·ä¸è§’è‰²ç»‘å®šï¼Œç”Ÿæˆä¸€ä¸ªæ¨¡æ¿è‡ªå·±ä¿®æ”¹</span></span><br><span class="line">kubectl create rolebinding devops-rolebinding --role=devops-role --user=dengjinjun --dry-run=client -o yaml &gt; rolebinding-demo.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠŠä¸Šä¸‹æ–‡å¯¼å‡ºï¼Œå¯ä»¥ä¼ é€’ç»™åˆ«äººå»ä½¿ç”¨</span></span><br><span class="line">kubectl config view --minify --flatten --context=dengjinjun-context &gt; dengjinjun.yaml</span><br></pre></td></tr></table></figure>

<p>æ¸…ç†ä¸åˆ é™¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æŸä¸ªç”¨æˆ·çš„ä¸Šä¸‹æ–‡</span></span><br><span class="line">kubectl config delete-context dengjinjun-context</span><br><span class="line"><span class="comment"># åˆ é™¤ç”¨æˆ·</span></span><br><span class="line">kubectl config <span class="built_in">unset</span> users.dengjinjun</span><br></pre></td></tr></table></figure>



<p>æ‹“å±•ï¼š</p>
<p>kubectlå‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ¥æŸ¥æ‰¾ä¸Šä¸‹æ–‡</p>
<ol>
<li>å‘½ä»¤è¡Œä¸­æŒ‡å®š<code>kubectl --context=/path/to/your-kubeconfig.yaml get pods</code>ï¼Œå…·æœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ã€‚</li>
<li>ç¯å¢ƒå˜é‡æ¬¡ä¹‹ï¼š<code>export KUBECONFIG=/path/to/your-kubeconfig.yaml</code></li>
<li>å½“å‰ç”¨æˆ·çš„å®¶ç›®å½•ä¸‹çš„<code>.kube/config</code>æ–‡ä»¶</li>
</ol>
<h3 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h3><p>contextä¸Šä¸‹æ–‡æ˜¯ç»™äººä½¿ç”¨çš„ï¼Œkubernetesä¸­è¿˜æœ‰ä¸€ç§è´¦å·æ˜¯ç»™Podä½¿ç”¨çš„ï¼Œ<code>ServiceAccount</code> ï¼Œç®€ç§°<code>sa</code></p>
<p>saçš„æˆæƒæ–¹å¼è·Ÿä¸Šæ–‡ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒä¸éœ€è¦æ‰‹åŠ¨ç­¾å‘è¯ä¹¦ï¼Œæ‰€ä»¥å®ƒæ¯”åˆ›å»ºè´¦æˆ·è¦æ–¹ä¾¿çš„å¤š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼Œåˆ›å»ºsaè¿™é‡Œä¸€å®šè¦æŒ‡å®šå‘½åç©ºé—´ï¼Œå› ä¸ºPodæ˜¯å‘½åç©ºé—´ä¸‹çš„èµ„æºï¼Œè¯¥saè´¦å·ä¸€å®šè¦åœ¨è¯¥å‘½åç©ºé—´å­˜åœ¨</span></span><br><span class="line">kubectl create sa dengjinjun-sa -n <span class="built_in">test</span></span><br><span class="line"><span class="comment"># åé¢åˆ›å»ºroleæˆ–rolebindingä¸å†èµ˜è¿°</span></span><br></pre></td></tr></table></figure>

<p>ServiceAccountçš„åŒæ ·é‡‡ç”¨RBACçš„æˆæƒæœºåˆ¶ï¼Œä½†æ˜¯ä¸ç”Ÿæˆä¸Šä¸‹æ–‡ï¼Œå®ƒçš„ä½¿ç”¨æ–¹å¼æ˜¯åœ¨Podçš„templateæ¸…å•ä¸­æŒ‡å®š<code>.spec.serviceAccountName</code></p>
<p><code>ServiceAcount</code>æƒé™æµ‹è¯•ï¼š</p>
<ol>
<li><p>åœ¨Podå¤–é€šè¿‡kubectlå‘½ä»¤æ£€æµ‹saæƒé™ï¼Œæ ¹æ®è¿”å›å€¼æ˜¯yesæˆ–è€…noåˆ¤æ–­</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl auth can-i get pods --as=system:serviceaccount:&lt;namespace&gt;:&lt;serviceaccount-name&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨Podå†…é€šè¿‡curlå‘½ä»¤å¸¦tokenè®¿é—®apiserver</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tokenå€¼é€šè¿‡ä»¤ç‰Œå·æŠ•å½±æœºåˆ¶æŒ‚è½½åˆ°Podçš„/var/run/secrets/kubernetes.io/serviceaccountç›®å½•ä¸­ï¼Œå¯ä»¥å…ˆæŠŠtokenå€¼å£°æ˜æˆä¸€ä¸ªbian&#x27;l</span></span><br><span class="line">curl --header <span class="string">&quot;Authorization: Bearer <span class="variable">$TOKEN</span>&quot;</span> --insecure https://kubernetes.default.svc/api/v1/namespaces/default/pods</span><br></pre></td></tr></table></figure></li>
</ol>
</div><script src="https://jsd.cdn.zzko.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if("undefined"!=typeof lightGallery) {
        var options1 = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1);
        }</script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-01-03</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« é‚“èƒ–èƒ–</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/K8S/'>
                            K8S
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/'>
                            å­¦ä¹ ç¬”è®°
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
             

            
                

            
        </span>
    
</div>
<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>